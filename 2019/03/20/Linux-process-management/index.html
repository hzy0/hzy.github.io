<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>Linux内核进程管理基础 | JoyYoung&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="学习linux进程管理相关的基础知识">
<meta name="keywords" content="Linux,学习">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux内核进程管理基础">
<meta property="og:url" content="http://yoursite.com/2019/03/20/Linux-process-management/index.html">
<meta property="og:site_name" content="JoyYoung&#39;s blog">
<meta property="og:description" content="学习linux进程管理相关的基础知识">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2019/03/20/Linux-process-management/maps-items.PNG">
<meta property="og:image" content="http://yoursite.com/2019/03/20/Linux-process-management/kernel-stack.PNG">
<meta property="og:updated_time" content="2019-06-24T14:08:52.401Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux内核进程管理基础">
<meta name="twitter:description" content="学习linux进程管理相关的基础知识">
<meta name="twitter:image" content="http://yoursite.com/2019/03/20/Linux-process-management/maps-items.PNG">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JoyYoung&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Linux-process-management" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/20/Linux-process-management/" class="article-date">
  <time datetime="2019-03-20T15:00:00.000Z" itemprop="datePublished">2019-03-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Linux内核进程管理基础
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>进程是操作系统上非常重要的概念；进程管理是操作系统的职能之一，主要是对处理机进行管理；涉及的内容很多也很难；这里只是学习整理一些基础的东西。</p>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>进程是正在运行的程序实体，并且包括这个运行的程序中占据的所有系统资源，比如说CPU（寄存器），IO,内存，网络资源等；是具有一定独立功能的程序关于某个数据集合上的一次运行活动；是系统进行资源分配的一个最小独立单位。而线程是调度的基本单位，在linux中线程也是一个轻量级的进程。</p>
<p>Linux是抢占式的多任务系统。有自己的进程管理机制，主要包括两大部分：</p>
<ul>
<li>进程空间，对正在运行中的应用程序布局空间的抽象，管理和监视程序对内存、处理器时间和 I / O 资源的使用；</li>
<li>进程调度，以task_struct为对象进行调度和切换管理，有自己的调度策略和算法。</li>
</ul>
<h2 id="proc"><a href="#proc" class="headerlink" title="proc"></a>proc</h2><p>通过proc/pid/目录可以查到某个进程丰富的相关信息。以我们的项目为例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">dr-xr-xr-x  2 root root 0 2019-01-01 18:23 attr         --&gt;selinux相关信息</span><br><span class="line">-rw-r--r--  1 root root 0 2019-01-01 18:23 autogroup    --&gt;不祥</span><br><span class="line">-r--------  1 root root 0 2019-01-01 18:23              --&gt;包含传递给进程的ELF解释器信息</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 18:23 cgroup       --&gt;资源分组</span><br><span class="line">--w-------  1 root root 0 2019-01-01 18:23 clear_refs --&gt;CONFIG_PROC_PAGE_MONITOR</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 17:22 cmdline --&gt;启动进程的命令行，僵尸进程这个文件为空。</span><br><span class="line">-rw-r--r--  1 root root 0 2019-01-01 18:23 comm    --&gt;进程名，长度为TASK_COMM_LEN</span><br><span class="line">-rw-r--r--  1 root root 0 2019-01-01 18:23 coredump_filter --&gt;coredump过滤器,man core详细</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 18:23 cpuset  --&gt;cpu/io/memory等资源控制分组</span><br><span class="line">lrwxrwxrwx  1 root root 0 2019-01-01 18:23 cwd -&gt; / --&gt;工作目录</span><br><span class="line">-r--------  1 root root 0 2019-01-01 18:23 environ  --&gt;环境变量</span><br><span class="line">lrwxrwxrwx  1 root root 0 2019-01-01 18:23 exe --&gt; /init --&gt;启动进程的完整命令或bin内容</span><br><span class="line">dr-x------  2 root root 0 2019-01-01 18:23 fd --&gt;所有实际打开的文件</span><br><span class="line">dr-x------  2 root root 0 2019-01-01 18:23 fdinfo --&gt;对应fd的信息</span><br><span class="line">-r--------  1 root root 0 2019-01-01 18:23 io  --&gt;IO信息</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 18:23 limits --&gt;资源限制相关的配置信息</span><br><span class="line">dr-x------  2 root root 0 2019-01-01 18:23 map_files --&gt;内存映射文件（man mmap）</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 18:23 maps --&gt;内存映射信息</span><br><span class="line">-rw-------  1 root root 0 2019-01-01 18:23 mem  --&gt;用于通过open、read、lseek访问进程的内存页</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 18:23 mountinfo --&gt;挂载信息</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 18:23 mounts    --&gt;挂载列表</span><br><span class="line">-r--------  1 root root 0 2019-01-01 18:23 mountstats--&gt;挂载状态</span><br><span class="line">dr-xr-xr-x 10 root root 0 2019-01-01 18:23 net       --&gt;网络相关</span><br><span class="line">dr-x--x--x  2 root root 0 2019-01-01 18:23 ns  --&gt;名字空间的入口，详见（man namespaces）</span><br><span class="line">-rw-r--r--  1 root root 0 2019-01-01 18:23 oom_adj       --&gt;OOM或LMK相关</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 18:23 oom_score     --&gt;OOM或LMK相关</span><br><span class="line">-rw-r--r--  1 root root 0 2019-01-01 18:23 oom_score_adj --&gt;OOM或LMK相关</span><br><span class="line">-r--------  1 root root 0 2019-01-01 18:23 pagemap --&gt;虚拟内存页映射信息CONFIG_PROC_PAGE_MONITOR</span><br><span class="line">-r--------  1 root root 0 2019-01-01 18:23 personality --&gt;？</span><br><span class="line">--w-------  1 root root 0 2019-01-01 18:23 reclaim     --&gt;?</span><br><span class="line">lrwxrwxrwx  1 root root 0 2019-01-01 18:23 root -&gt; /   --&gt;进程的根目录</span><br><span class="line">-rw-r--r--  1 root root 0 2019-01-01 18:23 sched                --&gt;进程调度信息</span><br><span class="line">-rw-rw-rw-  1 root root 0 2019-01-01 18:23 sched_group_id       --&gt;进程调度信息</span><br><span class="line">-rw-r--r--  1 root root 0 2019-01-01 18:23 sched_init_task_load --&gt;进程调度信息</span><br><span class="line">-rw-r--r--  1 root root 0 2019-01-01 18:23 sched_wake_up_idle   --&gt;进程调度信息</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 18:23 schedstat            --&gt;进程调度信息</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 14:58 smaps --&gt;类似于pmap命令,类似maps</span><br><span class="line">-r--------  1 root root 0 2019-01-01 18:23 stack --&gt;进程的内核调用栈信息</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 14:24 stat  --&gt;进程状态信息，用于ps命令</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 18:23 statm --&gt;进程内存使用信息汇总</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 17:22 status --&gt;同stat，可读性更好</span><br><span class="line">-r--------  1 root root 0 2019-01-01 18:23 syscall --&gt;系统调用相关信息</span><br><span class="line">dr-xr-xr-x  3 root root 0 2019-01-01 18:23 task  --&gt;每个线程一个子目录</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 18:23 time_in_state --&gt;?</span><br><span class="line">-rw-rw-rw-  1 root root 0 2019-01-01 18:23 timerslack_ns --&gt;?</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-01 17:22 wchan --&gt;进程休眠时内核中相应函数</span><br></pre></td></tr></table></figure>

<h2 id="进程空间"><a href="#进程空间" class="headerlink" title="进程空间"></a>进程空间</h2><h4 id="kernel-config"><a href="#kernel-config" class="headerlink" title="kernel config"></a>kernel config</h4><p>进程空间主要是进程的内存空间管理。涉及到arm架构的东西，需要了解下arm的内存管理相关的知识。以我们arm64、Linux4.9的项目来看看起内存相关的宏控。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">kernel/msm-4.9/arch/arm64/Kconfig有以下定义：</span><br><span class="line">choice</span><br><span class="line">	prompt <span class="string">"Page size"</span></span><br><span class="line">	default ARM64_4K_PAGES</span><br><span class="line">	help</span><br><span class="line">	  Page size (translation granule) configuration.</span><br><span class="line"></span><br><span class="line">config ARM64_4K_PAGES</span><br><span class="line">	bool <span class="string">"4KB"</span></span><br><span class="line">	help</span><br><span class="line">	  This feature enables 4KB pages support.</span><br><span class="line">......</span><br><span class="line">choice</span><br><span class="line">	prompt <span class="string">"Virtual address space size"</span></span><br><span class="line">	default ARM64_VA_BITS_39 if ARM64_4K_PAGES</span><br><span class="line">	default ARM64_VA_BITS_47 if ARM64_16K_PAGES</span><br><span class="line">	default ARM64_VA_BITS_42 if ARM64_64K_PAGES</span><br><span class="line">	help</span><br><span class="line">	  Allows choosing one of multiple possible virtual address</span><br><span class="line">	  space sizes. The level of translation table is determined by</span><br><span class="line">	  a combination of page size and virtual address space size.</span><br><span class="line">......</span><br><span class="line">config ARM64_VA_BITS_39</span><br><span class="line">	bool <span class="string">"39-bit"</span></span><br><span class="line">	depends on ARM64_4K_PAGES</span><br><span class="line">......</span><br><span class="line">config ARM64_VA_BITS</span><br><span class="line">	int</span><br><span class="line">	default 36 if ARM64_VA_BITS_36</span><br><span class="line">	default 39 if ARM64_VA_BITS_39</span><br><span class="line">	default 42 if ARM64_VA_BITS_42</span><br><span class="line">	default 47 if ARM64_VA_BITS_47</span><br><span class="line">	default 48 if ARM64_VA_BITS_48</span><br><span class="line">......</span><br><span class="line">config PGTABLE_LEVELS</span><br><span class="line">	int</span><br><span class="line">	default 2 if ARM64_16K_PAGES &amp;&amp; ARM64_VA_BITS_36</span><br><span class="line">	default 2 if ARM64_64K_PAGES &amp;&amp; ARM64_VA_BITS_42</span><br><span class="line">	default 3 if ARM64_64K_PAGES &amp;&amp; ARM64_VA_BITS_48</span><br><span class="line">	default 3 if ARM64_4K_PAGES &amp;&amp; ARM64_VA_BITS_39</span><br><span class="line">	default 3 if ARM64_16K_PAGES &amp;&amp; ARM64_VA_BITS_47</span><br><span class="line">	default 4 if !ARM64_64K_PAGES &amp;&amp; ARM64_VA_BITS_48</span><br><span class="line"></span><br><span class="line">最终的.config文件</span><br><span class="line">CONFIG_ARM64_4K_PAGES=y</span><br><span class="line"><span class="comment"># CONFIG_ARM64_16K_PAGES is not set</span></span><br><span class="line"><span class="comment"># CONFIG_ARM64_64K_PAGES is not set</span></span><br><span class="line">CONFIG_ARM64_VA_BITS_39=y</span><br><span class="line"><span class="comment"># CONFIG_ARM64_VA_BITS_48 is not set</span></span><br><span class="line">CONFIG_ARM64_VA_BITS=39</span><br><span class="line">CONFIG_PGTABLE_LEVELS=3</span><br></pre></td></tr></table></figure>

<p>从上面的信息可以看到arm64应该支持36/39 /42/ 47/48地址宽度；支持4K/16K/64K页；支持2/3/4段式管理。</p>
<p>具体这个项目的配置是39bit地址线，4K页，3级映射。地址空间=2^39=512G；内核文档中关于内存虚拟地址的映射说明在kernel/msm-4.9/Documentation/arm64/memory.txt中，我们的配置对应如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AArch64 Linux memory layout with <span class="number">4</span>KB pages + <span class="number">3</span> levels:</span><br><span class="line">Start			End			Size		Use</span><br><span class="line">----------------------------------------------------------------------- </span><br><span class="line"><span class="number">0000000000000000</span>	<span class="number">0000007f</span>ffffffff	 <span class="number">512</span>GB		user </span><br><span class="line">ffffff8000000000	ffffffffffffffff	 <span class="number">512</span>GB		kernel</span><br></pre></td></tr></table></figure>

<h4 id="elf"><a href="#elf" class="headerlink" title="elf"></a>elf</h4><p>ELF全称Executable and Linkable Format,可执行连接格式，ELF格式的文件用于存储Linux程序。四种不同的类型:  </p>
<ul>
<li>可重定位文件(Relocatable): 编译器和汇编器产生的.o文件，需要被Linker进一步处理。</li>
<li>可执行文件(Executable): Have all relocation done and all symbol resolved except perhaps shared library symbols that must be resolved at run time。</li>
<li>共享对象文件(Shared Object): 即动态库文件(.so) 。</li>
<li>核心转储文件(Core File)。</li>
</ul>
<p>这里涉及的东西也是很多的，我们通过android的init进程的bin文件简单的了解一下。readelf命令提供了高可读性的输出。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">huangzaiyang@hz-ubuntu-196:~/WorkSpace/P400$ prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/aarch64-linux-android-readelf -a out/target/product/msm8937_64/root/init</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2's complement, little endian</span><br><span class="line">  Version:                           1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI Version:                       0</span><br><span class="line">  Type:                              EXEC (Executable file)</span><br><span class="line">  Machine:                           AArch64</span><br><span class="line">  Version:                           0x1</span><br><span class="line">  Entry point address:               0x4035a4</span><br><span class="line">  Start of program headers:          64 (bytes into file)</span><br><span class="line">  Start of section headers:          2209176 (bytes into file)</span><br><span class="line">  Flags:                             0x0</span><br><span class="line">  Size of this header:               64 (bytes)</span><br><span class="line">  Size of program headers:           56 (bytes)</span><br><span class="line">  Number of program headers:         5</span><br><span class="line">  Size of section headers:           64 (bytes)</span><br><span class="line">  Number of section headers:         18</span><br><span class="line">  Section header string table index: 17</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .note.android.ide NOTE             0000000000400158  00000158</span><br><span class="line">       0000000000000018  0000000000000000   A       0     0     4</span><br><span class="line">  [ 2] .note.gnu.build-i NOTE             0000000000400170  00000170</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     4</span><br><span class="line">  [ 3] .text             PROGBITS         00000000004001c0  000001c0</span><br><span class="line">       00000000001adb40  0000000000000000  AX       0     0     64</span><br><span class="line">  [ 4] .rodata           PROGBITS         00000000005add00  001add00</span><br><span class="line">       0000000000027910  0000000000000000   A       0     0     64</span><br><span class="line">  [ 5] .gcc_except_table PROGBITS         00000000005d5610  001d5610</span><br><span class="line">       000000000000b074  0000000000000000   A       0     0     4</span><br><span class="line">  [ 6] .eh_frame         PROGBITS         00000000005e0688  001e0688</span><br><span class="line">       000000000001d7a0  0000000000000000   A       0     0     8</span><br><span class="line">  [ 7] .preinit_array    PREINIT_ARRAY    0000000000614fa0  00204fa0</span><br><span class="line">       0000000000000010  0000000000000008  WA       0     0     8</span><br><span class="line">  [ 8] .init_array       INIT_ARRAY       0000000000614fb0  00204fb0</span><br><span class="line">       00000000000000b0  0000000000000008  WA       0     0     8</span><br><span class="line">  [ 9] .fini_array       FINI_ARRAY       0000000000615060  00205060</span><br><span class="line">       0000000000000030  0000000000000008  WA       0     0     8</span><br><span class="line">  [10] .data.rel.ro      PROGBITS         0000000000615090  00205090</span><br><span class="line">       000000000000a2e0  0000000000000000  WA       0     0     16</span><br><span class="line">  [11] .got              PROGBITS         000000000061f370  0020f370</span><br><span class="line">       0000000000000c78  0000000000000000  WA       0     0     8</span><br><span class="line">  [12] .got.plt          PROGBITS         000000000061ffe8  0020ffe8</span><br><span class="line">       0000000000000018  0000000000000000  WA       0     0     8</span><br><span class="line">  [13] .data             PROGBITS         0000000000620000  00210000</span><br><span class="line">       0000000000000f50  0000000000000000  WA       0     0     32</span><br><span class="line">  [14] .bss              NOBITS           0000000000621000  00210f50</span><br><span class="line">       00000000000089dc  0000000000000000  WA       0     0     4096</span><br><span class="line">  [15] .note.gnu.gold-ve NOTE             0000000000000000  00210f50</span><br><span class="line">       000000000000001c  0000000000000000           0     0     4</span><br><span class="line">  [16] .gnu_debugdata    PROGBITS         0000000000000000  00210f6c</span><br><span class="line">       000000000000a55c  0000000000000000           0     0     1</span><br><span class="line">  [17] .shstrtab         STRTAB           0000000000000000  0021b4c8</span><br><span class="line">       00000000000000cf  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  p (processor specific)</span><br><span class="line"></span><br><span class="line">There are no section groups in this file.</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset             VirtAddr           PhysAddr</span><br><span class="line">                 FileSiz            MemSiz              Flags  Align</span><br><span class="line">  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000</span><br><span class="line">                 0x00000000001fde28 0x00000000001fde28  R E    10000</span><br><span class="line">  LOAD           0x0000000000204fa0 0x0000000000614fa0 0x0000000000614fa0</span><br><span class="line">                 0x000000000000bfb0 0x0000000000014a3c  RW     10000</span><br><span class="line">  NOTE           0x0000000000000158 0x0000000000400158 0x0000000000400158</span><br><span class="line">                 0x0000000000000038 0x0000000000000038  R      4</span><br><span class="line">  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">                 0x0000000000000000 0x0000000000000000  RW     10</span><br><span class="line">  GNU_RELRO      0x0000000000204fa0 0x0000000000614fa0 0x0000000000614fa0</span><br><span class="line">                 0x000000000000b060 0x000000000000b060  RW     10</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     .note.android.ident .note.gnu.build-id .text .rodata .gcc_except_table .eh_frame </span><br><span class="line">   01     .preinit_array .init_array .fini_array .data.rel.ro .got .got.plt .data .bss </span><br><span class="line">   02     .note.android.ident .note.gnu.build-id </span><br><span class="line">   03     </span><br><span class="line">   04     .preinit_array .init_array .fini_array .data.rel.ro .got .got.plt </span><br><span class="line"></span><br><span class="line">There is no dynamic section in this file.</span><br><span class="line"></span><br><span class="line">There are no relocations in this file.</span><br><span class="line"></span><br><span class="line">The decoding of unwind sections for machine type AArch64 is not currently supported.</span><br><span class="line"></span><br><span class="line">No version information found in this file.</span><br><span class="line"></span><br><span class="line">Displaying notes found at file offset 0x00000158 with length 0x00000018:</span><br><span class="line">  Owner                 Data size	Description</span><br><span class="line">  Android              0x00000004	NT_VERSION (version)</span><br><span class="line"></span><br><span class="line">Displaying notes found at file offset 0x00000170 with length 0x00000020:</span><br><span class="line">  Owner                 Data size	Description</span><br><span class="line">  GNU                  0x00000010	NT_GNU_BUILD_ID (unique build ID bitstring)</span><br><span class="line">    Build ID: e60cec3f190f909970dcc0f2ba7257dd</span><br><span class="line"></span><br><span class="line">Displaying notes found at file offset 0x00210f50 with length 0x0000001c:</span><br><span class="line">  Owner                 Data size	Description</span><br><span class="line">  GNU                  0x00000009	NT_GNU_GOLD_VERSION (gold version)</span><br><span class="line">    Version: gold 1.12</span><br></pre></td></tr></table></figure>

<h4 id="maps"><a href="#maps" class="headerlink" title="maps"></a>maps</h4><p>proc/pid/maps显示进程映射了的内存区域和访问权限。对应内核中的操作集为proc_pid_maps_op，具体细节的导出函数为show_map。在task_mmu.c能找到其实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> <span class="title">proc_pid_maps_op</span> = &#123;</span></span><br><span class="line">	.start	= m_start,</span><br><span class="line">	.next	= m_next,</span><br><span class="line">	.stop	= m_stop,</span><br><span class="line">	.show	= show_pid_map</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>内核中进程的一段地址空间用一个vm_area_struct结构体表示，所有地址空间存储在task-&gt;mm-&gt;mmap链表中。一个文件可以映射到进程的一段内存区域中，映射的文件描述符保存在vm_area_struct-&gt;vm_file域中，这种内存区域叫做有名内存区域，相反，属于匿名映射内存区域。</p>
<p>maps的每行对应到内核的vm_area_struct结构上，每列对应到vm_area_struct的某些成员上内容关系如下：<img src="/2019/03/20/Linux-process-management/maps-items.PNG" alt="对应关系"></p>
<p>通过pmap pid 、cat proc/pid/maps或者cat proc/pid/smaps可以查看某个进程的空间布局映射情况。以init进程为例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">TB-X505X:/proc/1 # cat maps</span><br><span class="line">00400000-005ff000 r-xp 00000000 fd:00 27                                 /init</span><br><span class="line">00614000-00620000 r--p 00204000 fd:00 27                                 /init</span><br><span class="line">00620000-00621000 rw-p 00210000 fd:00 27                                 /init</span><br><span class="line">00621000-00625000 rw-p 00000000 00:00 0</span><br><span class="line">00625000-00626000 r--p 00000000 00:00 0</span><br><span class="line">00626000-0062a000 rw-p 00000000 00:00 0</span><br><span class="line">7f82400000-7f82600000 rw-p 00000000 00:00 0                              [anon:libc_malloc]</span><br><span class="line">7f82720000-7f82740000 rw-s 00000000 00:0f 11053                          /dev/__properties__/properties_serial</span><br><span class="line">7f82740000-7f82760000 rw-s 00000000 00:0f 11052                          /dev/__properties__/u:object_r:wigig_prop:s0</span><br><span class="line">7f82760000-7f82780000 rw-s 00000000 00:0f 11051                          /dev/__properties__/u:object_r:wifi_prop:s0</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.                        </span><br><span class="line">7f83d40000-7f83d60000 rw-s 00000000 00:0f 10876                          /dev/__properties__/u:object_r:bluetooth_prop:s0</span><br><span class="line">7f83d60000-7f83d80000 rw-s 00000000 00:0f 10875                          /dev/__properties__/u:object_r:bluetooth_a2dp_offload_prop:s0</span><br><span class="line">7f83d80000-7f83da0000 rw-s 00000000 00:0f 10874                          /dev/__properties__/u:object_r:bg_daemon_prop:s0</span><br><span class="line">7f83da0000-7f83dc0000 rw-s 00000000 00:0f 10873                          /dev/__properties__/u:object_r:bg_boot_complete_prop:s0</span><br><span class="line">7f83dc0000-7f83de0000 rw-s 00000000 00:0f 10872                          /dev/__properties__/u:object_r:audio_prop:s0</span><br><span class="line">7f83de0000-7f83e00000 rw-s 00000000 00:0f 10871                          /dev/__properties__/u:object_r:adsprpc_prop:s0</span><br><span class="line">7f83e00000-7f84200000 rw-p 00000000 00:00 0                              [anon:libc_malloc]</span><br><span class="line">7f8420f000-7f84210000 r--s 00000000 fd:01 2238                           /vendor/etc/passwd</span><br><span class="line">7f84210000-7f8421b000 r--s 00000000 00:0f 10870                          /dev/__properties__/property_info</span><br><span class="line">7f8421b000-7f8421d000 rw-p 00000000 00:00 0                              [anon:System property context nodes]</span><br><span class="line">7f8421d000-7f84228000 r--s 00000000 00:0f 10870                          /dev/__properties__/property_info</span><br><span class="line">7f84228000-7f84229000 r--p 00000000 00:00 0                              [anon:atexit handlers]</span><br><span class="line">7f84229000-7f8422a000 ---p 00000000 00:00 0                              [anon:thread signal stack guard]</span><br><span class="line">7f8422a000-7f8422e000 rw-p 00000000 00:00 0                              [anon:thread signal stack]</span><br><span class="line">7f8422e000-7f8422f000 rw-p 00000000 00:00 0                              [anon:arc4random data]</span><br><span class="line">7f8422f000-7f84230000 ---p 00000000 00:00 0                              [anon:bionic TLS guard]</span><br><span class="line">7f84230000-7f84233000 rw-p 00000000 00:00 0                              [anon:bionic TLS]</span><br><span class="line">7f84233000-7f84234000 ---p 00000000 00:00 0                              [anon:bionic TLS guard]</span><br><span class="line">7f84234000-7f84235000 r--p 00000000 00:00 0                              [vvar]</span><br><span class="line">7f84235000-7f84236000 r-xp 00000000 00:00 0                              [vdso]</span><br><span class="line">7fc866e000-7fc868f000 rw-p 00000000 00:00 0                              [stack]</span><br></pre></td></tr></table></figure>

<h5 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h5><p>Linux系统上，每个进程会有两个栈；一个用户栈，存在于用户空间；一个内核栈，存在于内核空间。进程在用户态使用用户空间的栈；在内核态使用内核空间的栈。</p>
<h6 id="用户栈"><a href="#用户栈" class="headerlink" title="用户栈"></a>用户栈</h6><p>上面的maps中的栈空间指的是用户空间的栈；保存进程函数调用的栈帧内容，占据用户空间的最高8188K的地址；通过ulimit -s也可以查看进程栈空间的大小限制，不过cat limits可以看到进程更多资源的限制情况，可以看到栈的限制的8M。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">TB-XXXXXX:/proc/1 # cat limits</span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units</span><br><span class="line">Max cpu time              unlimited            unlimited            seconds</span><br><span class="line">Max file size             unlimited            unlimited            bytes</span><br><span class="line">Max data size             unlimited            unlimited            bytes</span><br><span class="line">Max stack size            8388608              unlimited            bytes</span><br><span class="line">Max core file size        0                    unlimited            bytes</span><br><span class="line">Max resident set          unlimited            unlimited            bytes</span><br><span class="line">Max processes             7128                 7128                 processes</span><br><span class="line">Max open files            32768                32768                files</span><br><span class="line">Max locked memory         67108864             67108864             bytes</span><br><span class="line">Max address space         unlimited            unlimited            bytes</span><br><span class="line">Max file locks            unlimited            unlimited            locks</span><br><span class="line">Max pending signals       7128                 7128                 signals</span><br><span class="line">Max msgqueue size         819200               819200               bytes</span><br><span class="line">Max nice priority         40                   40</span><br><span class="line">Max realtime priority     0                    0</span><br><span class="line">Max realtime timeout      unlimited            unlimited            us</span><br></pre></td></tr></table></figure>

<p>在内核中的初始配置应该是在resource.h中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_RLIMITS							\</span></span><br><span class="line">&#123;									\</span><br><span class="line">	[RLIMIT_CPU]		= &#123;  RLIM_INFINITY,  RLIM_INFINITY &#125;,	\</span><br><span class="line">	[RLIMIT_FSIZE]		= &#123;  RLIM_INFINITY,  RLIM_INFINITY &#125;,	\</span><br><span class="line">	[RLIMIT_DATA]		= &#123;  RLIM_INFINITY,  RLIM_INFINITY &#125;,	\</span><br><span class="line">	[RLIMIT_STACK]		= &#123;       _STK_LIM,  RLIM_INFINITY &#125;,	\</span><br><span class="line">	[RLIMIT_CORE]		= &#123;              <span class="number">0</span>,  RLIM_INFINITY &#125;,	\</span><br><span class="line">	[RLIMIT_RSS]		= &#123;  RLIM_INFINITY,  RLIM_INFINITY &#125;,	\</span><br><span class="line">	[RLIMIT_NPROC]		= &#123;              <span class="number">0</span>,              <span class="number">0</span> &#125;,	\</span><br><span class="line">	[RLIMIT_NOFILE]		= &#123;   INR_OPEN_CUR,   INR_OPEN_MAX &#125;,	\</span><br><span class="line">	[RLIMIT_MEMLOCK]	= &#123;    MLOCK_LIMIT,    MLOCK_LIMIT &#125;,	\</span><br><span class="line">	[RLIMIT_AS]		= &#123;  RLIM_INFINITY,  RLIM_INFINITY &#125;,	\</span><br><span class="line">	[RLIMIT_LOCKS]		= &#123;  RLIM_INFINITY,  RLIM_INFINITY &#125;,	\</span><br><span class="line">	[RLIMIT_SIGPENDING]	= &#123; 		<span class="number">0</span>,	       <span class="number">0</span> &#125;,	\</span><br><span class="line">	[RLIMIT_MSGQUEUE]	= &#123;   MQ_BYTES_MAX,   MQ_BYTES_MAX &#125;,	\</span><br><span class="line">	[RLIMIT_NICE]		= &#123; <span class="number">0</span>, <span class="number">0</span> &#125;,				\</span><br><span class="line">	[RLIMIT_RTPRIO]		= &#123; <span class="number">0</span>, <span class="number">0</span> &#125;,				\</span><br><span class="line">	[RLIMIT_RTTIME]		= &#123;  RLIM_INFINITY,  RLIM_INFINITY &#125;,	\</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="内核栈"><a href="#内核栈" class="headerlink" title="内核栈"></a>内核栈</h6><p>对于进程在内核空间的栈，很多细节还是要看具体项目的内核配置，配置不同内核栈的大小和布局就略有不用。比如，thread_info是否放在栈顶会受到内核宏CONFIG_THREAD_INFO_IN_TASK定义与否影响。我们手上的项目这个宏是开启的，以这个为例子来理解一下内核栈。</p>
<p>1、栈和thread_info的关系</p>
<p>在kernel/msm-4.9/include/linux/sched.h中可以看到thread_union联合体和task_struct结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> thread_union &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_THREAD_INFO_IN_TASK</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span> <span class="title">thread_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">stack</span>[THREAD_SIZE/<span class="keyword">sizeof</span>(<span class="keyword">long</span>)];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_THREAD_INFO_IN_TASK</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For reasons of header soup (see current_thread_info()), this</span></span><br><span class="line"><span class="comment">	 * must be the first element of task_struct.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span> <span class="title">thread_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而arm64的struct thread_info定义在kernel/msm-4.9/arch/arm64/include/asm/thread_info.h中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * low level task data that entry.S needs immediate access to.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		flags;		<span class="comment">/* low level flags */</span></span><br><span class="line">	<span class="keyword">mm_segment_t</span>		addr_limit;	<span class="comment">/* address limit */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ARM64_SW_TTBR0_PAN</span></span><br><span class="line">	u64			ttbr0;		<span class="comment">/* saved TTBR0_EL1 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span>			preempt_count;	<span class="comment">/* 0 =&gt; preemptable, &lt;0 =&gt; bug */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>从以上的相关定义中，我们基本上可以看出开启了CONFIG_THREAD_INFO_IN_TASK这个内核宏之后thread_info将不会放在栈顶的位置（栈空间的最低地址）了，而被包含在task_struct结构体中，并且在其开头的位置，两者的起始地址相同。所以对于获取当前线程信息宏current_thread_info()的实现方式上也是不一样了，可以看看其在kernel/msm-4.9/include/linux/thread_info.h中的定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_THREAD_INFO_IN_TASK</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * For CONFIG_THREAD_INFO_IN_TASK kernels we need &lt;asm/current.h&gt; for the</span></span><br><span class="line"><span class="comment"> * definition of current, but for !CONFIG_THREAD_INFO_IN_TASK kernels,</span></span><br><span class="line"><span class="comment"> * including &lt;asm/current.h&gt; can cause a circular dependency on some platforms.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/current.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> current_thread_info() ((struct thread_info *)current)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>current则定义在kernel/msm-4.9/arch/arm64/include/asm/current.h中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We don't use read_sysreg() as we want the compiler to cache the value where</span></span><br><span class="line"><span class="comment"> * possible.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> __<span class="function">always_inline struct task_struct *<span class="title">get_current</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> sp_el0;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">asm</span> (<span class="string">"mrs %0, sp_el0"</span> : <span class="string">"=r"</span> (sp_el0));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (struct task_struct *)sp_el0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> current get_current()</span></span><br></pre></td></tr></table></figure>

<p>可以看到thread_info或者说task_struct就被保存在sp_el0寄存器中（即用户态的sp寄存器），通过他就可以直接找到current。在arm64平台上内核开发者利用了硬件的新特性，用户态进入内核态时，寄存器会被保存在pt_regs数组中（存放在内核栈底部，高地址），用户态的sp指针暂时不会使用，所以利用他来存放当前task_struct的地址。这使得内核不再需要用thread_info来找到当前task_struct。 </p>
<p>2、栈的溢出魔数</p>
<p>为了检测栈溢出问题，内核会在栈顶的位置放置一个魔数，STACK_END_MAGIC=0x57AC6E9D</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_task_stack_end_magic</span><span class="params">(struct task_struct *tsk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *stackend;</span><br><span class="line"></span><br><span class="line">	stackend = end_of_stack(tsk);</span><br><span class="line">	*stackend = STACK_END_MAGIC;	<span class="comment">/* for overflow detection */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以我手上抓取的一个init进程的栈空间内容为例，task-&gt;stack指向的栈顶位置就存放着这个魔数。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ffffffc079370000:  0000000057ac6e9d 0000000000000000   .n.W............</span><br><span class="line">ffffffc079370010:  0000000000000000 0000000000000000   ................</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">ffffffc079373ec0:  0000000000000005 0000007fe1f98db0   ................</span><br><span class="line">ffffffc079373ed0:  0000000000000001 00000000ffffffff   ................</span><br><span class="line">ffffffc079373ee0:  0000000000000000 0000000000000008   ................</span><br><span class="line">ffffffc079373ef0:  0000000000000000 7f7f7f7f7f7f7f7f   ................</span><br><span class="line">ffffffc079373f00:  0000000000000016 0000000000000004   ................</span><br><span class="line">ffffffc079373f10:  000000000044544c 0000000000617f30   LTD.....0.a.....</span><br><span class="line">ffffffc079373f20:  656c706d6f635f74 0000000000000014   t_comple........</span><br><span class="line">ffffffc079373f30:  ffffffffffff0000 ffffffffffffffff   ................</span><br><span class="line">ffffffc079373f40:  000000008000002f 000000000ccccccc   /...............</span><br><span class="line">ffffffc079373f50:  0000000000000010 0000000000621000   ..........b.....</span><br><span class="line">ffffffc079373f60:  000000000062114c 0000000000621000   L.b.......b.....</span><br><span class="line">ffffffc079373f70:  00000000006212f0 0000000000000000   ..b.............</span><br><span class="line">ffffffc079373f80:  000000012a05f200 00000000ffffffff   ...*............</span><br><span class="line">ffffffc079373f90:  0000007f88c5b800 0000000000621000   ..........b.....</span><br><span class="line">ffffffc079373fa0:  0000000000620000 0000007fe1f98e40   ..b.....@.......</span><br><span class="line">ffffffc079373fb0:  0000000000406c84 0000007fe1f98b90   .l@.............</span><br><span class="line">ffffffc079373fc0:  000000000055514c 0000000060000000   LQU........`....</span><br><span class="line">ffffffc079373fd0:  0000000000000005 0000000000000016   ................</span><br><span class="line">ffffffc079373fe0:  0000000000000000 0000000000000000   ................</span><br><span class="line">ffffffc079373ff0:  0000000000000000 0000000000000000   ................</span><br><span class="line">ffffffc079374000:  ffffff0000000001 dead4ead00000000   .............N..</span><br></pre></td></tr></table></figure>

<p>3、栈帧的保护</p>
<p>为了检测栈帧的踩踏问题，内核会在栈帧与栈帧之间放入一个随机数，当前栈帧退栈是会检测该随机数是否被篡改；这个也是跟GCC编译相关的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CC_STACKPROTECTOR</span></span><br><span class="line">	tsk-&gt;stack_canary = get_random_long();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>4、核栈的大小</p>
<p>你看看kernel/msm-4.9/arch/arm64/include/asm/memory.h中的定义，我们只考虑没有开启KASAN的情况。而影响栈大小的另一个宏就是页大小宏，以我们项目的CONFIG_ARM64_PAGE_SHIFT=12（4K页）为例。可以看出内核栈的大小为16K。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * KASAN requires 1/8th of the kernel virtual address space for the shadow</span></span><br><span class="line"><span class="comment"> * region. KASAN can bloat the stack significantly, so double the (minimum)</span></span><br><span class="line"><span class="comment"> * stack size when KASAN is in use.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KASAN_SHADOW_SIZE	(UL(1) &lt;&lt; (VA_BITS - 3))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KASAN_THREAD_SHIFT	1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KASAN_SHADOW_SIZE	(0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KASAN_THREAD_SHIFT	0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//不开启KASAN的情况下THREAD_SHIFT = 14</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THREAD_SHIFT	(14 + KASAN_THREAD_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//THREAD_SIZE_ORDER = 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> THREAD_SHIFT &gt;= PAGE_SHIFT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THREAD_SIZE_ORDER	(THREAD_SHIFT - PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//THREAD_SIZE = 16K</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THREAD_SIZE		(UL(1) &lt;&lt; THREAD_SHIFT)</span></span><br></pre></td></tr></table></figure>

<p>5、栈和pt_regs的关系</p>
<p>以arm64为例，pt_regs定义在kernel/arch/arm64/include/asm/ptrace.h中，利用crash工具可以很方便的计算出pt_regs结构体的大小为0x130。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This struct defines the way the registers are stored on the stack during an</span></span><br><span class="line"><span class="comment"> * exception. Note that sizeof(struct pt_regs) has to be a multiple of 16 (for</span></span><br><span class="line"><span class="comment"> * stack alignment). struct user_pt_regs must form a prefix of struct pt_regs.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">user_pt_regs</span> <span class="title">user_regs</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			u64 regs[<span class="number">31</span>];</span><br><span class="line">			u64 sp;</span><br><span class="line">			u64 pc;</span><br><span class="line">			u64 pstate;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">	u64 orig_x0;</span><br><span class="line">	u64 syscallno;</span><br><span class="line">	u64 orig_addr_limit;</span><br><span class="line">	u64 unused;	<span class="comment">// maintain 16 byte alignment</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在kernel/arch/arm64/include/asm/processor.h中可以看到获取进程pt_regs的方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> task_pt_regs(p) \</span></span><br><span class="line">	((struct pt_regs *)(THREAD_START_SP + task_stack_page(p)) - <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>THREAD_START_SP宏定义在kernel/arch/arm64/include/asm/thread_info.h中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THREAD_START_SP		(THREAD_SIZE - 16) <span class="comment">//栈顶预留16Byte</span></span></span><br></pre></td></tr></table></figure>

<p>所以获取pt_regs的方法转化成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((struct pt_regs *)(THREAD_SIZE - 16 + p-&gt;stack) - 1)</span><br></pre></td></tr></table></figure>

<p>以init进程的一个例子代入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">((struct pt_regs *)(<span class="number">16</span>K - <span class="number">16</span> + <span class="number">0xffffffc079370000</span>) - <span class="number">1</span>)</span><br><span class="line">=</span><br><span class="line">((struct pt_regs *)(<span class="number">0x4000</span> - <span class="number">0x10</span> + <span class="number">0xffffffc079370000</span>) - <span class="number">1</span>)</span><br><span class="line">=</span><br><span class="line">((struct pt_regs *)(<span class="number">0x3ff0</span> + <span class="number">0xffffffc079370000</span>) - <span class="number">1</span>)</span><br><span class="line">=</span><br><span class="line">((struct pt_regs *)(<span class="number">0xffffffc079373ff0</span>) - <span class="number">1</span>)  <span class="comment">//指针减1</span></span><br><span class="line">=</span><br><span class="line">((struct pt_regs *)(<span class="number">0xffffffc079373ff0</span>) - <span class="number">0x130</span>)  <span class="comment">//要减去一个pt_regs的大小</span></span><br><span class="line">=</span><br><span class="line">(struct pt_regs *)ffffffc079373ec0</span><br></pre></td></tr></table></figure>

<p>看看init例子的栈中的pt_regs信息和现场的内容；可以看到现场信息是结合栈跟pt_regs来获取的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">crash&gt;</span> struct -x pt_regs ffffffc079373ec0</span><br><span class="line">struct pt_regs &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    user_regs = &#123;</span><br><span class="line">      regs = &#123;0x5, 0x7fe1f98db0, 0x1, 0xffffffff, 0x0, 0x8, 0x0, 0x7f7f7f7f7f7f7f7f, 0x16, 0x4, 0x44544c, 0x617f30, 0x656c706d6f635f74, 0x14, 0xffffffffffff0000, 0xffffffffffffffff, 0x8000002f, 0xccccccc, 0x10, 0x621000, 0x62114c, 0x621000, 0x6212f0, 0x0, 0x12a05f200, 0xffffffff, 0x7f88c5b800, 0x621000, 0x620000, 0x7fe1f98e40, 0x406c84&#125;, </span><br><span class="line">      sp = 0x7fe1f98b90, </span><br><span class="line">      pc = 0x55514c, </span><br><span class="line">      pstate = 0x60000000</span><br><span class="line">    &#125;, </span><br><span class="line">    &#123;</span><br><span class="line">      regs = &#123;0x5, 0x7fe1f98db0, 0x1, 0xffffffff, 0x0, 0x8, 0x0, 0x7f7f7f7f7f7f7f7f, 0x16, 0x4, 0x44544c, 0x617f30, 0x656c706d6f635f74, 0x14, 0xffffffffffff0000, 0xffffffffffffffff, 0x8000002f, 0xccccccc, 0x10, 0x621000, 0x62114c, 0x621000, 0x6212f0, 0x0, 0x12a05f200, 0xffffffff, 0x7f88c5b800, 0x621000, 0x620000, 0x7fe1f98e40, 0x406c84&#125;, </span><br><span class="line">      sp = 0x7fe1f98b90, </span><br><span class="line">      pc = 0x55514c, </span><br><span class="line">      pstate = 0x60000000</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  orig_x0 = 0x5, </span><br><span class="line">  syscallno = 0x16, </span><br><span class="line">  orig_addr_limit = 0x0, </span><br><span class="line">  unused = 0x0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">crash&gt;</span> bt 1</span><br><span class="line">PID: 1      TASK: ffffffc079368000  CPU: 0   COMMAND: "init"</span><br><span class="line"><span class="meta"> #</span>0 [ffffffc079373bd0] __switch_to at ffffff80c0886eb0</span><br><span class="line"><span class="meta"> #</span>1 [ffffffc079373bf0] __schedule at ffffff80c187dbec</span><br><span class="line"><span class="meta"> #</span>2 [ffffffc079373c70] schedule at ffffff80c187e4fc</span><br><span class="line"><span class="meta"> #</span>3 [ffffffc079373c90] schedule_hrtimeout_range_clock at ffffff80c18833b4</span><br><span class="line"><span class="meta"> #</span>4 [ffffffc079373d30] schedule_hrtimeout_range at ffffff80c18833f4</span><br><span class="line"><span class="meta"> #</span>5 [ffffffc079373d60] sys_epoll_wait at ffffff80c0ab96ec</span><br><span class="line"><span class="meta"> #</span>6 [ffffffc079373e40] sys_epoll_pwait at ffffff80c0ab9924</span><br><span class="line"><span class="meta"> #</span>7 [ffffffc079373ec0] el0_svc_naked at ffffff80c088437c</span><br><span class="line">     PC: 000000000055514c   LR: 0000000000406c84   SP: 0000007fe1f98b90</span><br><span class="line">    X29: 0000007fe1f98e40  X28: 0000000000620000  X27: 0000000000621000</span><br><span class="line">    X26: 0000007f88c5b800  X25: 00000000ffffffff  X24: 000000012a05f200</span><br><span class="line">    X23: 0000000000000000  X22: 00000000006212f0  X21: 0000000000621000</span><br><span class="line">    X20: 000000000062114c  X19: 0000000000621000  X18: 0000000000000010</span><br><span class="line">    X17: 000000000ccccccc  X16: 000000008000002f  X15: ffffffffffffffff</span><br><span class="line">    X14: ffffffffffff0000  X13: 0000000000000014  X12: 656c706d6f635f74</span><br><span class="line">    X11: 0000000000617f30  X10: 000000000044544c   X9: 0000000000000004</span><br><span class="line">     X8: 0000000000000016   X7: 7f7f7f7f7f7f7f7f   X6: 0000000000000000</span><br><span class="line">     X5: 0000000000000008   X4: 0000000000000000   X3: 00000000ffffffff</span><br><span class="line">     X2: 0000000000000001   X1: 0000007fe1f98db0   X0: 0000000000000005</span><br><span class="line">    ORIG_X0: 0000000000000005  SYSCALLNO: 16  PSTATE: 60000000</span><br></pre></td></tr></table></figure>

<p>6、栈的整体布局</p>
<p><img src="/2019/03/20/Linux-process-management/kernel-stack.PNG" alt="内核栈布局"></p>
<h5 id="heap"><a href="#heap" class="headerlink" title="heap"></a>heap</h5><p>进程动态分配的内存。用户空间跟malloc相关；内核空间上分配的堆内存一般使用kmallc和vmalloc。kmalloc保证分配的内存在物理上是连续的,内存只有在要被DMA访问的时候才需要物理上连续，malloc和vmalloc保证的是在虚拟地址空间上的连续。</p>
<h2 id="进程调度"><a href="#进程调度" class="headerlink" title="进程调度"></a>进程调度</h2><h4 id="PCB"><a href="#PCB" class="headerlink" title="PCB"></a>PCB</h4><p>Linux的进程管理基本上都是围绕着进程控制块展开的，内核对进程控制块的抽象就是task_struct结构体。定义在kernel/msm-4.9/include/linux/sched.h中；这个结构体非常庞大，很难完全摸透彻！只能通过对这个结构体的一些常用的成员来进行学习！</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_THREAD_INFO_IN_TASK</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For reasons of header soup (see current_thread_info()), this</span></span><br><span class="line"><span class="comment">	 * must be the first element of task_struct.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span> <span class="title">thread_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">long</span> state;	<span class="comment">/* -1 unrunnable, 0 runnable, &gt;0 stopped */</span></span><br><span class="line">	<span class="keyword">void</span> *<span class="built_in">stack</span>;</span><br><span class="line">	<span class="keyword">atomic_t</span> usage;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;	<span class="comment">/* per process flags, defined below */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ptrace;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span> <span class="title">wake_entry</span>;</span></span><br><span class="line">	<span class="keyword">int</span> on_cpu;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_THREAD_INFO_IN_TASK</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cpu;	<span class="comment">/* current CPU */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> wakee_flips;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> wakee_flip_decay_ts;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">last_wakee</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> wake_cpu;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span> on_rq;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> prio, static_prio, normal_prio;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> rt_priority;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">sched_class</span> *<span class="title">sched_class</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> <span class="title">se</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span> <span class="title">rt</span>;</span></span><br><span class="line">	u64 last_sleep_ts;</span><br><span class="line">	u64 last_cpu_selected_ts;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SCHED_WALT</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ravg</span> <span class="title">ravg</span>;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 'init_load_pct' represents the initial task load assigned to children</span></span><br><span class="line"><span class="comment">	 * of this task</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	u32 init_load_pct;</span><br><span class="line">	u64 last_wake_ts;</span><br><span class="line">	u64 last_switch_out_ts;</span><br><span class="line">	u64 last_enqueued_ts;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">related_thread_group</span> *<span class="title">grp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">grp_list</span>;</span></span><br><span class="line">	u64 cpu_cycles;</span><br><span class="line">	<span class="keyword">bool</span> misfit;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CGROUP_SCHED</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_group</span> *<span class="title">sched_task_group</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sched_dl_entity</span> <span class="title">dl</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PREEMPT_NOTIFIERS</span></span><br><span class="line">	<span class="comment">/* list of struct preempt_notifier: */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">preempt_notifiers</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_DEV_IO_TRACE</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> btrace_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> policy;</span><br><span class="line">	<span class="keyword">int</span> nr_cpus_allowed;</span><br><span class="line">	<span class="keyword">cpumask_t</span> cpus_allowed;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PREEMPT_RCU</span></span><br><span class="line">	<span class="keyword">int</span> rcu_read_lock_nesting;</span><br><span class="line">	<span class="keyword">union</span> rcu_special rcu_read_unlock_special;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">rcu_node_entry</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_node</span> *<span class="title">rcu_blocked_node</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* #ifdef CONFIG_PREEMPT_RCU */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TASKS_RCU</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> rcu_tasks_nvcsw;</span><br><span class="line">	<span class="keyword">bool</span> rcu_tasks_holdout;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">rcu_tasks_holdout_list</span>;</span></span><br><span class="line">	<span class="keyword">int</span> rcu_tasks_idle_cpu;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* #ifdef CONFIG_TASKS_RCU */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SCHED_INFO</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sched_info</span> <span class="title">sched_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tasks</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">plist_node</span> <span class="title">pushable_tasks</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">pushable_dl_tasks</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>, *<span class="title">active_mm</span>;</span></span><br><span class="line">	<span class="comment">/* per-thread vma caching */</span></span><br><span class="line">	u32 vmacache_seqnum;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vmacache</span>[<span class="title">VMACACHE_SIZE</span>];</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(SPLIT_RSS_COUNTING)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_rss_stat</span>	<span class="title">rss_stat</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/* task state */</span></span><br><span class="line">	<span class="keyword">int</span> exit_state;</span><br><span class="line">	<span class="keyword">int</span> exit_code, exit_signal;</span><br><span class="line">	<span class="keyword">int</span> pdeath_signal;  <span class="comment">/*  The signal sent when the parent dies  */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> jobctl;	<span class="comment">/* JOBCTL_*, siglock protected */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Used for emulating ABI behavior of previous Linux versions */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> personality;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* scheduler bits, serialized by scheduler locks */</span></span><br><span class="line">	<span class="keyword">unsigned</span> sched_reset_on_fork:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> sched_contributes_to_load:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> sched_migrated:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> sched_remote_wakeup:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> :<span class="number">0</span>; <span class="comment">/* force alignment to the next boundary */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* unserialized, strictly 'current' */</span></span><br><span class="line">	<span class="keyword">unsigned</span> in_execve:<span class="number">1</span>; <span class="comment">/* bit to tell LSMs we're in execve */</span></span><br><span class="line">	<span class="keyword">unsigned</span> in_iowait:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(TIF_RESTORE_SIGMASK)</span></span><br><span class="line">	<span class="keyword">unsigned</span> restore_sigmask:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="keyword">unsigned</span> memcg_may_oom:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line">	<span class="keyword">unsigned</span> memcg_kmem_skip_account:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_COMPAT_BRK</span></span><br><span class="line">	<span class="keyword">unsigned</span> brk_randomized:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CGROUPS</span></span><br><span class="line">	<span class="comment">/* disallow userland-initiated cgroup migration */</span></span><br><span class="line">	<span class="keyword">unsigned</span> no_cgroup_migration:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> atomic_flags; <span class="comment">/* Flags needing atomic access. */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">restart_block</span> <span class="title">restart_block</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	<span class="keyword">pid_t</span> tgid;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CC_STACKPROTECTOR</span></span><br><span class="line">	<span class="comment">/* Canary value for the -fstack-protector gcc feature */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> stack_canary;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * pointers to (original) parent process, youngest child, younger sibling,</span></span><br><span class="line"><span class="comment">	 * older sibling, respectively.  (p-&gt;father can be replaced with</span></span><br><span class="line"><span class="comment">	 * p-&gt;real_parent-&gt;pid)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> __<span class="title">rcu</span> *<span class="title">real_parent</span>;</span> <span class="comment">/* real parent process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> __<span class="title">rcu</span> *<span class="title">parent</span>;</span> <span class="comment">/* recipient of SIGCHLD, wait4() reports */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * children/sibling forms the list of my natural children</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">children</span>;</span>	<span class="comment">/* list of my children */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">sibling</span>;</span>	<span class="comment">/* linkage in my parent's children list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">group_leader</span>;</span>	<span class="comment">/* threadgroup leader */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ptraced is the list of tasks this task is using ptrace on.</span></span><br><span class="line"><span class="comment">	 * This includes both natural children and PTRACE_ATTACH targets.</span></span><br><span class="line"><span class="comment">	 * p-&gt;ptrace_entry is p's link on the p-&gt;parent-&gt;ptraced list.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">ptraced</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">ptrace_entry</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* PID/PID hash table linkage. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid_link</span> <span class="title">pids</span>[<span class="title">PIDTYPE_MAX</span>];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">thread_group</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">thread_node</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">completion</span> *<span class="title">vfork_done</span>;</span>		<span class="comment">/* for vfork() */</span></span><br><span class="line">	<span class="keyword">int</span> __user *set_child_tid;		<span class="comment">/* CLONE_CHILD_SETTID */</span></span><br><span class="line">	<span class="keyword">int</span> __user *clear_child_tid;		<span class="comment">/* CLONE_CHILD_CLEARTID */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">cputime_t</span> utime, stime, utimescaled, stimescaled;</span><br><span class="line">	<span class="keyword">cputime_t</span> gtime;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CPU_FREQ_TIMES</span></span><br><span class="line">	u64 *time_in_state;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_state;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">prev_cputime</span> <span class="title">prev_cputime</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VIRT_CPU_ACCOUNTING_GEN</span></span><br><span class="line">	<span class="keyword">seqcount_t</span> vtime_seqcount;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> vtime_snap;</span><br><span class="line">	<span class="keyword">enum</span> &#123;</span><br><span class="line">		<span class="comment">/* Task is sleeping or running in a CPU with VTIME inactive */</span></span><br><span class="line">		VTIME_INACTIVE = <span class="number">0</span>,</span><br><span class="line">		<span class="comment">/* Task runs in userspace in a CPU with VTIME active */</span></span><br><span class="line">		VTIME_USER,</span><br><span class="line">		<span class="comment">/* Task runs in kernelspace in a CPU with VTIME active */</span></span><br><span class="line">		VTIME_SYS,</span><br><span class="line">	&#125; vtime_snap_whence;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NO_HZ_FULL</span></span><br><span class="line">	<span class="keyword">atomic_t</span> tick_dep_mask;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nvcsw, nivcsw; <span class="comment">/* context switch counts */</span></span><br><span class="line">	u64 start_time;		<span class="comment">/* monotonic time in nsec */</span></span><br><span class="line">	u64 real_start_time;	<span class="comment">/* boot based time in nsec */</span></span><br><span class="line"><span class="comment">/* mm fault and swap info: this can arguably be seen as either mm-specific or thread-specific */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> min_flt, maj_flt;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_cputime</span> <span class="title">cputime_expires</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">cpu_timers</span>[3];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* process credentials */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">ptracer_cred</span>;</span> <span class="comment">/* Tracer's credentials at attach */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">real_cred</span>;</span> <span class="comment">/* objective and real subjective task</span></span><br><span class="line"><span class="comment">					 * credentials (COW) */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">cred</span>;</span>	<span class="comment">/* effective (overridable) subjective task</span></span><br><span class="line"><span class="comment">					 * credentials (COW) */</span></span><br><span class="line">	<span class="keyword">char</span> comm[TASK_COMM_LEN]; <span class="comment">/* executable name excluding path</span></span><br><span class="line"><span class="comment">				     - access with [gs]et_task_comm (which lock</span></span><br><span class="line"><span class="comment">				       it with task_lock())</span></span><br><span class="line"><span class="comment">				     - initialized normally by setup_new_exec */</span></span><br><span class="line"><span class="comment">/* file system info */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nameidata</span> *<span class="title">nameidata</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSVIPC</span></span><br><span class="line"><span class="comment">/* ipc stuff */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sysv_sem</span> <span class="title">sysvsem</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sysv_shm</span> <span class="title">sysvshm</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DETECT_HUNG_TASK</span></span><br><span class="line"><span class="comment">/* hung task detection */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> last_switch_count;</span><br><span class="line">	<span class="keyword">bool</span> hang_detection_enabled;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/* filesystem information */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span> *<span class="title">fs</span>;</span></span><br><span class="line"><span class="comment">/* open file information */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span>;</span></span><br><span class="line"><span class="comment">/* namespaces */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nsproxy</span> *<span class="title">nsproxy</span>;</span></span><br><span class="line"><span class="comment">/* signal handlers */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">signal_struct</span> *<span class="title">signal</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sighand_struct</span> *<span class="title">sighand</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">sigset_t</span> blocked, real_blocked;</span><br><span class="line">	<span class="keyword">sigset_t</span> saved_sigmask;	<span class="comment">/* restored if set_restore_sigmask() was used */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sigpending</span> <span class="title">pending</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> sas_ss_sp;</span><br><span class="line">	<span class="keyword">size_t</span> sas_ss_size;</span><br><span class="line">	<span class="keyword">unsigned</span> sas_ss_flags;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> *<span class="title">task_works</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">audit_context</span> *<span class="title">audit_context</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_AUDITSYSCALL</span></span><br><span class="line">	<span class="keyword">kuid_t</span> loginuid;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> sessionid;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">seccomp</span> <span class="title">seccomp</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Thread group tracking */</span></span><br><span class="line">   	u32 parent_exec_id;</span><br><span class="line">   	u32 self_exec_id;</span><br><span class="line"><span class="comment">/* Protection of (de-)allocation: mm, files, fs, tty, keyrings, mems_allowed,</span></span><br><span class="line"><span class="comment"> * mempolicy */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> alloc_lock;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Protection of the PI data structures: */</span></span><br><span class="line">	<span class="keyword">raw_spinlock_t</span> pi_lock;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">wake_q_node</span> <span class="title">wake_q</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_RT_MUTEXES</span></span><br><span class="line">	<span class="comment">/* PI waiters blocked on a rt_mutex held by this task */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">pi_waiters</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">pi_waiters_leftmost</span>;</span></span><br><span class="line">	<span class="comment">/* Deadlock detection and priority inheritance handling */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rt_mutex_waiter</span> *<span class="title">pi_blocked_on</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_MUTEXES</span></span><br><span class="line">	<span class="comment">/* mutex deadlock detection */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex_waiter</span> *<span class="title">blocked_on</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TRACE_IRQFLAGS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> irq_events;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> hardirq_enable_ip;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> hardirq_disable_ip;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> hardirq_enable_event;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> hardirq_disable_event;</span><br><span class="line">	<span class="keyword">int</span> hardirqs_enabled;</span><br><span class="line">	<span class="keyword">int</span> hardirq_context;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> softirq_disable_ip;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> softirq_enable_ip;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> softirq_disable_event;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> softirq_enable_event;</span><br><span class="line">	<span class="keyword">int</span> softirqs_enabled;</span><br><span class="line">	<span class="keyword">int</span> softirq_context;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LOCKDEP</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> MAX_LOCK_DEPTH 48UL</span></span><br><span class="line">	u64 curr_chain_key;</span><br><span class="line">	<span class="keyword">int</span> lockdep_depth;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> lockdep_recursion;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">held_lock</span> <span class="title">held_locks</span>[<span class="title">MAX_LOCK_DEPTH</span>];</span></span><br><span class="line">	<span class="keyword">gfp_t</span> lockdep_reclaim_gfp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_UBSAN</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> in_ubsan;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* journalling filesystem info */</span></span><br><span class="line">	<span class="keyword">void</span> *journal_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* stacked block device info */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio_list</span> *<span class="title">bio_list</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLOCK</span></span><br><span class="line"><span class="comment">/* stack plugging */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_plug</span> *<span class="title">plug</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* VM state */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">reclaim_state</span> *<span class="title">reclaim_state</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span> *<span class="title">backing_dev_info</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_context</span> *<span class="title">io_context</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> ptrace_message;</span><br><span class="line">	<span class="keyword">siginfo_t</span> *last_siginfo; <span class="comment">/* For ptrace use.  */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_io_accounting</span> <span class="title">ioac</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_TASK_XACCT)</span></span><br><span class="line">	u64 acct_rss_mem1;	<span class="comment">/* accumulated rss usage */</span></span><br><span class="line">	u64 acct_vm_mem1;	<span class="comment">/* accumulated virtual memory usage */</span></span><br><span class="line">	<span class="keyword">cputime_t</span> acct_timexpd;	<span class="comment">/* stime + utime since last update */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CPUSETS</span></span><br><span class="line">	<span class="keyword">nodemask_t</span> mems_allowed;	<span class="comment">/* Protected by alloc_lock */</span></span><br><span class="line">	<span class="keyword">seqcount_t</span> mems_allowed_seq;	<span class="comment">/* Seqence no to catch updates */</span></span><br><span class="line">	<span class="keyword">int</span> cpuset_mem_spread_rotor;</span><br><span class="line">	<span class="keyword">int</span> cpuset_slab_spread_rotor;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CGROUPS</span></span><br><span class="line">	<span class="comment">/* Control Group info protected by css_set_lock */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">css_set</span> __<span class="title">rcu</span> *<span class="title">cgroups</span>;</span></span><br><span class="line">	<span class="comment">/* cg_list protected by css_set_lock and tsk-&gt;alloc_lock */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">cg_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FUTEX</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">robust_list_head</span> __<span class="title">user</span> *<span class="title">robust_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">compat_robust_list_head</span> __<span class="title">user</span> *<span class="title">compat_robust_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">pi_state_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">futex_pi_state</span> *<span class="title">pi_state_cache</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PERF_EVENTS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">perf_event_context</span> *<span class="title">perf_event_ctxp</span>[<span class="title">perf_nr_task_contexts</span>];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">perf_event_mutex</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">perf_event_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_PREEMPT</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> preempt_disable_ip;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mempolicy</span> *<span class="title">mempolicy</span>;</span>	<span class="comment">/* Protected by alloc_lock */</span></span><br><span class="line">	<span class="keyword">short</span> il_next;</span><br><span class="line">	<span class="keyword">short</span> pref_node_fork;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA_BALANCING</span></span><br><span class="line">	<span class="keyword">int</span> numa_scan_seq;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> numa_scan_period;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> numa_scan_period_max;</span><br><span class="line">	<span class="keyword">int</span> numa_preferred_nid;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> numa_migrate_retry;</span><br><span class="line">	u64 node_stamp;			<span class="comment">/* migration stamp  */</span></span><br><span class="line">	u64 last_task_numa_placement;</span><br><span class="line">	u64 last_sum_exec_runtime;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> <span class="title">numa_work</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">numa_entry</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">numa_group</span> *<span class="title">numa_group</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * numa_faults is an array split into four regions:</span></span><br><span class="line"><span class="comment">	 * faults_memory, faults_cpu, faults_memory_buffer, faults_cpu_buffer</span></span><br><span class="line"><span class="comment">	 * in this precise order.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * faults_memory: Exponential decaying average of faults on a per-node</span></span><br><span class="line"><span class="comment">	 * basis. Scheduling placement decisions are made based on these</span></span><br><span class="line"><span class="comment">	 * counts. The values remain static for the duration of a PTE scan.</span></span><br><span class="line"><span class="comment">	 * faults_cpu: Track the nodes the process was running on when a NUMA</span></span><br><span class="line"><span class="comment">	 * hinting fault was incurred.</span></span><br><span class="line"><span class="comment">	 * faults_memory_buffer and faults_cpu_buffer: Record faults per node</span></span><br><span class="line"><span class="comment">	 * during the current scan window. When the scan completes, the counts</span></span><br><span class="line"><span class="comment">	 * in faults_memory and faults_cpu decay and these values are copied.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *numa_faults;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> total_numa_faults;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * numa_faults_locality tracks if faults recorded during the last</span></span><br><span class="line"><span class="comment">	 * scan window were remote/local or failed to migrate. The task scan</span></span><br><span class="line"><span class="comment">	 * period is adapted based on the locality of the faults with different</span></span><br><span class="line"><span class="comment">	 * weights depending on whether they were shared or private faults</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> numa_faults_locality[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> numa_pages_migrated;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_NUMA_BALANCING */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ARCH_WANT_BATCHED_UNMAP_TLB_FLUSH</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tlbflush_unmap_batch</span> <span class="title">tlb_ubc</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * cache last used pipe for splice</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">splice_pipe</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page_frag</span> <span class="title">task_frag</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>	CONFIG_TASK_DELAY_ACCT</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_delay_info</span> *<span class="title">delays</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FAULT_INJECTION</span></span><br><span class="line">	<span class="keyword">int</span> make_it_fail;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * when (nr_dirtied &gt;= nr_dirtied_pause), it's time to call</span></span><br><span class="line"><span class="comment">	 * balance_dirty_pages() for some dirty throttling pause</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> nr_dirtied;</span><br><span class="line">	<span class="keyword">int</span> nr_dirtied_pause;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> dirty_paused_when; <span class="comment">/* start of a write-and-pause period */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LATENCYTOP</span></span><br><span class="line">	<span class="keyword">int</span> latency_record_count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">latency_record</span> <span class="title">latency_record</span>[<span class="title">LT_SAVECOUNT</span>];</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * time slack values; these are used to round up poll() and</span></span><br><span class="line"><span class="comment">	 * select() etc timeout values. These are in nanoseconds.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	u64 timer_slack_ns;</span><br><span class="line">	u64 default_timer_slack_ns;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> kasan_depth;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FUNCTION_GRAPH_TRACER</span></span><br><span class="line">	<span class="comment">/* Index of current stored address in ret_stack */</span></span><br><span class="line">	<span class="keyword">int</span> curr_ret_stack;</span><br><span class="line">	<span class="comment">/* Stack of return addresses for return function tracing */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ftrace_ret_stack</span>	*<span class="title">ret_stack</span>;</span></span><br><span class="line">	<span class="comment">/* time stamp for last schedule */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> ftrace_timestamp;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Number of functions that haven't been traced</span></span><br><span class="line"><span class="comment">	 * because of depth overrun.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">atomic_t</span> trace_overrun;</span><br><span class="line">	<span class="comment">/* Pause for the tracing */</span></span><br><span class="line">	<span class="keyword">atomic_t</span> tracing_graph_pause;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TRACING</span></span><br><span class="line">	<span class="comment">/* state flags for use by tracers */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> trace;</span><br><span class="line">	<span class="comment">/* bitmask and counter of trace recursion */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> trace_recursion;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_TRACING */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KCOV</span></span><br><span class="line">	<span class="comment">/* Coverage collection mode enabled for this task (0 if disabled). */</span></span><br><span class="line">	<span class="keyword">enum</span> kcov_mode kcov_mode;</span><br><span class="line">	<span class="comment">/* Size of the kcov_area. */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	kcov_size;</span><br><span class="line">	<span class="comment">/* Buffer for coverage collection. */</span></span><br><span class="line">	<span class="keyword">void</span>		*kcov_area;</span><br><span class="line">	<span class="comment">/* kcov desciptor wired with this task or NULL. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kcov</span>	*<span class="title">kcov</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg_in_oom</span>;</span></span><br><span class="line">	<span class="keyword">gfp_t</span> memcg_oom_gfp_mask;</span><br><span class="line">	<span class="keyword">int</span> memcg_oom_order;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* number of pages to reclaim on returning to userland */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> memcg_nr_pages_over_high;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_UPROBES</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uprobe_task</span> *<span class="title">utask</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_BCACHE) || defined(CONFIG_BCACHE_MODULE)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	sequential_io;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	sequential_io_avg;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_ATOMIC_SLEEP</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>	task_state_change;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span> pagefault_disabled;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MMU</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">oom_reaper_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VMAP_STACK</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_struct</span> *<span class="title">stack_vm_area</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_THREAD_INFO_IN_TASK</span></span><br><span class="line">	<span class="comment">/* A live task holds one reference. */</span></span><br><span class="line">	<span class="keyword">atomic_t</span> stack_refcount;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/* CPU-specific state of this task */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thread_struct</span> <span class="title">thread</span>;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * WARNING: on x86, 'thread_struct' contains a variable-sized</span></span><br><span class="line"><span class="comment"> * structure.  It *MUST* be at the end of 'task_struct'.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Do not put anything below here!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="进程状态"><a href="#进程状态" class="headerlink" title="进程状态"></a>进程状态</h4><p>task_struct中的state和exit_state成员，存储了进程的状态标志，进程状态定义在kernel/msm-4.9/include/linux/sched.h中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Task state bitmask. NOTE! These bits are also</span></span><br><span class="line"><span class="comment"> * encoded in fs/proc/array.c: get_task_state().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We have two separate sets of flags: task-&gt;state</span></span><br><span class="line"><span class="comment"> * is about runnability, while task-&gt;exit_state are</span></span><br><span class="line"><span class="comment"> * about the task exiting. Confusing, but this way</span></span><br><span class="line"><span class="comment"> * modifying one set can't modify the other one by</span></span><br><span class="line"><span class="comment"> * mistake.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// R状态，也就是可执行状态，包含了就绪或者执行中的两种；</span></span><br><span class="line"><span class="comment">// 也就是R状态的进程可能已经获得cpu资源正在执行，也可能在某个cpu的就绪队列上等待cpu资源</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_RUNNING		0</span></span><br><span class="line"><span class="comment">// S状态，可中断的休眠状态，这个状态的进程通常在等某些资源，会被挂在对应资源的等待队列中</span></span><br><span class="line"><span class="comment">// 可以被中断或者信号唤醒</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_INTERRUPTIBLE	1</span></span><br><span class="line"><span class="comment">// D状态，不可中断休眠状态，</span></span><br><span class="line"><span class="comment">//  与TASK_INTERRUPTIBLE状态类似，进程处于睡眠状态，但是此刻进程是不可中断的。不可中断，指的并不是CPU不响应外部硬件的中断，而是指进程不响应异步信号。比如kill -9这类信号是不能杀死这种状态的进程的。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_UNINTERRUPTIBLE	2</span></span><br><span class="line"><span class="comment">// T (TASK_STOPPED or TASK_TRACED)，暂停状态或跟踪状态</span></span><br><span class="line"><span class="comment">// 向进程发送一个SIGSTOP信号，它就会因响应该信号而进入TASK_STOPPED状态（除非该进程本身处于TASK_UNINTERRUPTIBLE状态而不响应信号）。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __TASK_STOPPED		4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __TASK_TRACED		8</span></span><br><span class="line"><span class="comment">/* in tsk-&gt;exit_state */</span></span><br><span class="line"><span class="comment">// X状态，进程在退出的过程中，处于TASK_DEAD状态；很短暂，进程很快就被销毁</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXIT_DEAD		16</span></span><br><span class="line"><span class="comment">// Z状态，僵尸进程，父进程不能为其收尸</span></span><br><span class="line"><span class="comment">// 因此，一个僵尸进程产生的过程是：父进程调用fork创建子进程后，子进程运行直至其终止，它立即从内存中移除，但进程描述符仍然保留在内存中（进程描述符占有极少的内存空间）。子进程的状态变成EXIT_ZOMBIE，并且向父进程发送SIGCHLD 信号，父进程此时应该调用 wait() 系统调用来获取子进程的退出状态以及其它的信息。在 wait 调用之后，僵尸进程就完全从内存中移除。因此一个僵尸存在于其终止到父进程调用 wait 等函数这个时间的间隙，一般很快就消失，但如果编程不合理，父进程从不调用 wait 等系统调用来收集僵尸进程，那么这些进程会一直存在内存中。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXIT_ZOMBIE		32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXIT_TRACE		(EXIT_ZOMBIE | EXIT_DEAD)</span></span><br><span class="line"><span class="comment">/* in tsk-&gt;state again */</span></span><br><span class="line"><span class="comment">// X状态，进程在退出的过程中，处于TASK_DEAD状态；很短暂，进程很快就被销毁</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_DEAD		64</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_WAKEKILL		128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_WAKING		256</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_PARKED		512</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_NOLOAD		1024</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_NEW		2048</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_STATE_MAX		4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_STATE_TO_CHAR_STR <span class="meta-string">"RSDTtXZxKWPNn"</span></span></span><br></pre></td></tr></table></figure>

<h4 id="进程优先级"><a href="#进程优先级" class="headerlink" title="进程优先级"></a>进程优先级</h4><p>Linux 中采用了两种不同的优先级范围，一种是 nice 值，一种是实时优先级。在task_truct中的可以看到进程有四种优先级。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> prio, static_prio, normal_prio;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> rt_priority;</span><br></pre></td></tr></table></figure>

<p>在prio.h中可以找到相关的一些宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_NICE	19</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN_NICE	-20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NICE_WIDTH	(MAX_NICE - MIN_NICE + 1) <span class="comment">//-&gt;nice置的范围40</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Priority of a process goes from 0..MAX_PRIO-1, valid RT</span></span><br><span class="line"><span class="comment"> * priority is 0..MAX_RT_PRIO-1, and SCHED_NORMAL/SCHED_BATCH</span></span><br><span class="line"><span class="comment"> * tasks are in the range MAX_RT_PRIO..MAX_PRIO-1. Priority</span></span><br><span class="line"><span class="comment"> * values are inverted: lower p-&gt;prio value means higher priority.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The MAX_USER_RT_PRIO value allows the actual maximum</span></span><br><span class="line"><span class="comment"> * RT priority to be separate from the value exported to</span></span><br><span class="line"><span class="comment"> * user-space.  This allows kernel threads to set their</span></span><br><span class="line"><span class="comment"> * priority to a value higher than any user task. Note:</span></span><br><span class="line"><span class="comment"> * MAX_RT_PRIO must not be smaller than MAX_USER_RT_PRIO.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_USER_RT_PRIO	100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_RT_PRIO		MAX_USER_RT_PRIO</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_PRIO		(MAX_RT_PRIO + NICE_WIDTH) <span class="comment">//--&gt;140</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_PRIO		(MAX_RT_PRIO + NICE_WIDTH / 2) <span class="comment">//--&gt;120</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Convert user-nice values [ -20 ... 0 ... 19 ]</span></span><br><span class="line"><span class="comment"> * to static priority [ MAX_RT_PRIO..MAX_PRIO-1 ],</span></span><br><span class="line"><span class="comment"> * and back.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NICE_TO_PRIO(nice)	((nice) + DEFAULT_PRIO)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIO_TO_NICE(prio)	((prio) - DEFAULT_PRIO)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 'User priority' is the nice value converted to something we</span></span><br><span class="line"><span class="comment"> * can work with better when scaling various scheduler parameters,</span></span><br><span class="line"><span class="comment"> * it's a [ 0 ... 39 ] range.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_PRIO(p)		((p)-MAX_RT_PRIO)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_USER_PRIO(p)	USER_PRIO((p)-&gt;static_prio)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_USER_PRIO		(USER_PRIO(MAX_PRIO))</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>prio，动态优先级；prio 的值是调度器最终使用的优先级数值，即调度器选择一个进程时实际选择的值。prio 值越小，表明进程的优先级越高。prio  值的取值范围是 0 ~ MAX_PRIO-1，即 0 ~ 139（包括 0 和 139），根据调度策略的不同，又可以分为两个区间，其中区间 0 ~ 99 的属于实时进程，区间 100 ~139 的为非实时进程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">prio = MAX_RT_PRIO - 1 - rt_priority    // 进程为实时进程</span><br><span class="line">prio = static_prio　　　　　　　　　　// 进程为非实时进程</span><br></pre></td></tr></table></figure>
</li>
<li><p>static_prio ，静态优先级；静态优先级不会随时间改变，内核不会主动修改它，只能通过系统调用去修改 ，详细可以查看set_user_nice函数。</p>
</li>
<li><p>normal_prio，归一化优先级；取决于静态优先级和调度策略，可以通过 _setscheduler 函数来设置它的值 。对于非实时进程，normal_prio 的值就等于静态优先级值 static_prio；对于实时进程，normal_prio = MAX_RT_PRIO-1 - p-&gt;rt_priority。</p>
</li>
<li><p>rt_priority，实时优先级；rt_priority 值的范围是 0 ~ 99，只对实时进程有效。rt_priority的值越大，意味着进程优先级越高。</p>
</li>
</ul>
<h4 id="调度策略"><a href="#调度策略" class="headerlink" title="调度策略"></a>调度策略</h4><p>Linux所支持的调度策略定义在kernel/msm-4.9/include/uapi/linux/sched.h中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Scheduling policies</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCHED_NORMAL		0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCHED_FIFO		1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCHED_RR		2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCHED_BATCH		3</span></span><br><span class="line"><span class="comment">/* SCHED_ISO: reserved but not implemented yet */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCHED_IDLE		5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCHED_DEADLINE		6</span></span><br></pre></td></tr></table></figure>

<ul>
<li>SCHED_NORMAL，分时调度策略；默认的调度策略，针对的是普通进程。</li>
<li>SCHED_FIFO，实时调度策略，先到先服务；不受时间片影响，只有更高优先级的进程、中断到来或者主动退让才可能中断。</li>
<li>SCHED_RR，实时调度策略，手时间片影响。</li>
<li>SCHED_BATCH，与SCHED_NORMAL类似？</li>
<li>SCHED_IDLE，则在系统空闲时调用idle进程。</li>
<li>SCHED_DEADLINE，</li>
</ul>
<h2 id="调度信息"><a href="#调度信息" class="headerlink" title="调度信息"></a>调度信息</h2><p>从proc文件系统查看调度相关的内核参数和某个进程的调度信息。通过对应的节点找到源码来学习一些调度的细节信息，不过这个需要长期积累的过程。这里面的代码入口和相关的参数的计算集中在：</p>
<p>kernel/msm-4.9/fs/proc/base.c</p>
<p>kernel/msm-4.9/kernel/sched/rt.c</p>
<p>kernel/msm-4.9/kernel/sched/fair.c</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">TB-XXXXX:/proc/sys/kernel # ls -l | grep sched</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_autogroup_enabled</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_boost</span><br><span class="line">-r--r--r-- 1 root root 0 2019-01-02 14:49 sched_cfs_boost</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_child_runs_first</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_cpu_high_irqload</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_cstate_aware</span><br><span class="line">dr-xr-xr-x 1 root root 0 2019-01-02 14:49 sched_domain</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_downmigrate</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_group_downmigrate</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_group_upmigrate</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_initial_task_util</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_latency_ns</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_migration_cost_ns</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_min_granularity_ns</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_nr_migrate</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_rr_timeslice_ms</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_rt_period_us</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_rt_runtime_us</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_schedstats</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_shares_window_ns</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_sync_hint_enable</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_time_avg_ms</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_tunable_scaling</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_upmigrate</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_wakeup_granularity_ns</span><br><span class="line">-rw-r--r-- 1 root root 0 2019-01-02 14:49 sched_walt_rotate_big_tasks</span><br></pre></td></tr></table></figure>

<p>某个进程的调度信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TB-XXXXX:/proc/1 # ls -l | grep sched</span><br><span class="line">-rw-r--r--  1 root root 0 2019-01-02 16:14 sched</span><br><span class="line">-rw-rw-rw-  1 root root 0 2019-01-02 16:14 sched_group_id</span><br><span class="line">-rw-r--r--  1 root root 0 2019-01-02 16:14 sched_init_task_load</span><br><span class="line">-rw-r--r--  1 root root 0 2019-01-02 16:14 sched_wake_up_idle</span><br><span class="line">-r--r--r--  1 root root 0 2019-01-02 16:14 schedstat</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">TB-XXXXX:/proc/1 # cat sched</span><br><span class="line">init (1, #threads: 1)</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">se.exec_start                                :      86366815.066828</span><br><span class="line">se.vruntime                                  :       7106022.201404</span><br><span class="line">se.sum_exec_runtime                          :          1723.113272</span><br><span class="line">se.nr_migrations                             :                  444</span><br><span class="line">se.statistics.sum_sleep_runtime              :      86660221.366861</span><br><span class="line">se.statistics.wait_start                     :             0.000000</span><br><span class="line">se.statistics.sleep_start                    :      86672290.107305</span><br><span class="line">se.statistics.block_start                    :             0.000000</span><br><span class="line">se.statistics.sleep_max                      :      84631797.808318</span><br><span class="line">se.statistics.block_max                      :           272.825990</span><br><span class="line">se.statistics.exec_max                       :             9.988228</span><br><span class="line">se.statistics.slice_max                      :            11.747396</span><br><span class="line">se.statistics.wait_max                       :           106.949427</span><br><span class="line">se.statistics.wait_sum                       :          1637.179936</span><br><span class="line">se.statistics.wait_count                     :                 1117</span><br><span class="line">se.statistics.iowait_sum                     :           273.897345</span><br><span class="line">se.statistics.iowait_count                   :                   85</span><br><span class="line">se.statistics.nr_migrations_cold             :                    0</span><br><span class="line">se.statistics.nr_failed_migrations_affine    :                    0</span><br><span class="line">se.statistics.nr_failed_migrations_running   :                   54</span><br><span class="line">se.statistics.nr_failed_migrations_hot       :                    0</span><br><span class="line">se.statistics.nr_forced_migrations           :                   22</span><br><span class="line">se.statistics.nr_wakeups                     :                  737</span><br><span class="line">se.statistics.nr_wakeups_sync                :                  408</span><br><span class="line">se.statistics.nr_wakeups_migrate             :                  176</span><br><span class="line">se.statistics.nr_wakeups_local               :                  516</span><br><span class="line">se.statistics.nr_wakeups_remote              :                  221</span><br><span class="line">se.statistics.nr_wakeups_affine              :                    0</span><br><span class="line">se.statistics.nr_wakeups_affine_attempts     :                    0</span><br><span class="line">se.statistics.nr_wakeups_passive             :                    0</span><br><span class="line">se.statistics.nr_wakeups_idle                :                    0</span><br><span class="line">se.statistics.nr_wakeups_sis_attempts        :                    0</span><br><span class="line">se.statistics.nr_wakeups_sis_idle            :                    0</span><br><span class="line">se.statistics.nr_wakeups_sis_cache_affine    :                    0</span><br><span class="line">se.statistics.nr_wakeups_sis_suff_cap        :                    0</span><br><span class="line">se.statistics.nr_wakeups_sis_idle_cpu        :                    0</span><br><span class="line">se.statistics.nr_wakeups_sis_count           :                    0</span><br><span class="line">se.statistics.nr_wakeups_secb_attempts       :                  737</span><br><span class="line">se.statistics.nr_wakeups_secb_sync           :                  408</span><br><span class="line">se.statistics.nr_wakeups_secb_idle_bt        :                    0</span><br><span class="line">se.statistics.nr_wakeups_secb_insuff_cap     :                   30</span><br><span class="line">se.statistics.nr_wakeups_secb_no_nrg_sav     :                    3</span><br><span class="line">se.statistics.nr_wakeups_secb_nrg_sav        :                   33</span><br><span class="line">se.statistics.nr_wakeups_secb_count          :                    0</span><br><span class="line">se.statistics.nr_wakeups_fbt_attempts        :                  308</span><br><span class="line">se.statistics.nr_wakeups_fbt_no_cpu          :                    0</span><br><span class="line">se.statistics.nr_wakeups_fbt_no_sd           :                    0</span><br><span class="line">se.statistics.nr_wakeups_fbt_pref_idle       :                    0</span><br><span class="line">se.statistics.nr_wakeups_fbt_count           :                  308</span><br><span class="line">se.statistics.nr_wakeups_cas_attempts        :                    0</span><br><span class="line">se.statistics.nr_wakeups_cas_count           :                    0</span><br><span class="line">ravg.demand                                  :              2571510</span><br><span class="line">avg_atom                                     :             0.547020</span><br><span class="line">avg_per_cpu                                  :             3.880885</span><br><span class="line">nr_switches                                  :                 3150</span><br><span class="line">nr_voluntary_switches                        :                 2546</span><br><span class="line">nr_involuntary_switches                      :                  604</span><br><span class="line">se.load.weight                               :              1048576</span><br><span class="line">se.avg.load_sum                              :              4330304</span><br><span class="line">se.avg.util_sum                              :              3564292</span><br><span class="line">se.avg.load_avg                              :                   90</span><br><span class="line">se.avg.util_avg                              :                   74</span><br><span class="line">se.avg.last_update_time                      :       86366815066828</span><br><span class="line">policy                                       :                    0</span><br><span class="line">prio                                         :                  120</span><br><span class="line">clock-delta                                  :                  157</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> proc_pid_sched_group_id_operations操作集，related_thread_group还不清楚干啥的</span><br><span class="line">TB-XXXXX:/proc/1 # cat sched_group_id</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>   task_struct -&gt; init_load_pct </span><br><span class="line">TB-XXXXX:/proc/1 # cat sched_init_task_load</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> task_struct -&gt;flags,是否启动PF_WAKE_UP_IDLE标记</span><br><span class="line">TB-XXXXX:/proc/1 # cat sched_wake_up_idle</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>第一列对应sched_entity-&gt;sum_exec_runtime</span><br><span class="line"><span class="meta">#</span>第二列对应sched_info-&gt;run_delay,在cpu就绪队列上的等待总时间</span><br><span class="line"><span class="meta">#</span>第三列对应sched_info-&gt;pcount，得到执行的总次数</span><br><span class="line">TB-XXXXX:/proc/1 # cat schedstat</span><br><span class="line">1727573115 1616733105 3154</span><br><span class="line">TB-XXXX:/proc/1 # setprop sys.hzy.test 2</span><br><span class="line">TB-XXXXX:/proc/1 # cat schedstat</span><br><span class="line">1729426344 1616733105 3155</span><br><span class="line">TB-XXXXX:/proc/1 # cat sched</span><br><span class="line">nr_switches                                  :                 3155</span><br><span class="line">nr_voluntary_switches                        :                 2551</span><br><span class="line">nr_involuntary_switches                      :                  604</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://wuchong.me" target="_blank" rel="noopener">http://wuchong.me</a></p>
<p><a href="http://linuxperf.com" target="_blank" rel="noopener">http://linuxperf.com</a></p>
<p><a href="https://blog.csdn.net/ZYC88888/article/details/80194088" target="_blank" rel="noopener">https://blog.csdn.net/ZYC88888/article/details/80194088</a></p>
<p><a href="https://www.xuebuyuan.com/2961605.html" target="_blank" rel="noopener">https://www.xuebuyuan.com/2961605.html</a></p>
<p><a href="https://blog.csdn.net/sunao2002002/article/details/84132505" target="_blank" rel="noopener">https://blog.csdn.net/sunao2002002/article/details/84132505</a></p>
<p><a href="https://blog.csdn.net/wxh0000mm/article/details/88421015" target="_blank" rel="noopener">https://blog.csdn.net/wxh0000mm/article/details/88421015</a></p>
<p><a href="https://www.cnblogs.com/zfyouxi/p/4263622.html" target="_blank" rel="noopener">https://www.cnblogs.com/zfyouxi/p/4263622.html</a></p>
<p><a href="https://blog.csdn.net/xiaofeng_yan/article/details/48246101" target="_blank" rel="noopener">https://blog.csdn.net/xiaofeng_yan/article/details/48246101</a></p>
<p><a href="https://www.jianshu.com/u/98b5369ae892" target="_blank" rel="noopener">https://www.jianshu.com/u/98b5369ae892</a></p>
<p><a href="http://blog.chinaunix.net/uid-20564848-id-73480.html" target="_blank" rel="noopener">http://blog.chinaunix.net/uid-20564848-id-73480.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/20/Linux-process-management/" data-id="cjx4rca8m001wt0iihu8666ar" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/学习/">学习</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/03/26/Android-binder-impletment/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Android binder机制学习
        
      </div>
    </a>
  
  
    <a href="/2019/03/15/Android-monkey-offline-test/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">monkey离线测试受adb拖累问题</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AIDL/">AIDL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HIDL/">HIDL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/driver/">driver</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习/">学习</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/实战/">实战</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/稳定性/">稳定性</a><span class="tag-list-count">8</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AIDL/" style="font-size: 10px;">AIDL</a> <a href="/tags/Android/" style="font-size: 16px;">Android</a> <a href="/tags/HIDL/" style="font-size: 10px;">HIDL</a> <a href="/tags/Linux/" style="font-size: 18px;">Linux</a> <a href="/tags/driver/" style="font-size: 10px;">driver</a> <a href="/tags/学习/" style="font-size: 20px;">学习</a> <a href="/tags/实战/" style="font-size: 12px;">实战</a> <a href="/tags/稳定性/" style="font-size: 14px;">稳定性</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/06/15/Linux-system-ipc/">Linux进程间通信机制</a>
          </li>
        
          <li>
            <a href="/2019/06/01/Android-hidl-sample-impletment/">Android9.0 HIDL 学习</a>
          </li>
        
          <li>
            <a href="/2019/05/26/Android-sub-system-impletment/">实现一个简单的android子系统</a>
          </li>
        
          <li>
            <a href="/2019/05/25/Linux-global-data-overflow/">全局数据踩踏问题</a>
          </li>
        
          <li>
            <a href="/2019/05/22/Qcom-watchdog/">高通watchdog驱动分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 JoyYoung<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>