<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>Android启动流程-FBE部分 | JoyYoung&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="学习android系统FBE">
<meta name="keywords" content="学习,Linux">
<meta property="og:type" content="article">
<meta property="og:title" content="Android启动流程-FBE部分">
<meta property="og:url" content="http://yoursite.com/2019/06/25/Android-Init-FBE/index.html">
<meta property="og:site_name" content="JoyYoung&#39;s blog">
<meta property="og:description" content="学习android系统FBE">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2019/06/25/Android-Init-FBE/system-de-key.PNG">
<meta property="og:updated_time" content="2019-07-11T15:29:50.922Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android启动流程-FBE部分">
<meta name="twitter:description" content="学习android系统FBE">
<meta name="twitter:image" content="http://yoursite.com/2019/06/25/Android-Init-FBE/system-de-key.PNG">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JoyYoung&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Android-Init-FBE" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/25/Android-Init-FBE/" class="article-date">
  <time datetime="2019-06-25T11:41:00.000Z" itemprop="datePublished">2019-06-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android启动流程-FBE部分
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><p>Android从7.0版本开始支持文件级加密 (FBE)，全盘加密(FDE)慢慢的也被淘汰。Android9.0的项目基本上都已经从FDE切换成FBE了。</p>
<h5 id="如何开启FBE？"><a href="#如何开启FBE？" class="headerlink" title="如何开启FBE？"></a>如何开启FBE？</h5><p>加密主要都是针对用户分区的，也就是userdata分区；开启的方法跟FDE类似，都是在分区挂在表中进行配置，关键字为fileencryption。</p>
<h5 id="如何查看FBE状态信息？"><a href="#如何查看FBE状态信息？" class="headerlink" title="如何查看FBE状态信息？"></a>如何查看FBE状态信息？</h5><p>通过以下属性可以了解FBE的一些信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>已加密</span><br><span class="line">[ro.crypto.state]: [encrypted]</span><br><span class="line"><span class="meta">#</span>加密类型为file，也就是FBE</span><br><span class="line">[ro.crypto.type]: [file]</span><br><span class="line"><span class="meta">#</span>文件名加密模式，也就是加密算法；参考read_or_create_volkey函数</span><br><span class="line">[ro.crypto.volume.filenames_mode]: [aes-256-cts]</span><br></pre></td></tr></table></figure>

<h5 id="如何配置FBE算法？"><a href="#如何配置FBE算法？" class="headerlink" title="如何配置FBE算法？"></a>如何配置FBE算法？</h5><p>代码上可参考read_or_create_volkey函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">key_ref-&gt;contents_mode =</span><br><span class="line">    android::base::GetProperty(<span class="string">"ro.crypto.volume.contents_mode"</span>, <span class="string">"aes-256-xts"</span>);</span><br><span class="line">key_ref-&gt;filenames_mode =</span><br><span class="line">    android::base::GetProperty(<span class="string">"ro.crypto.volume.filenames_mode"</span>, <span class="string">"aes-256-heh"</span>);</span><br></pre></td></tr></table></figure>

<h5 id="如何查看加密区域状态？"><a href="#如何查看加密区域状态？" class="headerlink" title="如何查看加密区域状态？"></a>如何查看加密区域状态？</h5><p>在启用了 FBE 的设备上，每位用户均有两个可供应用使用的存储位置：</p>
<ul>
<li>凭据加密 (CE) 存储空间：这是默认存储位置，只有在用户解锁设备后才可用。</li>
<li>设备加密 (DE) 存储空间：在直接启动模式期间以及用户解锁设备后均可用。</li>
</ul>
<p>设置锁屏密码方式后重启，不解锁的情况下查看/data/data目录的内容如下，处于未解密状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TB-XXXXX:/data/data # ls</span><br><span class="line">+0EMs7,W0d0Igf2VdVLi38USHYbCUuRV            Qtv3rrLEIdhXd8lM4JVWO9USHYbCUuRV            aw1Xs2SSOrE39MVSHIvC,N42Zx7MdVw4YvMGgB</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>/data/user/0目录软连接到/data/data目录，也就是用户的CE目录；在未输入锁屏密码进行解锁之前，CE目录处于未解密状态。但是DE目录则不需要输入锁屏密码进行解密，其内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TB-XXXXX:/data/user_de/0 # ls</span><br><span class="line">android                                              com.android.sharedstoragebackup</span><br></pre></td></tr></table></figure>

<h5 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h5><p><a href="https://source.android.google.cn/security/encryption/file-based" target="_blank" rel="noopener">https://source.android.google.cn/security/encryption/file-based</a></p>
<h3 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h3><h5 id="init进程"><a href="#init进程" class="headerlink" title="init进程"></a>init进程</h5><p>和FDE一样，init进程加载fstab挂在表时会解析相关分区的配置信息进行相应的操作。init进程在进入死循环等待处理事件请求之前加载rc脚本，启动触发器完成init初始化流程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">    LoadBootScripts(am, sm);<span class="comment">//加载RC脚本</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Turning this on and letting the INFO logging be discarded adds 0.2s to</span></span><br><span class="line">    <span class="comment">// Nexus 9 boot time, so it's disabled by default.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span>) DumpState();</span><br><span class="line"></span><br><span class="line">    am.QueueEventTrigger(<span class="string">"early-init"</span>);<span class="comment">//开机过程第一个触发器early-init</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span></span><br><span class="line">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class="string">"wait_for_coldboot_done"</span>);</span><br><span class="line">    <span class="comment">// ... so that we can start queuing up actions that require stuff from /dev.</span></span><br><span class="line">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class="string">"MixHwrngIntoLinuxRng"</span>);</span><br><span class="line">    am.QueueBuiltinAction(SetMmapRndBitsAction, <span class="string">"SetMmapRndBits"</span>);</span><br><span class="line">    am.QueueBuiltinAction(SetKptrRestrictAction, <span class="string">"SetKptrRestrict"</span>);</span><br><span class="line">    am.QueueBuiltinAction(keychord_init_action, <span class="string">"keychord_init"</span>);</span><br><span class="line">    am.QueueBuiltinAction(console_init_action, <span class="string">"console_init"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Trigger all the boot actions to get us started.</span></span><br><span class="line">    am.QueueEventTrigger(<span class="string">"init"</span>);<span class="comment">//触发器init</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span></span><br><span class="line">    <span class="comment">// wasn't ready immediately after wait_for_coldboot_done</span></span><br><span class="line">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class="string">"MixHwrngIntoLinuxRng"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don't mount filesystems or start core system services in charger mode.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> bootmode = GetProperty(<span class="string">"ro.bootmode"</span>, <span class="string">""</span>);<span class="comment">//根据启动模式完成接下来的初始化工作</span></span><br><span class="line">    <span class="keyword">if</span> (bootmode == <span class="string">"charger"</span>) &#123;</span><br><span class="line">        am.QueueEventTrigger(<span class="string">"charger"</span>);<span class="comment">//关机充电模式</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        am.QueueEventTrigger(<span class="string">"late-init"</span>);<span class="comment">//正常启动模式</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run all property triggers based on current state of the properties.</span></span><br><span class="line">    am.QueueBuiltinAction(queue_property_triggers_action, <span class="string">"queue_property_triggers"</span>);</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看看AOSP的init.rc脚本可知，文件系统的加载是在late-init触发器阶段完成的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Mount filesystems and start core system services.</span><br><span class="line">on late-init</span><br><span class="line">    trigger early-fs</span><br><span class="line"></span><br><span class="line">    # Mount fstab in init.&#123;$device&#125;.rc by mount_all command. Optional parameter</span><br><span class="line">    # '--early' can be specified to skip entries with 'latemount'.</span><br><span class="line">    # /system and /vendor must be mounted by the end of the fs stage,</span><br><span class="line">    # while /data is optional.</span><br><span class="line">    trigger factory-fs</span><br><span class="line">    trigger fs</span><br><span class="line">    trigger post-fs</span><br><span class="line"></span><br><span class="line">    # Mount fstab in init.&#123;$device&#125;.rc by mount_all with '--late' parameter</span><br><span class="line">    # to only mount entries with 'latemount'. This is needed if '--early' is</span><br><span class="line">    # specified in the previous mount_all command on the fs stage.</span><br><span class="line">    # With /system mounted and properties form /system + /factory available,</span><br><span class="line">    # some services can be started.</span><br><span class="line">    trigger late-fs</span><br><span class="line"></span><br><span class="line">    # Now we can mount /data. File encryption requires keymaster to decrypt</span><br><span class="line">    # /data, which in turn can only be loaded when system properties are present.</span><br><span class="line">    trigger post-fs-data</span><br><span class="line"></span><br><span class="line">    # Now we can start zygote for devices with file based encryption</span><br><span class="line">    # 这里触发启动zygote进程，是否启动还依赖于加密状态</span><br><span class="line">    trigger zygote-start</span><br><span class="line"></span><br><span class="line">    # Load persist properties and override properties (if enabled) from /data.</span><br><span class="line">    trigger load_persist_props_action</span><br><span class="line"></span><br><span class="line">    # Remove a file to wake up anything waiting for firmware.</span><br><span class="line">    trigger firmware_mounts_complete</span><br><span class="line"></span><br><span class="line">    trigger early-boot</span><br><span class="line">    trigger boot</span><br><span class="line">    trigger mmi</span><br></pre></td></tr></table></figure>

<p>根据fstab挂在各分区是在fs触发器阶段完成，由init进程执行mount_all指令。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">on fs</span><br><span class="line">    ......</span><br><span class="line">    mount_all /vendor/etc/fstab.qcom</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<p>mount_all指令实际上是do_mount_all函数来完成，我们这个情况下只接受了/vendor/etc/fstab.qcom一个参数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* mount_all &lt;fstab&gt; [ &lt;path&gt; ]* [--&lt;options&gt;]*</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function might request a reboot, in which case it will</span></span><br><span class="line"><span class="comment"> * not return.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> Result&lt;Success&gt; do_mount_all(<span class="keyword">const</span> BuiltinArguments&amp; args) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">size_t</span> na = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> import_rc = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">bool</span> queue_event = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">int</span> mount_mode = MOUNT_MODE_DEFAULT;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* fstabfile = args[<span class="number">1</span>].c_str();</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">size_t</span> path_arg_end = args.size();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* prop_post_fix = <span class="string">"default"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (na = args.size() - <span class="number">1</span>; na &gt; <span class="number">1</span>; --na) &#123;</span><br><span class="line">        <span class="keyword">if</span> (args[na] == <span class="string">"--early"</span>) &#123;</span><br><span class="line">            path_arg_end = na;</span><br><span class="line">            queue_event = <span class="literal">false</span>;</span><br><span class="line">            mount_mode = MOUNT_MODE_EARLY;</span><br><span class="line">            prop_post_fix = <span class="string">"early"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args[na] == <span class="string">"--late"</span>) &#123;</span><br><span class="line">            path_arg_end = na;</span><br><span class="line">            import_rc = <span class="literal">false</span>;</span><br><span class="line">            mount_mode = MOUNT_MODE_LATE;</span><br><span class="line">            prop_post_fix = <span class="string">"late"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * step1：根据我们只有一个参数，所以这里跑的是default的情况：</span></span><br><span class="line"><span class="comment">     * [ro.boottime.init.mount_all.default]: [167]记录了mount_fstab整个过程的耗时</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> prop_name = <span class="string">"ro.boottime.init.mount_all."</span>s + prop_post_fix;</span><br><span class="line">    android::base::Timer t;</span><br><span class="line">    <span class="keyword">auto</span> mount_fstab_return_code = mount_fstab(fstabfile, mount_mode);</span><br><span class="line">    <span class="keyword">if</span> (!mount_fstab_return_code) &#123;</span><br><span class="line">        <span class="keyword">return</span> Error() &lt;&lt; <span class="string">"mount_fstab() failed "</span> &lt;&lt; mount_fstab_return_code.error();</span><br><span class="line">    &#125;</span><br><span class="line">    property_set(prop_name, <span class="built_in">std</span>::to_string(t.duration().count()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 关注late_import_paths变量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (import_rc) &#123;</span><br><span class="line">        <span class="comment">/* Paths of .rc files are specified at the 2nd argument and beyond */</span></span><br><span class="line">        import_late(args.args, <span class="number">2</span>, path_arg_end);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * step2：根据mount_fstab的返回码进行先关属性的设置和其他操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (queue_event) &#123;</span><br><span class="line">        <span class="comment">/* queue_fs_event will queue event based on mount_fstab return code</span></span><br><span class="line"><span class="comment">         * and return processed return code*/</span></span><br><span class="line">        <span class="keyword">auto</span> queue_fs_result = queue_fs_event(*mount_fstab_return_code);</span><br><span class="line">        <span class="keyword">if</span> (!queue_fs_result) &#123;</span><br><span class="line">            <span class="keyword">return</span> Error() &lt;&lt; <span class="string">"queue_fs_event() failed: "</span> &lt;&lt; queue_fs_result.error();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>step1中的mount_fstab会 fork 出一个子进程调用 fs_mgr_read_fstab以及 fs_mgr_mount_all函数,前一个函数用于读取和解析fstab 文件,我们只看看我们要分析的FBE部分参数的解析:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">flag_list</span> <span class="title">mount_flags</span>[] = &#123;</span></span><br><span class="line">    &#123; <span class="string">"noatime"</span>,    MS_NOATIME &#125;,</span><br><span class="line">    &#123; <span class="string">"noexec"</span>,     MS_NOEXEC &#125;,</span><br><span class="line">    &#123; <span class="string">"nosuid"</span>,     MS_NOSUID &#125;,</span><br><span class="line">    &#123; <span class="string">"nodev"</span>,      MS_NODEV &#125;,</span><br><span class="line">    &#123; <span class="string">"nodiratime"</span>, MS_NODIRATIME &#125;,</span><br><span class="line">    &#123; <span class="string">"ro"</span>,         MS_RDONLY &#125;,</span><br><span class="line">    &#123; <span class="string">"rw"</span>,         <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"remount"</span>,    MS_REMOUNT &#125;,</span><br><span class="line">    &#123; <span class="string">"bind"</span>,       MS_BIND &#125;,</span><br><span class="line">    &#123; <span class="string">"rec"</span>,        MS_REC &#125;,</span><br><span class="line">    &#123; <span class="string">"unbindable"</span>, MS_UNBINDABLE &#125;,</span><br><span class="line">    &#123; <span class="string">"private"</span>,    MS_PRIVATE &#125;,</span><br><span class="line">    &#123; <span class="string">"slave"</span>,      MS_SLAVE &#125;,</span><br><span class="line">    &#123; <span class="string">"shared"</span>,     MS_SHARED &#125;,</span><br><span class="line">    &#123; <span class="string">"defaults"</span>,   <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="number">0</span>,            <span class="number">0</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">flag_list</span> <span class="title">fs_mgr_flags</span>[] = &#123;</span></span><br><span class="line">    &#123;<span class="string">"wait"</span>, MF_WAIT&#125;,</span><br><span class="line">    &#123;<span class="string">"check"</span>, MF_CHECK&#125;,</span><br><span class="line">    &#123;<span class="string">"encryptable="</span>, MF_CRYPT&#125;,</span><br><span class="line">    &#123;<span class="string">"forceencrypt="</span>, MF_FORCECRYPT&#125;,</span><br><span class="line">    &#123;<span class="string">"fileencryption="</span>, MF_FILEENCRYPTION&#125;,</span><br><span class="line">    &#123;<span class="string">"forcefdeorfbe="</span>, MF_FORCEFDEORFBE&#125;,</span><br><span class="line">    &#123;<span class="string">"keydirectory="</span>, MF_KEYDIRECTORY&#125;,</span><br><span class="line">    &#123;<span class="string">"nonremovable"</span>, MF_NONREMOVABLE&#125;,</span><br><span class="line">    &#123;<span class="string">"voldmanaged="</span>, MF_VOLDMANAGED&#125;,</span><br><span class="line">    &#123;<span class="string">"length="</span>, MF_LENGTH&#125;,</span><br><span class="line">    &#123;<span class="string">"recoveryonly"</span>, MF_RECOVERYONLY&#125;,</span><br><span class="line">    &#123;<span class="string">"swapprio="</span>, MF_SWAPPRIO&#125;,</span><br><span class="line">    &#123;<span class="string">"zramsize="</span>, MF_ZRAMSIZE&#125;,</span><br><span class="line">    &#123;<span class="string">"max_comp_streams="</span>, MF_MAX_COMP_STREAMS&#125;,</span><br><span class="line">    &#123;<span class="string">"verifyatboot"</span>, MF_VERIFYATBOOT&#125;,</span><br><span class="line">    &#123;<span class="string">"verify"</span>, MF_VERIFY&#125;,</span><br><span class="line">    &#123;<span class="string">"avb"</span>, MF_AVB&#125;,</span><br><span class="line">    &#123;<span class="string">"noemulatedsd"</span>, MF_NOEMULATEDSD&#125;,</span><br><span class="line">    &#123;<span class="string">"notrim"</span>, MF_NOTRIM&#125;,</span><br><span class="line">    &#123;<span class="string">"formattable"</span>, MF_FORMATTABLE&#125;,</span><br><span class="line">    &#123;<span class="string">"slotselect"</span>, MF_SLOTSELECT&#125;,</span><br><span class="line">    &#123;<span class="string">"nofail"</span>, MF_NOFAIL&#125;,</span><br><span class="line">    &#123;<span class="string">"latemount"</span>, MF_LATEMOUNT&#125;,</span><br><span class="line">    &#123;<span class="string">"reservedsize="</span>, MF_RESERVEDSIZE&#125;,</span><br><span class="line">    &#123;<span class="string">"quota"</span>, MF_QUOTA&#125;,</span><br><span class="line">    &#123;<span class="string">"eraseblk="</span>, MF_ERASEBLKSIZE&#125;,</span><br><span class="line">    &#123;<span class="string">"logicalblk="</span>, MF_LOGICALBLKSIZE&#125;,</span><br><span class="line">    &#123;<span class="string">"sysfs_path="</span>, MF_SYSFS&#125;,</span><br><span class="line">    &#123;<span class="string">"defaults"</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">flag_list</span> <span class="title">file_contents_encryption_modes</span>[] = &#123;</span></span><br><span class="line">    &#123;<span class="string">"aes-256-xts"</span>, EM_AES_256_XTS&#125;,</span><br><span class="line">    &#123;<span class="string">"speck128/256-xts"</span>, EM_SPECK_128_256_XTS&#125;,</span><br><span class="line">    &#123;<span class="string">"software"</span>, EM_AES_256_XTS&#125;, <span class="comment">/* alias for backwards compatibility */</span></span><br><span class="line">    &#123;<span class="string">"ice"</span>, EM_ICE&#125;,              <span class="comment">/* hardware-specific inline cryptographic engine */</span></span><br><span class="line">    &#123;<span class="string">"ice_wrapped_key_supported"</span>, EM_ICE_WRAPPED_KEY_SUPPORTED&#125;, <span class="comment">/* ICE engine with wrapped key support */</span></span><br><span class="line">    &#123;<span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">flag_list</span> <span class="title">file_names_encryption_modes</span>[] = &#123;</span></span><br><span class="line">    &#123;<span class="string">"aes-256-cts"</span>, EM_AES_256_CTS&#125;,</span><br><span class="line">    &#123;<span class="string">"aes-256-heh"</span>, EM_AES_256_HEH&#125;,</span><br><span class="line">    &#123;<span class="string">"speck128/256-cts"</span>, EM_SPECK_128_256_CTS&#125;,</span><br><span class="line">    &#123;<span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 我们的fstab中userdata的分区配置了fileencryption=ice</span></span><br><span class="line"><span class="comment"> * 文件内容加密使用ice</span></span><br><span class="line"><span class="comment"> * 文件名加密未指定，默认</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((fl[i].flag == MF_FILEENCRYPTION) &amp;&amp; flag_vals) &#123;</span><br><span class="line">                    <span class="comment">/* The fileencryption flag is followed by an = and</span></span><br><span class="line"><span class="comment">                     * the mode of contents encryption, then optionally a</span></span><br><span class="line"><span class="comment">                     * : and the mode of filenames encryption (defaults</span></span><br><span class="line"><span class="comment">                     * to aes-256-cts).  Get it and return it.</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">char</span> *mode = <span class="built_in">strchr</span>(p, <span class="string">'='</span>) + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">char</span> *colon = <span class="built_in">strchr</span>(mode, <span class="string">':'</span>);</span><br><span class="line">                    <span class="keyword">if</span> (colon) &#123;</span><br><span class="line">                        *colon = <span class="string">'\0'</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    flag_vals-&gt;file_contents_mode =</span><br><span class="line">                        encryption_mode_to_flag(file_contents_encryption_modes,</span><br><span class="line">                                                mode, <span class="string">"file contents"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (colon) &#123;</span><br><span class="line">                        flag_vals-&gt;file_names_mode =</span><br><span class="line">                            encryption_mode_to_flag(file_names_encryption_modes,</span><br><span class="line">                                                    colon + <span class="number">1</span>, <span class="string">"file names"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        flag_vals-&gt;file_names_mode = EM_AES_256_CTS;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>所有的参数解析完成后，调用fs_mgr_mount_all进行挂载，这里面做的事情很多，可以根据启动模式和各分区的配置参数和挂载模式挑选自己关注的部分：</p>
<p>1、ffbm模式不挂在userdata分区</p>
<p>2、由vold管理的、不属于当前挂载模式的（比如early、late模式）</p>
<p>3、不挂载raw类型的分区，如swap、emmc、mtd</p>
<p>4、不挂载根文件系统，这是引入treble框架后作出的改变。</p>
<p>5、其他的根据配置参数执行相关的操作、挂载。然后返回状态码。</p>
<p>step1中根据返回的状态码处理设置加密相关的属性、触发加密启动流程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Queue event based on fs_mgr return code.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * code: return code of fs_mgr_mount_all</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function might request a reboot, in which case it will</span></span><br><span class="line"><span class="comment"> * not return.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * return code is processed based on input code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> Result&lt;Success&gt; queue_fs_event(<span class="keyword">int</span> code) &#123;</span><br><span class="line">    <span class="keyword">if</span> (code == FS_MGR_MNTALL_DEV_NEEDS_ENCRYPTION) &#123;</span><br><span class="line">		......</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code == FS_MGR_MNTALL_DEV_NEEDS_RECOVERY) &#123;</span><br><span class="line">        <span class="comment">/* Setup a wipe via recovery, and reboot into recovery */</span></span><br><span class="line">        PLOG(ERROR) &lt;&lt; <span class="string">"fs_mgr_mount_all suggested recovery, so wiping data via recovery."</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; options = &#123;<span class="string">"--wipe_data"</span>, <span class="string">"--reason=fs_mgr_mount_all"</span> &#125;;</span><br><span class="line">        <span class="keyword">return</span> reboot_into_recovery(options);</span><br><span class="line">        <span class="comment">/* If reboot worked, there is no return. */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code == FS_MGR_MNTALL_DEV_FILE_ENCRYPTED) &#123;<span class="comment">//我们的配置走的这个分支</span></span><br><span class="line">        <span class="keyword">if</span> (e4crypt_install_keyring()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Error() &lt;&lt; <span class="string">"e4crypt_install_keyring() failed"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        property_set(<span class="string">"ro.crypto.state"</span>, <span class="string">"encrypted"</span>);</span><br><span class="line">        property_set(<span class="string">"ro.crypto.type"</span>, <span class="string">"file"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Although encrypted, we have device key, so we do not need to</span></span><br><span class="line">        <span class="comment">// do anything different from the nonencrypted case.</span></span><br><span class="line">        ActionManager::GetInstance().QueueEventTrigger(<span class="string">"nonencrypted"</span>);</span><br><span class="line">        <span class="keyword">return</span> Success();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code == FS_MGR_MNTALL_DEV_IS_METADATA_ENCRYPTED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e4crypt_install_keyring()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Error() &lt;&lt; <span class="string">"e4crypt_install_keyring() failed"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        property_set(<span class="string">"ro.crypto.state"</span>, <span class="string">"encrypted"</span>);</span><br><span class="line">        property_set(<span class="string">"ro.crypto.type"</span>, <span class="string">"file"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Although encrypted, vold has already set the device up, so we do not need to</span></span><br><span class="line">        <span class="comment">// do anything different from the nonencrypted case.</span></span><br><span class="line">        ActionManager::GetInstance().QueueEventTrigger(<span class="string">"nonencrypted"</span>);</span><br><span class="line">        <span class="keyword">return</span> Success();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code == FS_MGR_MNTALL_DEV_NEEDS_METADATA_ENCRYPTION) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e4crypt_install_keyring()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Error() &lt;&lt; <span class="string">"e4crypt_install_keyring() failed"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        property_set(<span class="string">"ro.crypto.state"</span>, <span class="string">"encrypted"</span>);</span><br><span class="line">        property_set(<span class="string">"ro.crypto.type"</span>, <span class="string">"file"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Although encrypted, vold has already set the device up, so we do not need to</span></span><br><span class="line">        <span class="comment">// do anything different from the nonencrypted case.</span></span><br><span class="line">        ActionManager::GetInstance().QueueEventTrigger(<span class="string">"nonencrypted"</span>);</span><br><span class="line">        <span class="keyword">return</span> Success();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code &gt; <span class="number">0</span>) &#123;<span class="comment">//出错</span></span><br><span class="line">        Error() &lt;&lt; <span class="string">"fs_mgr_mount_all() returned unexpected error "</span> &lt;&lt; code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* else ... &lt; 0: error */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//出错的情况会导致无法进入android，关注zygote-start触发器可知</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//出错</span></span><br><span class="line">    <span class="keyword">return</span> Error() &lt;&lt; <span class="string">"Invalid code: "</span> &lt;&lt; code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据我们的配置情况，在mount_all正常的情况下：</p>
<p>1、调用e4crypt_install_keyring函数安装 e4crypt keyring，用于存放文件加密的 key。</p>
<p>2、设置相关的属性。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">property_set(<span class="string">"ro.crypto.state"</span>, <span class="string">"encrypted"</span>);</span><br><span class="line">property_set(<span class="string">"ro.crypto.type"</span>, <span class="string">"file"</span>);</span><br></pre></td></tr></table></figure>

<p>3、触发nonencrypted，启动mian、late_start类型的服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">on nonencrypted</span><br><span class="line">    class_start main</span><br><span class="line">    class_start late_start</span><br></pre></td></tr></table></figure>

<p>接下来看看再启动zygote进程之前最关键的触发器post-fs-data，不过我们先屡一下rc开机流程的几个重要阶段触发流程。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">early-init--&gt;</span>init--&gt;late-init(我们现在所在的阶段)--&gt;fs(mount all阶段)--&gt;post-fs(系统属性加载、管理服务启动)--&gt;late-fs(early_hal阶段)--&gt;post-fs-data(这是我们关注的阶段，准备相关的工作目录)--&gt;zygote-start(zygote启动，视情况而定)--&gt;load_persist_props_action(persist属性重载、log子系统)--&gt;early-boot--&gt;boot(hal、core)</span><br></pre></td></tr></table></figure>

<h5 id="post-fs-data"><a href="#post-fs-data" class="headerlink" title="post-fs-data"></a>post-fs-data</h5><p>这个阶段做的也比较多，主要是为用户工作目录做准备，我们关注以下几点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">on post-fs-data</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    # step1：Make sure we have the device encryption key.</span><br><span class="line">    start vold</span><br><span class="line">    installkey /data</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    # step2：create basic filesystem structure</span><br><span class="line">    # 通过mkdir命令创建各种目录</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span>step3：android系统用户初始化</span><br><span class="line">    init_user0</span><br><span class="line"></span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<p>step1：因为生成秘钥需要vold进程来实现，所以先启动vold服务。然后通过installkey /data命令生成系统设备加密密钥（system DE key）。</p>
<p><img src="/2019/06/25/Android-Init-FBE/system-de-key.PNG" alt="system-de-key"></p>
<p>对于首次开机的情况下，由于相应目录还没有秘钥，所以会生成相应的秘钥文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">TB-XXXXX:/data # ls -lR unencrypted/</span><br><span class="line">unencrypted/:</span><br><span class="line">total 12</span><br><span class="line">drwx------ 2 root root 4096 1970-02-08 20:51 key</span><br><span class="line">-rw------- 1 root root   15 1970-02-10 23:21 mode</span><br><span class="line">-rw------- 1 root root    8 1970-02-10 23:21 ref</span><br><span class="line"></span><br><span class="line">unencrypted/key:</span><br><span class="line">total 32</span><br><span class="line">-rw------- 1 root root    92 1970-02-08 20:51 encrypted_key</span><br><span class="line">-rw------- 1 root root   449 1970-02-08 20:51 keymaster_key_blob</span><br><span class="line">-rw------- 1 root root 16384 1970-02-08 20:51 secdiscardable</span><br><span class="line">-rw------- 1 root root    10 1970-02-08 20:51 stretching</span><br><span class="line">-rw------- 1 root root     1 1970-02-08 20:51 version</span><br></pre></td></tr></table></figure>

<p>step2创建一些列的目录，最后又do_mkdir处理创建目录，然后调用e4crypt_set_directory_policy对目标目录设置system de 策略！</p>
<ul>
<li>加密策略应用于目录级别。</li>
<li>所有子文件夹都从顶层加密目录继承加密策略。</li>
<li>根目录“/ data”不包含任何加密策略。</li>
<li>对于不加密策略的目录可以添加到directories_to_exclude，他们的子目录可以另外指定加密策略。</li>
</ul>
<p>step3的init_user0，同样的会调用到vold service：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">binder::Status VoldNativeService::initUser0() &#123;</span><br><span class="line">    ENFORCE_UID(AID_SYSTEM);</span><br><span class="line">    ACQUIRE_CRYPT_LOCK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> translateBool(e4crypt_init_user0());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个流程跟system de key的流程类似，create_and_install_user_keys最终生成的以下信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">TB-XXXXX:/data/misc/vold/user_keys # ls -lR</span><br><span class="line">.:</span><br><span class="line">total 16</span><br><span class="line">drwx------ 3 root root 4096 1970-02-08 20:51 ce</span><br><span class="line">drwx------ 3 root root 4096 1970-02-08 20:51 de</span><br><span class="line"></span><br><span class="line">./ce:</span><br><span class="line">total 8</span><br><span class="line">drwx------ 3 root root 4096 1970-02-11 00:07 0</span><br><span class="line"></span><br><span class="line">./ce/0:</span><br><span class="line">total 8</span><br><span class="line">drwx------ 2 root root 4096 1970-02-11 00:07 current</span><br><span class="line"></span><br><span class="line">./ce/0/current:</span><br><span class="line">total 52</span><br><span class="line">-rw------- 1 root root    92 1970-02-11 00:07 encrypted_key</span><br><span class="line">-rw------- 1 root root   449 1970-02-11 00:07 keymaster_key_blob</span><br><span class="line">-rw------- 1 root root 16384 1970-02-11 00:07 secdiscardable</span><br><span class="line">-rw------- 1 root root    10 1970-02-11 00:07 stretching</span><br><span class="line">-rw------- 1 root root     1 1970-02-11 00:07 version</span><br><span class="line"></span><br><span class="line">./de:</span><br><span class="line">total 8</span><br><span class="line">drwx------ 2 root root 4096 1970-02-08 20:51 0</span><br><span class="line"></span><br><span class="line">./de/0:</span><br><span class="line">total 52</span><br><span class="line">-rw------- 1 root root    92 1970-02-08 20:51 encrypted_key</span><br><span class="line">-rw------- 1 root root   449 1970-02-08 20:51 keymaster_key_blob</span><br><span class="line">-rw------- 1 root root 16384 1970-02-08 20:51 secdiscardable</span><br><span class="line">-rw------- 1 root root    10 1970-02-08 20:51 stretching</span><br><span class="line">-rw------- 1 root root     1 1970-02-08 20:51 version</span><br></pre></td></tr></table></figure>

<p>load_all_de_keys安装所有用户的de keyring。然后调用e4crypt_prepare_user_storage准备用户0的de工作目录！对用户0的de目录添加de策略！对于CE目录的准备，注释中解释：</p>
<blockquote>
<p>我们只能在这里安全地准备DE存储，因为CE密钥可能与用户凭证纠缠在一起。 一旦安装了CE密钥，framework将始终准备CE存储。</p>
</blockquote>
<p>framework层通过调用VoldNativeService::prepareUserStorage准备用户的CE存储空间，设置对应的CE策略！</p>
<h5 id="锁屏密码"><a href="#锁屏密码" class="headerlink" title="锁屏密码"></a>锁屏密码</h5><p>以上我们知道CE空间还跟锁屏密码相关，看看vold进程的log可以知道，不管是设置还是取消锁屏密码framework都会调用vold重新生成对应用户的秘钥。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//取消锁屏密码，vold进程吐出来的log：</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.568</span>   <span class="number">409</span>   <span class="number">411</span> D vold    : e4crypt_clear_user_key_auth <span class="number">0</span> serial=<span class="number">0</span> token_present=<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.569</span>   <span class="number">409</span>   <span class="number">411</span> D vold    : e4crypt_add_user_key_auth <span class="number">0</span> serial=<span class="number">0</span> token_present=<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.569</span>   <span class="number">409</span>   <span class="number">411</span> D vold    : Skipping non-key .</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.569</span>   <span class="number">409</span>   <span class="number">411</span> D vold    : Skipping non-key ..</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.608</span>   <span class="number">409</span>   <span class="number">411</span> I vold    : List of Keymaster HALs found:</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.608</span>   <span class="number">409</span>   <span class="number">411</span> I vold    : Keymaster HAL #<span class="number">1</span>: Keymaster HAL: <span class="number">4</span> from QTI SecurityLevel: TRUSTED_ENVIRONMENT HAL: android.hardware.keymaster@<span class="number">4.0</span>::I</span><br><span class="line">KeymasterDevice/<span class="keyword">default</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.608</span>   <span class="number">409</span>   <span class="number">411</span> I vold    : Using Keymaster HAL: <span class="number">4</span> from QTI <span class="keyword">for</span> encryption.  Security level: TRUSTED_ENVIRONMENT, HAL: android.hardware.keymaster</span><br><span class="line">@<span class="number">4.0</span>::IKeymasterDevice/<span class="keyword">default</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.608</span>   <span class="number">409</span>   <span class="number">411</span> D vold    : Creating key that doesn't need auth token</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.635</span>   <span class="number">409</span>   <span class="number">411</span> D vold    : Created key: /data/misc/vold/user_keys/ce/<span class="number">0</span>/cx0000000000</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.636</span>   <span class="number">409</span>   <span class="number">422</span> D vold    : e4crypt_fixate_newest_user_key_auth <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.636</span>   <span class="number">409</span>   <span class="number">422</span> D vold    : Skipping non-key .</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.636</span>   <span class="number">409</span>   <span class="number">422</span> D vold    : Skipping non-key ..</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.636</span>   <span class="number">409</span>   <span class="number">422</span> V vold    : /system/bin/secdiscard</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.636</span>   <span class="number">409</span>   <span class="number">422</span> V vold    :     --</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.636</span>   <span class="number">409</span>   <span class="number">422</span> V vold    :     /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/encrypted_key</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.636</span>   <span class="number">409</span>   <span class="number">422</span> V vold    :     /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/secdiscardable</span><br><span class="line">02-11 15:52:13.651 15866 15866 D secdiscard: Securely discarding '/data/misc/vold/user_keys/ce/0/current/encrypted_key' unlink=1</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.651</span> <span class="number">15866</span> <span class="number">15866</span> D secdiscard: For path /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/encrypted_key block device is /dev/block/bootdevice/by-name/userdat</span><br><span class="line">a</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.657</span> <span class="number">15866</span> <span class="number">15866</span> D secdiscard: Discarded: /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/encrypted_key</span><br><span class="line">02-11 15:52:13.658 15866 15866 D secdiscard: Securely discarding '/data/misc/vold/user_keys/ce/0/current/secdiscardable' unlink=1</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.658</span> <span class="number">15866</span> <span class="number">15866</span> D secdiscard: For path /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/secdiscardable block device is /dev/block/bootdevice/by-name/userda</span><br><span class="line">ta</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.663</span> <span class="number">15866</span> <span class="number">15866</span> D secdiscard: Discarded: /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/secdiscardable</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.664</span>   <span class="number">409</span>   <span class="number">422</span> V vold    : /system/bin/rm</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.664</span>   <span class="number">409</span>   <span class="number">422</span> V vold    :     -rf</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.664</span>   <span class="number">409</span>   <span class="number">422</span> V vold    :     /data/misc/vold/user_keys/ce/<span class="number">0</span>/current</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.685</span>   <span class="number">409</span>   <span class="number">422</span> D vold    : Renaming /data/misc/vold/user_keys/ce/<span class="number">0</span>/cx0000000000 to /data/misc/vold/user_keys/ce/<span class="number">0</span>/current</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置锁屏密码，vold进程吐出来的log：</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">41.967</span>   <span class="number">409</span>   <span class="number">422</span> D vold    : e4crypt_add_user_key_auth <span class="number">0</span> serial=<span class="number">0</span> token_present=<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">41.967</span>   <span class="number">409</span>   <span class="number">422</span> D vold    : Skipping non-key .</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">41.968</span>   <span class="number">409</span>   <span class="number">422</span> D vold    : Skipping non-key ..</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">41.986</span>   <span class="number">409</span>   <span class="number">422</span> D vold    : Created key: /data/misc/vold/user_keys/ce/<span class="number">0</span>/cx0000000000</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">41.987</span>   <span class="number">409</span> <span class="number">15396</span> D vold    : e4crypt_fixate_newest_user_key_auth <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">41.987</span>   <span class="number">409</span> <span class="number">15396</span> D vold    : Skipping non-key .</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">41.987</span>   <span class="number">409</span> <span class="number">15396</span> D vold    : Skipping non-key ..</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">41.996</span>   <span class="number">409</span> <span class="number">15396</span> I vold    : List of Keymaster HALs found:</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">41.997</span>   <span class="number">409</span> <span class="number">15396</span> I vold    : Keymaster HAL #<span class="number">1</span>: Keymaster HAL: <span class="number">4</span> from QTI SecurityLevel: TRUSTED_ENVIRONMENT HAL: android.hardware.keymaster@<span class="number">4.0</span>::I</span><br><span class="line">KeymasterDevice/<span class="keyword">default</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">41.997</span>   <span class="number">409</span> <span class="number">15396</span> I vold    : Using Keymaster HAL: <span class="number">4</span> from QTI <span class="keyword">for</span> encryption.  Security level: TRUSTED_ENVIRONMENT, HAL: android.hardware.keymaster</span><br><span class="line">@<span class="number">4.0</span>::IKeymasterDevice/<span class="keyword">default</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.003</span>   <span class="number">409</span> <span class="number">15396</span> V vold    : /system/bin/secdiscard</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.003</span>   <span class="number">409</span> <span class="number">15396</span> V vold    :     --</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.003</span>   <span class="number">409</span> <span class="number">15396</span> V vold    :     /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/encrypted_key</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.003</span>   <span class="number">409</span> <span class="number">15396</span> V vold    :     /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/secdiscardable</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.003</span>   <span class="number">409</span> <span class="number">15396</span> V vold    :     /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/keymaster_key_blob</span><br><span class="line">02-11 15:52:42.019 15979 15979 D secdiscard: Securely discarding '/data/misc/vold/user_keys/ce/0/current/encrypted_key' unlink=1</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.019</span> <span class="number">15979</span> <span class="number">15979</span> D secdiscard: For path /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/encrypted_key block device is /dev/block/bootdevice/by-name/userdat</span><br><span class="line">a</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.026</span> <span class="number">15979</span> <span class="number">15979</span> D secdiscard: Discarded: /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/encrypted_key</span><br><span class="line">02-11 15:52:42.026 15979 15979 D secdiscard: Securely discarding '/data/misc/vold/user_keys/ce/0/current/secdiscardable' unlink=1</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.027</span> <span class="number">15979</span> <span class="number">15979</span> D secdiscard: For path /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/secdiscardable block device is /dev/block/bootdevice/by-name/userda</span><br><span class="line">ta</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.031</span> <span class="number">15979</span> <span class="number">15979</span> D secdiscard: Discarded: /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/secdiscardable</span><br><span class="line">02-11 15:52:42.031 15979 15979 D secdiscard: Securely discarding '/data/misc/vold/user_keys/ce/0/current/keymaster_key_blob' unlink=1</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.032</span> <span class="number">15979</span> <span class="number">15979</span> D secdiscard: For path /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/keymaster_key_blob block device is /dev/block/bootdevice/by-name/us</span><br><span class="line">erdata</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.036</span> <span class="number">15979</span> <span class="number">15979</span> D secdiscard: Discarded: /data/misc/vold/user_keys/ce/<span class="number">0</span>/current/keymaster_key_blob</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.037</span>   <span class="number">409</span> <span class="number">15396</span> V vold    : /system/bin/rm</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.037</span>   <span class="number">409</span> <span class="number">15396</span> V vold    :     -rf</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.037</span>   <span class="number">409</span> <span class="number">15396</span> V vold    :     /data/misc/vold/user_keys/ce/<span class="number">0</span>/current</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">42.057</span>   <span class="number">409</span> <span class="number">15396</span> D vold    : Renaming /data/misc/vold/user_keys/ce/<span class="number">0</span>/cx0000000000 to /data/misc/vold/user_keys/ce/<span class="number">0</span>/current</span><br></pre></td></tr></table></figure>

<p>设置完密码后，看看vold重启后的log；system de和user de存储空间会直接准备好；但是user的ce目录则需要等待用户输入正确的锁屏密码后才能unlock user key并安装keyring，进而准备ce存储目录，否则CE目录都是出于加密状态。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vold进程启动</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.268</span>   <span class="number">407</span>   <span class="number">407</span> I vold    : Vold <span class="number">3.0</span> (the awakening) firing up</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.269</span>   <span class="number">407</span>   <span class="number">407</span> V vold    : Detected support <span class="keyword">for</span>: ext4 f2fs vfat ntfs exfat</span><br><span class="line">......</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.277</span>   <span class="number">407</span>   <span class="number">407</span> D vold    : VoldNativeService::start() completed OK</span><br><span class="line"><span class="comment">//step1：system de key 创建过着检索；由于不是第一次开机，/data/unencrypted/key已经存在，所以走了检索的流程</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.279</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : e4crypt_initialize_global_de</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.280</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Key exists, <span class="keyword">using</span>: /data/unencrypted/key</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.287</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : List of Keymaster HALs found:</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.288</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Keymaster HAL #<span class="number">1</span>: Keymaster HAL: <span class="number">4</span> from QTI SecurityLevel: TRUSTED_ENVIRONMENT HAL: android.hardware.keymaster@<span class="number">4.0</span>::I</span><br><span class="line">KeymasterDevice/<span class="keyword">default</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.289</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Computing HMAC with params &#123; (seed: <span class="number">041e6</span>f8548964b3cdacfb26fd26220b4ce0fbc9fbf99ba138ebc5f3b58a1, nonce: <span class="number">7f</span>513138514f</span><br><span class="line">a98f37c5a3bb9506c83ab3086d645654040a47d1d5e4b4c) &#125;</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.289</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Computing HMAC <span class="keyword">for</span> Keymaster HAL: <span class="number">4</span> from QTI SecurityLevel: TRUSTED_ENVIRONMENT HAL: android.hardware.keymaster@<span class="number">4.0</span>::</span><br><span class="line">IKeymasterDevice/<span class="keyword">default</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.291</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Using Keymaster HAL: <span class="number">4</span> from QTI <span class="keyword">for</span> encryption.  Security level: TRUSTED_ENVIRONMENT, HAL: android.hardware.keymaster</span><br><span class="line">@<span class="number">4.0</span>::IKeymasterDevice/<span class="keyword">default</span></span><br><span class="line"><span class="comment">//install system de keyring，有三个，可以在proc/keys查到</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.297</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Added key <span class="number">675272627</span> (ext4:<span class="number">76</span>d65c6b81c41315) to keyring <span class="number">620637346</span> in process <span class="number">407</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.297</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Added key <span class="number">211396708</span> (f2fs:<span class="number">76</span>d65c6b81c41315) to keyring <span class="number">620637346</span> in process <span class="number">407</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.297</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Added key <span class="number">421647831</span> (fscrypt:<span class="number">76</span>d65c6b81c41315) to keyring <span class="number">620637346</span> in process <span class="number">407</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.299</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Wrote system DE key reference to:/data/unencrypted/ref</span><br><span class="line"><span class="comment">//step2：user0 de 目录准备</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.440</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : e4crypt_init_user0</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.440</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/misc/vold/user_keys</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.441</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/misc/vold/user_keys/ce</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.441</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/misc/vold/user_keys/de</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.449</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : List of Keymaster HALs found:</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.449</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Keymaster HAL #<span class="number">1</span>: Keymaster HAL: <span class="number">4</span> from QTI SecurityLevel: TRUSTED_ENVIRONMENT HAL: android.hardware.keymaster@<span class="number">4.0</span>::I</span><br><span class="line">KeymasterDevice/<span class="keyword">default</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.449</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Using Keymaster HAL: <span class="number">4</span> from QTI <span class="keyword">for</span> encryption.  Security level: TRUSTED_ENVIRONMENT, HAL: android.hardware.keymaster</span><br><span class="line">@<span class="number">4.0</span>::IKeymasterDevice/<span class="keyword">default</span></span><br><span class="line"><span class="comment">//install user0 de keyring，有三个，可以在proc/keys查到</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.455</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Added key <span class="number">274693618</span> (ext4:<span class="number">2b</span>f3cb2d9e23c795) to keyring <span class="number">620637346</span> in process <span class="number">407</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.455</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Added key <span class="number">865819293</span> (f2fs:<span class="number">2b</span>f3cb2d9e23c795) to keyring <span class="number">620637346</span> in process <span class="number">407</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.455</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Added key <span class="number">1035221318</span> (fscrypt:<span class="number">2b</span>f3cb2d9e23c795) to keyring <span class="number">620637346</span> in process <span class="number">407</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.455</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Installed de key <span class="keyword">for</span> user <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.455</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Skipping non-de-key .</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.455</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Skipping non-de-key ..</span><br><span class="line"><span class="comment">//准备user0的de存储目录</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.456</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : e4crypt_prepare_user_storage <span class="keyword">for</span> volume null, user <span class="number">0</span>, serial <span class="number">0</span>, flags <span class="number">1</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.456</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/system/users/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.456</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/misc/profiles/cur/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.456</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/system_de/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.457</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/misc_de/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.458</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/vendor_de/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.458</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/user_de/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.459</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Found policy <span class="number">2b</span>f3cb2d9e23c795 at /data/system_de/<span class="number">0</span> which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.459</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Found policy <span class="number">2b</span>f3cb2d9e23c795 at /data/misc_de/<span class="number">0</span> which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.460</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Found policy <span class="number">2b</span>f3cb2d9e23c795 at /data/vendor_de/<span class="number">0</span> which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.461</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Found policy <span class="number">2b</span>f3cb2d9e23c795 at /data/user_de/<span class="number">0</span> which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.461</span>   <span class="number">407</span>   <span class="number">411</span> V vold    : /system/bin/vold_prepare_subdirs</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.461</span>   <span class="number">407</span>   <span class="number">411</span> V vold    :     prepare</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.461</span>   <span class="number">407</span>   <span class="number">411</span> V vold    :</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.461</span>   <span class="number">407</span>   <span class="number">411</span> V vold    :     <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">25.461</span>   <span class="number">407</span>   <span class="number">411</span> V vold    :     <span class="number">1</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">34.840</span>  <span class="number">1144</span>  <span class="number">1203</span> I ActivityManager: Force stopping com.android.providers.media appid=<span class="number">10022</span> user=<span class="number">-1</span>: vold reset</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">34.845</span>   <span class="number">407</span>   <span class="number">411</span> V vold    : Waiting <span class="keyword">for</span> FUSE to spin up...</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">34.895</span>   <span class="number">407</span>   <span class="number">411</span> V vold    : Waiting <span class="keyword">for</span> FUSE to spin up...</span><br><span class="line"><span class="comment">//到此system de和用户的de存储都准备好了，可以直接访问；但是ce目录通过adb进去看的话都是一些加密过的文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//输入锁屏密码后，e4crypt_unlock_user_key解锁user key的流程</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.617</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : e4crypt_unlock_user_key <span class="number">0</span> serial=<span class="number">0</span> token_present=<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.618</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Skipping non-key .</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.618</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Skipping non-key ..</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.618</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Trying user CE key /data/misc/vold/user_keys/ce/<span class="number">0</span>/current</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.626</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Successfully retrieved key</span><br><span class="line"><span class="comment">//install user0 ceeyring，有三个，可以在proc/keys查到</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.626</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Added key <span class="number">981453030</span> (ext4:c9d5441196d5c55c) to keyring <span class="number">620637346</span> in process <span class="number">407</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.626</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Added key <span class="number">401104992</span> (f2fs:c9d5441196d5c55c) to keyring <span class="number">620637346</span> in process <span class="number">407</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.626</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Added key <span class="number">893572951</span> (fscrypt:c9d5441196d5c55c) to keyring <span class="number">620637346</span> in process <span class="number">407</span></span><br><span class="line"><span class="comment">//read_and_install_user_ce_key流程</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.626</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Installed ce key <span class="keyword">for</span> user <span class="number">0</span></span><br><span class="line"><span class="comment">//准备user0的ce存储目录</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.631</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : e4crypt_prepare_user_storage <span class="keyword">for</span> volume null, user <span class="number">0</span>, serial <span class="number">0</span>, flags <span class="number">2</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.631</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/system_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.632</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/misc_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.632</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/vendor_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.650</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/media/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.651</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Preparing: /data/data</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.652</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Found policy c9d5441196d5c55c at /data/system_ce/<span class="number">0</span> which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.655</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Found policy c9d5441196d5c55c at /data/misc_ce/<span class="number">0</span> which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.656</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Policy <span class="keyword">for</span> /data/vendor_ce/<span class="number">0</span> <span class="built_in">set</span> to c9d5441196d5c55c modes <span class="number">127</span>/<span class="number">4</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.657</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Found policy c9d5441196d5c55c at /data/media/<span class="number">0</span> which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.657</span>   <span class="number">407</span>   <span class="number">411</span> I vold    : Found policy c9d5441196d5c55c at /data/data which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.657</span>   <span class="number">407</span>   <span class="number">411</span> V vold    : Starting restorecon of /data/system_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.664</span>   <span class="number">407</span>   <span class="number">411</span> V vold    : Finished restorecon of /data/system_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.664</span>   <span class="number">407</span>   <span class="number">411</span> V vold    : Starting restorecon of /data/misc_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.674</span>   <span class="number">407</span>   <span class="number">411</span> V vold    : Finished restorecon of /data/misc_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.674</span>   <span class="number">407</span>   <span class="number">411</span> V vold    : /system/bin/vold_prepare_subdirs</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.674</span>   <span class="number">407</span>   <span class="number">411</span> V vold    :     prepare</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.674</span>   <span class="number">407</span>   <span class="number">411</span> V vold    :</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.674</span>   <span class="number">407</span>   <span class="number">411</span> V vold    :     <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.674</span>   <span class="number">407</span>   <span class="number">411</span> V vold    :     <span class="number">2</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.710</span>   <span class="number">407</span>   <span class="number">411</span> I vold_prepare_subdirs: SELinux: Loaded file_contexts</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.718</span>  <span class="number">2271</span>  <span class="number">2271</span> D vold_prepare_subdirs: Setting up mode <span class="number">700</span> uid <span class="number">0</span> gid <span class="number">0</span> context u:object_r:vold_data_file:s0 on path: /data/misc_ce/<span class="number">0</span>/vold</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">15.721</span>  <span class="number">2271</span>  <span class="number">2271</span> D vold_prepare_subdirs: Setting up mode <span class="number">700</span> uid <span class="number">0</span> gid <span class="number">0</span> context u:object_r:storaged_data_file:s0 on path: /data/misc_ce/<span class="number">0</span>/storage</span><br><span class="line">d</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">16.455</span>   <span class="number">407</span>   <span class="number">411</span> D vold    : Linking /storage/emulated/<span class="number">0</span> to /mnt/user/<span class="number">0</span>/primary</span><br></pre></td></tr></table></figure>

<p>对于没有设置锁屏密码的情况下，重启则不需要用户输入锁屏密码；直接可以准备CE存储空间：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.915</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : e4crypt_unlock_user_key <span class="number">0</span> serial=<span class="number">0</span> token_present=<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.918</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Skipping non-key .</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.918</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Skipping non-key ..</span><br><span class="line"><span class="comment">//这里是关键log，unlockUserKey直接返回</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.918</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Trying user CE key /data/misc/vold/user_keys/ce/<span class="number">0</span>/current</span><br><span class="line"><span class="comment">//read_and_install_user_ce_key流程</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.934</span>   <span class="number">409</span>   <span class="number">413</span> I vold    : List of Keymaster HALs found:</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.934</span>   <span class="number">409</span>   <span class="number">413</span> I vold    : Keymaster HAL #<span class="number">1</span>: Keymaster HAL: <span class="number">4</span> from QTI SecurityLevel: TRUSTED_ENVIRONMENT HAL: android.hardware.keymaster@<span class="number">4.0</span>::I</span><br><span class="line">KeymasterDevice/<span class="keyword">default</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.934</span>   <span class="number">409</span>   <span class="number">413</span> I vold    : Using Keymaster HAL: <span class="number">4</span> from QTI <span class="keyword">for</span> encryption.  Security level: TRUSTED_ENVIRONMENT, HAL: android.hardware.keymaster</span><br><span class="line">@<span class="number">4.0</span>::IKeymasterDevice/<span class="keyword">default</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.945</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Successfully retrieved key</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.945</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Added key <span class="number">23416353</span> (ext4:c9d5441196d5c55c) to keyring <span class="number">630589285</span> in process <span class="number">409</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.945</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Added key <span class="number">18026457</span> (f2fs:c9d5441196d5c55c) to keyring <span class="number">630589285</span> in process <span class="number">409</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.945</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Added key <span class="number">778304405</span> (fscrypt:c9d5441196d5c55c) to keyring <span class="number">630589285</span> in process <span class="number">409</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.945</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Installed ce key <span class="keyword">for</span> user <span class="number">0</span></span><br><span class="line"><span class="comment">//user ce存储准备</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.947</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : e4crypt_prepare_user_storage <span class="keyword">for</span> volume null, user <span class="number">0</span>, serial <span class="number">0</span>, flags <span class="number">2</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.947</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Preparing: /data/system_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.947</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Preparing: /data/misc_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.947</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Preparing: /data/vendor_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.949</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Preparing: /data/media/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.950</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Preparing: /data/data</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.951</span>   <span class="number">409</span>   <span class="number">413</span> I vold    : Found policy c9d5441196d5c55c at /data/system_ce/<span class="number">0</span> which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.960</span>   <span class="number">409</span>   <span class="number">413</span> I vold    : Found policy c9d5441196d5c55c at /data/misc_ce/<span class="number">0</span> which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.961</span>   <span class="number">409</span>   <span class="number">413</span> I vold    : Policy <span class="keyword">for</span> /data/vendor_ce/<span class="number">0</span> <span class="built_in">set</span> to c9d5441196d5c55c modes <span class="number">127</span>/<span class="number">4</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.961</span>   <span class="number">409</span>   <span class="number">413</span> I vold    : Found policy c9d5441196d5c55c at /data/media/<span class="number">0</span> which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.962</span>   <span class="number">409</span>   <span class="number">413</span> I vold    : Found policy c9d5441196d5c55c at /data/data which matches expected value</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">08.962</span>   <span class="number">409</span>   <span class="number">413</span> V vold    : Starting restorecon of /data/system_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.011</span>   <span class="number">409</span>   <span class="number">413</span> V vold    : Finished restorecon of /data/system_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.011</span>   <span class="number">409</span>   <span class="number">413</span> V vold    : Starting restorecon of /data/misc_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.060</span>   <span class="number">409</span>   <span class="number">413</span> V vold    : Finished restorecon of /data/misc_ce/<span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.060</span>   <span class="number">409</span>   <span class="number">413</span> V vold    : /system/bin/vold_prepare_subdirs</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.060</span>   <span class="number">409</span>   <span class="number">413</span> V vold    :     prepare</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.060</span>   <span class="number">409</span>   <span class="number">413</span> V vold    :</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.060</span>   <span class="number">409</span>   <span class="number">413</span> V vold    :     <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.060</span>   <span class="number">409</span>   <span class="number">413</span> V vold    :     <span class="number">2</span></span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.100</span>   <span class="number">409</span>   <span class="number">413</span> I vold_prepare_subdirs: SELinux: Loaded file_contexts</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.106</span>  <span class="number">1967</span>  <span class="number">1967</span> D vold_prepare_subdirs: Setting up mode <span class="number">700</span> uid <span class="number">0</span> gid <span class="number">0</span> context u:object_r:vold_data_file:s0 on path: /data/misc_ce/<span class="number">0</span>/vold</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.109</span>  <span class="number">1967</span>  <span class="number">1967</span> D vold_prepare_subdirs: Setting up mode <span class="number">700</span> uid <span class="number">0</span> gid <span class="number">0</span> context u:object_r:storaged_data_file:s0 on path: /data/misc_ce/<span class="number">0</span>/storage</span><br><span class="line">d</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">17</span>:<span class="number">04</span>:<span class="number">09.984</span>   <span class="number">409</span>   <span class="number">413</span> D vold    : Linking /storage/emulated/<span class="number">0</span> to /mnt/user/<span class="number">0</span>/primary</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>现在除了FBE，还有Metadata Encryption (ME)，google不强制要求ME。关于加密这块涉及到加密相关的专业算法、内核kering框架和其他底层实现（平台厂商的算法、keymaster等具体实现），很复杂就不深入学习了。关于锁屏密码这块涉及到framework相关流程设计，细节也没有深入学习过，就不做整理了。这里只是简单的整理了FBE在开机过程的基本流程。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/06/25/Android-Init-FBE/" data-id="cjzva4h2v002e6giiu72foumm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/学习/">学习</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/07/01/gdb_coredump_using/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Android平台上使用coredump+gdb
        
      </div>
    </a>
  
  
    <a href="/2019/06/15/Linux-system-ipc/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Linux进程间通信机制</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AIDL/">AIDL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HIDL/">HIDL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/driver/">driver</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习/">学习</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/实战/">实战</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/稳定性/">稳定性</a><span class="tag-list-count">8</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AIDL/" style="font-size: 10px;">AIDL</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/HIDL/" style="font-size: 10px;">HIDL</a> <a href="/tags/Linux/" style="font-size: 17.5px;">Linux</a> <a href="/tags/driver/" style="font-size: 10px;">driver</a> <a href="/tags/学习/" style="font-size: 20px;">学习</a> <a href="/tags/实战/" style="font-size: 12.5px;">实战</a> <a href="/tags/稳定性/" style="font-size: 12.5px;">稳定性</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/08/26/ARMv8-linux-spinlock-understanding/">Linux spinlock的底层实现</a>
          </li>
        
          <li>
            <a href="/2019/08/01/Arm-linux-exception-flows/">Linux-ARMv8异常相关知识</a>
          </li>
        
          <li>
            <a href="/2019/07/20/Android-gdb-extract-logs/">Android9.0 logd进程空间提取日志信息</a>
          </li>
        
          <li>
            <a href="/2019/07/15/Android-booting-time-spent/">Android开机时间分析</a>
          </li>
        
          <li>
            <a href="/2019/07/10/a-intentresolver-cts-issue/">关于IntentResolver的一个cts问题</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 JoyYoung<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>