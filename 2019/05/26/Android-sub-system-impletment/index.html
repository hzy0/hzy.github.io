<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>实现一个简单的android子系统 | JoyYoung&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="实现一个简单的android子系统,app通过api调用framework服务控制gpio口">
<meta name="keywords" content="学习,Android,AIDL">
<meta property="og:type" content="article">
<meta property="og:title" content="实现一个简单的android子系统">
<meta property="og:url" content="http://yoursite.com/2019/05/26/Android-sub-system-impletment/index.html">
<meta property="og:site_name" content="JoyYoung&#39;s blog">
<meta property="og:description" content="实现一个简单的android子系统,app通过api调用framework服务控制gpio口">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-05-19T14:21:37.840Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="实现一个简单的android子系统">
<meta name="twitter:description" content="实现一个简单的android子系统,app通过api调用framework服务控制gpio口">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JoyYoung&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Android-sub-system-impletment" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/26/Android-sub-system-impletment/" class="article-date">
  <time datetime="2019-05-26T15:00:00.000Z" itemprop="datePublished">2019-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      实现一个简单的android子系统
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a><strong>背景</strong></h2><p>为了对android系统有一个基本的了解，之前在android N上实现了一个控制gpio口的子系统。包括了app、  framework api、frameworks服务和hal层的实现。虽然android O之后google引入了treable框架让所有system和vendor分离。但是，这个例子对理解android系统依然是有用的。之前没有写成文档，趁这段时间有点空整理一下。实现一个子系统需要对以下知识点有一个基本的了解和掌握：</p>
<ul>
<li>内核驱动：本试验利用linux内核的gpio驱动框架暴露到sys文件系统的借口实现对gpio口的控制。</li>
<li>HAL动态库：具体模块hal层的实现都是被编译成so库，在模块服务初始化的时候动态加载的。android定义了一些规范。</li>
<li>JNI 全称 Java Native Interface，Java 本地化接口。可以通过 JNI 调用系统提供的 API；用来实现Java代码与本地的C/C++代码进行交互。</li>
<li>AIDL：即 Android Interface Definition Language，Android接口定义语言，是用于定义服务器和客户端通信接口的一种描述语言，可以拿来生成用于IPC的代码。AIDL其实是为了避免我们重复编写代码而出现的一个模板，通过AIDL，可以在一个进程中获取另一个进程的数据和调用其暴露出来的方法，从而满足进程间通信的需求。通常，暴露方法给其他应用进行调用的应用称为服务端，调用其他应用的方法的应用称为客户端，客户端通过绑定服务端的Service来进行交互。其核心依赖于底层binder驱动。</li>
<li>Native服务：作为后台进程常驻内存，往下加载hal动态库，往上通过aidl暴露接口给客户端使用。</li>
<li>API：相android的sdk，提供客户端调用服务段的通用接口。同样依赖aidl。</li>
<li>SElinux：MAC权限控制，我们需要为服务和客户端配置相关权限。</li>
<li>init脚本：服务的启动需要用到。</li>
</ul>
<h2 id="HAL实现"><a href="#HAL实现" class="headerlink" title="HAL实现"></a><strong>HAL实现</strong></h2><h4 id="so库"><a href="#so库" class="headerlink" title="so库"></a>so库</h4><p>我们的例子是控制gpio口，用户空间控制gpio口主要通过内核暴露出来的/sys/class/gpio/，我们可以通过它来申请gpio资源、配置和控制目标gpio口；详细可自行搜索相关资料。</p>
<p>添加hal通用声明，hardware/libhardware/include/hardware/gpios.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2008 The Android Open Source Project</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ANDROID_GPIOS_INTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ANDROID_GPIOS_INTERFACE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/cdefs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/hardware.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__BEGIN_DECLS</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The id of this module</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GPIOS_HARDWARE_MODULE_ID <span class="meta-string">"gpios"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Header file version.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GPIOS_HEADER_VERSION   1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GPIOS_DEVICE_API_VERSION_1_0   HARDWARE_DEVICE_API_VERSION_2(1, 0, GPIOS_HEADER_VERSION)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GPIOS_DEVICE_API_VERSION_2_0   HARDWARE_DEVICE_API_VERSION_2(2, 0, GPIOS_HEADER_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GPIO_DIR_IN  <span class="meta-string">"in"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GPIO_DIR_OUT  <span class="meta-string">"out"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The parameters that can be set for a given gpio.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">enum</span> Value &#123;</span><br><span class="line">    GPIO_LOW,</span><br><span class="line">    GPIO_HIGH,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> Direction &#123;</span><br><span class="line">    GPIO_IN,</span><br><span class="line">    GPIO_OUT,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> ResultCode &#123;</span><br><span class="line">    SUCCESS,</span><br><span class="line">    FAILURE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_device_t</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hw_device_t</span> <span class="title">common</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * read value of the provided gpio .</span></span><br><span class="line"><span class="comment">     * gpioList to store map of gpios</span></span><br><span class="line"><span class="comment">     * Returns: lenth of gpio list on succes, error code on failure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> (*listGpio)(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; **gpioList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * read value of the provided gpio .</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Returns: value on succes, error code on failure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> (*readGpio)(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * set value to the provided gpio .</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Returns: 0 on succes, error code on failure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> (*writeGpio)(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName, Value val);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * read driction of the provided gpio .</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Returns: 0 on succes, error code on failure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> (*getGpioDriction)(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * set direction to the provided gpio .</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Returns: 0 on succes, error code on failure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> (*setGpioDriction)(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName, Direction dir);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__END_DECLS</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// ANDROID_GPIO_INTERFACE_H</span></span></span><br></pre></td></tr></table></figure>

<p>hal代码实现hardware/libhardware/modules/gpio/gpio_hal.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2013 The Android Open Source Project</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gpio_hal.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"gpio_hal.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_NDEBUG 1</span></span><br><span class="line"><span class="comment">//#define GPIO_HAL_DEBUG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * gpio control node</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GPIO_BASE_PATH  <span class="meta-string">"/sys/class/gpio/"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GPIO_LENGTH  <span class="meta-string">"/sys/class/gpio/"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> <span class="keyword">const</span>*<span class="keyword">const</span> DIR_GPIO_FILE</span><br><span class="line">        = <span class="string">"/sys/class/gpio/%s/direction"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> <span class="keyword">const</span>*<span class="keyword">const</span> VAL_GPIO_FILE</span><br><span class="line">        = <span class="string">"/sys/class/gpio/%s/value"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> THE_CONTROLLER[] = <span class="string">"gpiochip"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> gpios_list_len = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; *gpio_list = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_path</span><span class="params">(<span class="keyword">char</span>* path, <span class="keyword">char</span>* value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">    fd = open(path, O_WRONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">ssize_t</span> amt = write(fd, value, <span class="built_in">strlen</span>(value));</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> amt == <span class="number">-1</span> ? -errno : <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        SLOGE(<span class="string">"open %s failed (%s)"</span>, path, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> -errno;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_path</span><span class="params">(<span class="keyword">char</span>* path, <span class="keyword">char</span>* value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">    fd = open(path, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">ssize_t</span> amt = read(fd, value, <span class="number">8</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> amt == <span class="number">-1</span> ? -errno : <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        SLOGE(<span class="string">"open %s failed (%s)"</span>, path, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> -errno;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getControllerNgpio</span><span class="params">(<span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">char</span> openfile[PATH_MAX];</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(openfile, <span class="keyword">sizeof</span>(openfile), <span class="string">"/sys/class/gpio/%s/ngpio"</span>, name);</span><br><span class="line">    fd = open(openfile, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        SLOGE(<span class="string">"open %s failed (%s)"</span>, openfile, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> errno;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(fd, buf, <span class="keyword">sizeof</span>(buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> errno;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> atoi(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">checkGpioUseful</span><span class="params">(<span class="keyword">int</span> gpioNum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">char</span> openfile[PATH_MAX];</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(openfile, <span class="keyword">sizeof</span>(openfile), <span class="string">"/sys/class/gpio/gpio%d"</span>, gpioNum);</span><br><span class="line">    <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">"%d"</span>, gpioNum);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">"/sys/class/gpio/export"</span>, O_WRONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        SLOGE(<span class="string">"%s:open failed (%s)"</span>, __func__, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    write(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(access(openfile, F_OK) != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * module methods</span></span><br><span class="line"><span class="comment"> * function : get a list of gpios that can be exported on device</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">module_listGpio</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; **gpioList)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DIR* dir;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span>* <span class="title">de</span>;</span></span><br><span class="line">    <span class="keyword">char</span> openfile[PATH_MAX], name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">int</span> ngpio, base;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (gpio_list != <span class="literal">nullptr</span> &amp;&amp; gpios_list_len != <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        SLOGD(<span class="string">"%s: Already have the list of gpios"</span>, __FUNCTION__);</span><br><span class="line">        *gpioList = gpio_list;</span><br><span class="line">        <span class="keyword">return</span> gpios_list_len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gpio_list = <span class="keyword">new</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(dir = opendir(GPIO_BASE_PATH))) </span><br><span class="line">    &#123;</span><br><span class="line">        SLOGE(<span class="string">"opendir failed (%s)"</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> errno;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> gpioName;</span><br><span class="line">    <span class="keyword">while</span> ((de = readdir(dir))) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strncmp</span>(de-&gt;d_name,THE_CONTROLLER,<span class="built_in">strlen</span>(THE_CONTROLLER)))</span><br><span class="line">        &#123;</span><br><span class="line">            SLOGD(<span class="string">"%s is not gpios controller, continue..."</span>, de-&gt;d_name);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        base = atoi(de-&gt;d_name + <span class="built_in">strlen</span>(THE_CONTROLLER));</span><br><span class="line">        ngpio = getControllerNgpio(de-&gt;d_name);</span><br><span class="line">        SLOGD(<span class="string">"get %s controller gpios,base = %d,ngpio = %d"</span>, de-&gt;d_name, base, ngpio);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = base; i &lt; (base + ngpio); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkGpioUseful(i))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(name, <span class="number">0</span>, <span class="keyword">sizeof</span>(name));</span><br><span class="line">                <span class="built_in">snprintf</span>(name, <span class="keyword">sizeof</span>(name), <span class="string">"gpio%d"</span>, i);</span><br><span class="line">                gpioName = name;</span><br><span class="line">                gpio_list-&gt;push_back(gpioName);</span><br><span class="line">                gpios_list_len ++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    closedir(dir);</span><br><span class="line"></span><br><span class="line">    *gpioList = gpio_list;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> GPIO_HAL_DEBUG</span></span><br><span class="line">    SLOGD(<span class="string">"%s: gpios_list_len = %d, gpio_list = %p"</span>, __FUNCTION__, gpios_list_len, gpio_list);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;::iterator it = gpio_list-&gt;begin(); it != gpio_list-&gt;end(); it++) &#123;</span><br><span class="line">        SLOGD(<span class="string">"%s: gpioNmae = %s"</span>, __FUNCTION__, it-&gt;c_str());</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> gpios_list_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * module methods</span></span><br><span class="line"><span class="comment"> * function : get direction of provied gpioName</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">module_getGpioDriction</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> val[<span class="number">8</span>] = &#123;<span class="number">0</span>&#125;, path[PATH_MAX];</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), DIR_GPIO_FILE, gpioName.c_str());</span><br><span class="line">    <span class="comment">//SLOGD("%s:1 length,val = %u,%s", __FUNCTION__, strlen(val), val);</span></span><br><span class="line">    ret = read_path(path, val);</span><br><span class="line">    <span class="comment">//SLOGD("%s:2 length,val = %u,%s", __FUNCTION__, strlen(val), val);</span></span><br><span class="line">    <span class="keyword">return</span> ret != <span class="number">0</span> ? ret : <span class="number">0</span> == <span class="built_in">strncmp</span>(GPIO_DIR_IN,val,<span class="built_in">strlen</span>(GPIO_DIR_IN)) ? GPIO_IN : GPIO_OUT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * module methods</span></span><br><span class="line"><span class="comment"> * function : get direction of provied gpioName</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">module_setGpioDriction</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName, Direction dir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> val[<span class="number">8</span>], path[PATH_MAX];</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), DIR_GPIO_FILE, gpioName.c_str());</span><br><span class="line">    <span class="built_in">snprintf</span>(val, <span class="keyword">sizeof</span>(val), <span class="string">"%s"</span>, dir == GPIO_IN ? GPIO_DIR_IN : GPIO_DIR_OUT);</span><br><span class="line">    ret = write_path(path, val);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * module methods</span></span><br><span class="line"><span class="comment"> * function : get direction of provied gpioName</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">module_readGpio</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> val[<span class="number">8</span>], path[PATH_MAX];</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), VAL_GPIO_FILE, gpioName.c_str());</span><br><span class="line">    ret = read_path(path, val);</span><br><span class="line">    <span class="keyword">return</span> ret != <span class="number">0</span> ? ret : atoi(val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * module methods</span></span><br><span class="line"><span class="comment"> * function : get direction of provied gpioName</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">module_writeGpio</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName, Value val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">8</span>], path[PATH_MAX];</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), VAL_GPIO_FILE, gpioName.c_str());</span><br><span class="line">    <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">"%d"</span>, val);</span><br><span class="line">    ret = write_path(path, buf);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * module methods</span></span><br><span class="line"><span class="comment"> * function : Close the gpios device</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">close_gpios</span><span class="params">(struct <span class="keyword">gpio_device_t</span> *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dev) &#123;</span><br><span class="line">        <span class="built_in">free</span>(dev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * module methods</span></span><br><span class="line"><span class="comment"> * function : Open a new instance of a gpios device using name</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">open_gpios</span><span class="params">(<span class="keyword">const</span> struct <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>, <span class="keyword">char</span> <span class="keyword">const</span>* name,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct <span class="keyword">hw_device_t</span>** device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gpio_device_t</span> *<span class="title">dev</span> = (<span class="title">struct</span> <span class="title">gpio_device_t</span>*)<span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">gpio_device_t</span>));</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> == name)</span><br><span class="line">    &#123;</span><br><span class="line">        SLOGE(<span class="string">"must give a special module name"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!dev)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(dev, <span class="number">0</span>, <span class="keyword">sizeof</span>(*dev));</span><br><span class="line"></span><br><span class="line">    dev-&gt;common.tag = HARDWARE_DEVICE_TAG;</span><br><span class="line">    dev-&gt;common.version = GPIOS_DEVICE_API_VERSION_2_0;</span><br><span class="line">    dev-&gt;common.<span class="keyword">module</span> = (struct <span class="keyword">hw_module_t</span>*)<span class="keyword">module</span>;</span><br><span class="line">    dev-&gt;common.close = (<span class="keyword">int</span> (*)(struct <span class="keyword">hw_device_t</span>*))close_gpios;</span><br><span class="line">    dev-&gt;listGpio = module_listGpio;</span><br><span class="line">    dev-&gt;readGpio = module_readGpio;</span><br><span class="line">    dev-&gt;writeGpio = module_writeGpio;</span><br><span class="line">    dev-&gt;getGpioDriction = module_getGpioDriction;</span><br><span class="line">    dev-&gt;setGpioDriction = module_setGpioDriction;</span><br><span class="line"></span><br><span class="line">    *device = (struct <span class="keyword">hw_device_t</span>*)dev;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_methods_t</span> <span class="title">gpios_module_methods</span> = &#123;</span></span><br><span class="line">    .open =  open_gpios,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The gpios Module</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hw_module_t</span> <span class="title">HAL_MODULE_INFO_SYM</span> = &#123;</span></span><br><span class="line">    .tag = HARDWARE_MODULE_TAG,</span><br><span class="line">    .version_major = <span class="number">1</span>,</span><br><span class="line">    .version_minor = <span class="number">0</span>,</span><br><span class="line">    .id = GPIOS_HARDWARE_MODULE_ID,</span><br><span class="line">    .name = <span class="string">"gpios Module"</span>,</span><br><span class="line">    .author = <span class="string">"LongCheer, Inc."</span>,</span><br><span class="line">    .methods = &amp;gpios_module_methods,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>编译脚本Android.mk</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Copyright (C) 2013 The Android Open-Source Project</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"></span><br><span class="line">LOCAL_MODULE := gpios.<span class="variable">$(TARGET_BOARD_PLATFORM)</span> </span><br><span class="line"><span class="comment">#gpio.$(TARGET_DEVICE)</span></span><br><span class="line"></span><br><span class="line">LOCAL_MODULE_RELATIVE_PATH := hw</span><br><span class="line">LOCAL_PROPRIETARY_MODULE := true</span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES := \</span><br><span class="line">    gpio_hal.cpp \</span><br><span class="line"></span><br><span class="line">LOCAL_SHARED_LIBRARIES := \</span><br><span class="line">    libcutils \</span><br><span class="line">    libdl \</span><br><span class="line">    liblog \</span><br><span class="line">    libutils \</span><br><span class="line"></span><br><span class="line"><span class="comment">#LOCAL_STRIP_MODULE := false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_SHARED_LIBRARY)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(<span class="built_in">call</span> all-makefiles-under, <span class="variable">$(LOCAL_PATH)</span>)</span></span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>hal的so库有了，写一个程序测试下so库加载和调用，hardware/libhardware/modules/gpio/haltest/main.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/gpios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/hardware.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">hw_module_t</span>* mGpioModule = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gpio_device_t</span>* <span class="title">mGpioDevice</span> = <span class="title">nullptr</span>;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; *gpios = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> targetGpio = <span class="string">"gpio1"</span>;</span><br><span class="line">    <span class="keyword">int</span> dir, val, ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> err = hw_get_module(GPIOS_HARDWARE_MODULE_ID,(<span class="keyword">hw_module_t</span> <span class="keyword">const</span>**)&amp;mGpioModule);</span><br><span class="line">    ALOGE_IF(err,<span class="string">"couldn't load %s module (%s)"</span>, GPIOS_HARDWARE_MODULE_ID,strerror(-err));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (mGpioModule) &#123;</span><br><span class="line">        err = mGpioModule-&gt;methods-&gt;open(mGpioModule, GPIOS_HARDWARE_MODULE_ID, (struct <span class="keyword">hw_device_t</span>**)&amp;mGpioDevice);</span><br><span class="line">        ALOGE_IF(err,<span class="string">"couldn't open device for module %s module (%s)"</span>, GPIOS_HARDWARE_MODULE_ID,strerror(-err));</span><br><span class="line">        <span class="keyword">if</span> (mGpioDevice) &#123;</span><br><span class="line">            err = mGpioDevice-&gt;listGpio(&amp;gpios);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;::iterator it = gpios-&gt;begin(); it != gpios-&gt;end(); it++) &#123;</span><br><span class="line">                ALOGD(<span class="string">"%s: TEST gpioNmae = %s"</span>, __FUNCTION__, it-&gt;c_str());</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            dir = mGpioDevice-&gt;getGpioDriction(targetGpio);</span><br><span class="line">            val = mGpioDevice-&gt;readGpio(targetGpio);</span><br><span class="line">            ALOGD(<span class="string">"%s: TEST1 gpioNmae = %s,dir = %d,val=%d"</span>, __FUNCTION__, targetGpio.c_str(), dir, val);</span><br><span class="line">            ret = mGpioDevice-&gt;setGpioDriction(targetGpio, GPIO_OUT);</span><br><span class="line">            ret = mGpioDevice-&gt;writeGpio(targetGpio, GPIO_HIGH);</span><br><span class="line"></span><br><span class="line">            dir = mGpioDevice-&gt;getGpioDriction(targetGpio);</span><br><span class="line">            val = mGpioDevice-&gt;readGpio(targetGpio);</span><br><span class="line">            ALOGD(<span class="string">"%s: TEST2 gpioNmae = %s,dir = %d,val=%d"</span>, __FUNCTION__, targetGpio.c_str(), dir, val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译脚本，Android.mk</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH:= <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"></span><br><span class="line">LOCAL_MODULE:= gpioTest</span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES:= main.cpp</span><br><span class="line"></span><br><span class="line">LOCAL_SHARED_LIBRARIES := \</span><br><span class="line">    libcutils \</span><br><span class="line">    liblog \</span><br><span class="line">    libhardware \</span><br><span class="line"></span><br><span class="line">LOCAL_CLANG  := true</span><br><span class="line"></span><br><span class="line"><span class="comment">#GRANDFATHERED_USER_MODULES += $(LOCAL_MODULE)</span></span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_EXECUTABLE)</span></span><br></pre></td></tr></table></figure>

<h2 id="Native-Service"><a href="#Native-Service" class="headerlink" title="Native Service"></a>Native Service</h2><h4 id="aidl"><a href="#aidl" class="headerlink" title="aidl"></a>aidl</h4><p>申明接口frameworks/native/services/gpiomanager/aidl/android/gpios/IGpioService.aidl</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package android.gpios;</span><br><span class="line"></span><br><span class="line">interface IGpioService</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getInt</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getGpioList</span><span class="params">(out List&lt;String&gt; output)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getGpioDir</span><span class="params">(String gpioName)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">setGpioDir</span><span class="params">(String gpioName, <span class="keyword">int</span> dir)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">readGpioVal</span><span class="params">(String gpioName)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">writeGpioVal</span><span class="params">(String gpioName, <span class="keyword">int</span> val)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h4><p>对hal层的操作封装成GpioDevice类，服务的binder实体封装成GpioService类。</p>
<p>frameworks/native/services/gpiomanager/GpioDevice.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ANDROID_GPIO_DEVICE_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __ANDROID_GPIO_DEVICE_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Singleton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/gpios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/hardware.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#define LOCAL_DEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> android &#123;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GpioDevice</span> :</span> </span><br><span class="line">    <span class="keyword">public</span> Singleton&lt;GpioDevice&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">status_t</span> initCheck() <span class="keyword">const</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;* getGpioList();</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getGpioDir</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">setGpioDir</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName, Direction dir)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">readGpioVal</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">writeGpioVal</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName, Value val)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    GpioDevice();</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span>&lt;GpioDevice&gt;;</span></span><br><span class="line">    <span class="keyword">hw_module_t</span>* mGpioModule;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gpio_device_t</span>* <span class="title">mGpioDevice</span>;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; *mGpios;</span><br><span class="line">		</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>frameworks/native/services/gpiomanager/GpioDevice.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"GpioDevice.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> android &#123;</span><br><span class="line"><span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">ANDROID_SINGLETON_STATIC_INSTANCE(GpioDevice)</span><br><span class="line"></span><br><span class="line">GpioDevice::GpioDevice()</span><br><span class="line">    : mGpioModule(<span class="number">0</span>),</span><br><span class="line">      mGpioDevice(<span class="number">0</span>),</span><br><span class="line">      mGpios(<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> err = hw_get_module(GPIOS_HARDWARE_MODULE_ID,(<span class="keyword">hw_module_t</span> <span class="keyword">const</span>**)&amp;mGpioModule);</span><br><span class="line">    ALOGE_IF(err,<span class="string">"couldn't load %s module (%s)"</span>, GPIOS_HARDWARE_MODULE_ID,strerror(-err));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (mGpioModule) &#123;</span><br><span class="line">        err = mGpioModule-&gt;methods-&gt;open(mGpioModule, GPIOS_HARDWARE_MODULE_ID, (struct <span class="keyword">hw_device_t</span>**)&amp;mGpioDevice);</span><br><span class="line">        ALOGE_IF(err,<span class="string">"couldn't open device for module %s module (%s)"</span>, GPIOS_HARDWARE_MODULE_ID,strerror(-err));</span><br><span class="line">        <span class="keyword">if</span> (mGpioDevice) &#123;</span><br><span class="line">            err = mGpioDevice-&gt;listGpio(&amp;mGpios);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LOCAL_DEBUG</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;::iterator it = mGpios-&gt;begin(); it != mGpios-&gt;end(); it++) &#123;</span><br><span class="line">                ALOGD(<span class="string">"%s : gpioNmae = %s"</span>, __FUNCTION__, it-&gt;c_str());</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> GpioDevice::initCheck() <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mGpioModule &amp;&amp; mGpioDevice &amp;&amp; mGpios ? NO_ERROR:NO_INIT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;* GpioDevice::getGpioList() &#123;</span><br><span class="line">    <span class="keyword">return</span> mGpios;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> GpioDevice::getGpioDir(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mGpioDevice) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> mGpioDevice-&gt;getGpioDriction(gpioName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> GpioDevice::setGpioDir(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName, Direction dir) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mGpioDevice) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> mGpioDevice-&gt;setGpioDriction(gpioName,dir);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> GpioDevice::readGpioVal(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mGpioDevice) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> mGpioDevice-&gt;readGpio(gpioName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> GpioDevice::writeGpioVal(<span class="built_in">std</span>::<span class="built_in">string</span> gpioName, Value val) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mGpioDevice) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> mGpioDevice-&gt;writeGpio(gpioName, val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">&#125;; <span class="comment">// namespace android</span></span><br></pre></td></tr></table></figure>

<p>frameworks/native/services/gpiomanager/GpioService.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __GPIO__SERVICE__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __GPIO__SERVICE__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/gpios/BnGpioService.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;binder/BinderService.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"GpioDevice.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> android &#123;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GpioService</span> :</span> </span><br><span class="line">    <span class="keyword">public</span> BinderService&lt;GpioService&gt;,</span><br><span class="line">    <span class="keyword">public</span> ::android::gpios::BnGpioService,</span><br><span class="line">    <span class="keyword">public</span> IBinder::DeathRecipient</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">char</span> <span class="keyword">const</span>* <span class="title">getServiceName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"native.gpios"</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">virtual</span> binder::<span class="function">Status <span class="title">getInt</span><span class="params">(<span class="keyword">int32_t</span>* value)</span></span>;</span><br><span class="line">   	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">(<span class="keyword">const</span> wp&lt;IBinder&gt; &amp;who)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onFirstRef</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="keyword">virtual</span> binder::<span class="function">Status <span class="title">getGpioList</span><span class="params">(::<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;::android::String16&gt;* output, <span class="keyword">int32_t</span>* _aidl_return)</span></span>;</span><br><span class="line">	<span class="keyword">virtual</span> binder::<span class="function">Status <span class="title">readGpioVal</span><span class="params">(<span class="keyword">const</span> ::android::String16&amp; gpioName, <span class="keyword">int32_t</span>* _aidl_return)</span></span>;</span><br><span class="line">	<span class="keyword">virtual</span> binder::<span class="function">Status <span class="title">writeGpioVal</span><span class="params">(<span class="keyword">const</span> ::android::String16&amp; gpioName, <span class="keyword">int32_t</span> val, <span class="keyword">int32_t</span>* _aidl_return)</span></span>;</span><br><span class="line">	<span class="keyword">virtual</span> binder::<span class="function">Status <span class="title">getGpioDir</span><span class="params">(<span class="keyword">const</span> ::android::String16&amp; gpioName, <span class="keyword">int32_t</span>* _aidl_return)</span></span>;</span><br><span class="line">	<span class="keyword">virtual</span> binder::<span class="function">Status <span class="title">setGpioDir</span><span class="params">(<span class="keyword">const</span> ::android::String16&amp; gpioName, <span class="keyword">int32_t</span> val, <span class="keyword">int32_t</span>* _aidl_return)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>frameworks/native/services/gpiomanager/GpioService.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">"GpioService"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_NDEBUG 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"GpioService.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> android &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> binder::Status;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> gpios;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> GpioService::onFirstRef() &#123;</span><br><span class="line">    ALOGD(<span class="string">"GpioService starting..."</span>);</span><br><span class="line">    <span class="function">GpioDevice&amp; <span class="title">dev</span><span class="params">(GpioDevice::getInstance())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dev.initCheck() ==  NO_ERROR) &#123;</span><br><span class="line">        ALOGD(<span class="string">"gpio dev has been init,do something in the furture"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGD(<span class="string">"gpio dev has not been init,need we exit?"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Status GpioService::getInt(<span class="keyword">int32_t</span>* value) &#123;</span><br><span class="line">    ALOGD(<span class="string">"%s"</span>,__FUNCTION__);</span><br><span class="line">    *value = <span class="number">10086</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Status GpioService::getGpioList(::<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;::android::String16&gt;* output, <span class="keyword">int32_t</span>* _aidl_return) &#123;</span><br><span class="line">    <span class="function">GpioDevice&amp; <span class="title">dev</span><span class="params">(GpioDevice::getInstance())</span></span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; *gpios = dev.getGpioList();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;::iterator it = gpios-&gt;begin(); it != gpios-&gt;end(); it++) &#123;</span><br><span class="line">        output-&gt;push_back(String16(it-&gt;c_str()));</span><br><span class="line">        <span class="comment">//ALOGD("%s: gpioNmae = %s", __FUNCTION__, it-&gt;c_str());</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *_aidl_return = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::ok();</span><br><span class="line">&#125;</span><br><span class="line">Status GpioService::readGpioVal(<span class="keyword">const</span> ::android::String16&amp; gpioName, <span class="keyword">int32_t</span>* _aidl_return) &#123;</span><br><span class="line">    ALOGD(<span class="string">"%s"</span>,__FUNCTION__);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> targetGpio = String8(gpioName.<span class="built_in">string</span>()).<span class="built_in">string</span>();</span><br><span class="line">    <span class="function">GpioDevice&amp; <span class="title">dev</span><span class="params">(GpioDevice::getInstance())</span></span>;</span><br><span class="line">    *_aidl_return = dev.readGpioVal(targetGpio);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status::ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Status GpioService::writeGpioVal(<span class="keyword">const</span> ::android::String16&amp; gpioName, <span class="keyword">int32_t</span> val, <span class="keyword">int32_t</span>* _aidl_return) &#123;</span><br><span class="line">    ALOGD(<span class="string">"%s"</span>,__FUNCTION__);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> targetGpio = String8(gpioName.<span class="built_in">string</span>()).<span class="built_in">string</span>();</span><br><span class="line">    <span class="function">GpioDevice&amp; <span class="title">dev</span><span class="params">(GpioDevice::getInstance())</span></span>;</span><br><span class="line">    *_aidl_return = dev.writeGpioVal(targetGpio, (Value)val);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status::ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Status GpioService::getGpioDir(<span class="keyword">const</span> ::android::String16&amp; gpioName, <span class="keyword">int32_t</span>* _aidl_return) &#123;</span><br><span class="line">    ALOGD(<span class="string">"%s"</span>,__FUNCTION__);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> targetGpio = String8(gpioName.<span class="built_in">string</span>()).<span class="built_in">string</span>();</span><br><span class="line">    <span class="function">GpioDevice&amp; <span class="title">dev</span><span class="params">(GpioDevice::getInstance())</span></span>;</span><br><span class="line">    *_aidl_return = dev.getGpioDir(targetGpio);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status::ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Status GpioService::setGpioDir(<span class="keyword">const</span> ::android::String16&amp; gpioName, <span class="keyword">int32_t</span> val, <span class="keyword">int32_t</span>* _aidl_return) &#123;</span><br><span class="line">    ALOGD(<span class="string">"%s"</span>,__FUNCTION__);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> targetGpio = String8(gpioName.<span class="built_in">string</span>()).<span class="built_in">string</span>();</span><br><span class="line">    <span class="function">GpioDevice&amp; <span class="title">dev</span><span class="params">(GpioDevice::getInstance())</span></span>;</span><br><span class="line">    *_aidl_return = dev.setGpioDir(targetGpio, (Direction)val);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status::ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> GpioService::binderDied(<span class="keyword">const</span> wp&lt;IBinder&gt; &amp;who __unused) &#123;</span><br><span class="line">    ALOGE(<span class="string">"%s: Java client's binder died, removing it from the list of active clients"</span>,</span><br><span class="line">            __FUNCTION__);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务注册frameworks/native/services/gpiomanager/main_gpioservice.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">"GpioService"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_NDEBUG 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;binder/BinderService.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"GpioService.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> <span class="comment">/*argc*/</span>, <span class="keyword">char</span>** <span class="comment">/*argv*/</span>)</span> </span>&#123;</span><br><span class="line">	signal(SIGPIPE, SIG_IGN);</span><br><span class="line">	ALOGD(<span class="string">"Gpio service register done"</span>);</span><br><span class="line">	GpioService::publishAndJoinThreadPool();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译脚本frameworks/native/services/gpiomanager/Android.mk</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"></span><br><span class="line">LOCAL_AIDL_INCLUDES := \</span><br><span class="line">    <span class="variable">$(LOCAL_PATH)</span>/aidl</span><br><span class="line"></span><br><span class="line"><span class="comment"># AIDL files for gpio interfaces</span></span><br><span class="line"><span class="comment"># The headers for these interfaces will be available to any modules that</span></span><br><span class="line"><span class="comment"># include libcamera_client, at the path "aidl/package/path/BnFoo.h"</span></span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES := \</span><br><span class="line">    aidl/android/gpios/IGpioService.aidl</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Source for gpios interface parcelables, and manually-written interfaces</span></span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES += \</span><br><span class="line">	GpioDevice.cpp \</span><br><span class="line">	GpioService.cpp \</span><br><span class="line">	main_gpioservice.cpp</span><br><span class="line">	</span><br><span class="line">LOCAL_SHARED_LIBRARIES := \</span><br><span class="line">	libcutils \</span><br><span class="line">	libutils \</span><br><span class="line">	liblog \</span><br><span class="line">	libbinder \</span><br><span class="line">	libhardware \</span><br><span class="line"></span><br><span class="line">LOCAL_CFLAGS += -Werror -Wall -Wextra</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE:= gpioservice</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_EXECUTABLE)</span></span><br></pre></td></tr></table></figure>

<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>服务的bin文件已经生成，需要写一个客户端的代码测试一下IPC调用。</p>
<p>测试代码frameworks/native/services/gpiomanager/gpioservice_test/main.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;binder/IServiceManager.h&gt;</span></span></span><br><span class="line"><span class="comment">//#include &lt;android/gpios/BpGpioService.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/gpios/BnGpioService.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;binder/BinderService.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/gpios.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> android::gpios;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> dir, val;</span><br><span class="line">    <span class="keyword">int32_t</span> ret;</span><br><span class="line">    ::<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;::android::String16&gt; gpios;</span><br><span class="line">    ::android::String16 targetGpio = String16(<span class="string">"gpio1"</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    ALOGD(<span class="string">"%s: gpio,get service manager"</span>, __func__);</span><br><span class="line">    sp&lt;IBinder&gt; binder =  sm-&gt;getService(String16(<span class="string">"native.gpios"</span>));</span><br><span class="line">    sp&lt;IGpioService&gt; bpGpio = interface_cast&lt;IGpioService&gt;(binder);</span><br><span class="line">    bpGpio-&gt;getInt(&amp;i);</span><br><span class="line">    ALOGD(<span class="string">"%s: gpio get int = %d"</span>, __func__, i);</span><br><span class="line"></span><br><span class="line">    bpGpio-&gt;getGpioList(&amp;gpios, &amp;ret);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;::android::String16&gt;::iterator it = gpios.begin(); it != gpios.end(); it++) &#123;</span><br><span class="line">        <span class="comment">//ALOGD("%s: TEST gpioNmae = %s", __FUNCTION__, ::android::String8(it-&gt;string()).string());</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bpGpio-&gt;getGpioDir(targetGpio, &amp;dir);</span><br><span class="line">    bpGpio-&gt;readGpioVal(targetGpio, &amp;val);</span><br><span class="line">    ALOGD(<span class="string">"%s: TEST1 dir = %d,val=%d"</span>, __FUNCTION__, dir, val);</span><br><span class="line">    bpGpio-&gt;setGpioDir(targetGpio, GPIO_OUT, &amp;ret);</span><br><span class="line">    bpGpio-&gt;writeGpioVal(targetGpio, GPIO_HIGH, &amp;ret);</span><br><span class="line"></span><br><span class="line">    bpGpio-&gt;getGpioDir(targetGpio, &amp;dir);</span><br><span class="line">    bpGpio-&gt;readGpioVal(targetGpio, &amp;val);</span><br><span class="line">    ALOGD(<span class="string">"%s: TEST2 dir = %d,val=%d"</span>, __FUNCTION__, dir, val);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译脚本frameworks/native/services/gpiomanager/gpioservice_test/Android.mk</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH:= <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"></span><br><span class="line">LOCAL_AIDL_INCLUDES := \</span><br><span class="line">    <span class="variable">$(LOCAL_PATH)</span>/aidl</span><br><span class="line"></span><br><span class="line"><span class="comment"># AIDL files for gpio interfaces</span></span><br><span class="line"><span class="comment"># The headers for these interfaces will be available to any modules that</span></span><br><span class="line"><span class="comment"># include libcamera_client, at the path "aidl/package/path/BnFoo.h"</span></span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES := \</span><br><span class="line">    aidl/android/gpios/IGpioService.aidl</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE:= gpioServiceTest</span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES += \</span><br><span class="line">    main.cpp \</span><br><span class="line"></span><br><span class="line">LOCAL_SHARED_LIBRARIES := \</span><br><span class="line">    libcutils \</span><br><span class="line">    libutils \</span><br><span class="line">    liblog \</span><br><span class="line">    libbinder \</span><br><span class="line"></span><br><span class="line"><span class="comment">#LOCAL_CLANG  := true</span></span><br><span class="line"></span><br><span class="line">LOCAL_CFLAGS += -Werror -Wall -Wextra</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_EXECUTABLE)</span></span><br></pre></td></tr></table></figure>

<p>有了gpioservice和gpioServiceTest；先关闭色linux，开启两个终端；一个终端先执行gpiooservice，另一个终端执行gpioServiceTest进行测试。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><p>在项目的具体的init脚本添加以下代码，开机启动gpioservice服务，我们需要该服务开机自启动、异常推出的话自动重启。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service gpioservice /system/bin/gpioservice</span><br><span class="line">class main</span><br><span class="line">user root</span><br></pre></td></tr></table></figure>

<h4 id="selinux配置"><a href="#selinux配置" class="headerlink" title="selinux配置"></a>selinux配置</h4><p>添加gpioservice.te文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">type gpioservice, domain, mlstrustedsubject;</span><br><span class="line">type gpioservice_exec, exec_type, file_type;</span><br><span class="line"></span><br><span class="line">init_daemon_domain(gpioservice)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>允许客户端通过binder调用</span><br><span class="line">binder_use(gpioservice)</span><br><span class="line">binder_call(gpioservice, binderservicedomain)</span><br><span class="line">binder_call(gpioservice, appdomain)</span><br><span class="line">binder_service(gpioservice)</span><br><span class="line"></span><br><span class="line">allow gpioservice sysfs:file &#123;open rw_file_perms setattr getattr&#125;;</span><br><span class="line">allow gpioservice sysfs:dir &#123;open read write setattr getattr&#125;;</span><br><span class="line">allow gpioservice rootfs:lnk_file &#123; getattr &#125;;</span><br><span class="line"></span><br><span class="line">allow gpioservice gpioservice_service:service_manager add;</span><br></pre></td></tr></table></figure>

<p>file_contexts文件中添加以下代码对二进制文件进行label申明：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/system/bin/gpioservice                         u:object_r:gpioservice_exec:s0</span><br></pre></td></tr></table></figure>

<p>service.te文件中申明服务类型：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type gpioservice_service,         system_api_service,service_manager_type;</span><br></pre></td></tr></table></figure>

<p>service_contexts文件中对服务进行label申明：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">native.gpios                                   u:object_r:gpioservice_service:s0</span><br></pre></td></tr></table></figure>

<p>给各类可能的客户端对象赋予查询权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">allow untrusted_app gpioservice_service:service_manager find;</span><br><span class="line">allow platform_app gpioservice_service:service_manager find;</span><br><span class="line">allow priv_app gpioservice_service:service_manager find;</span><br><span class="line">allow system_app gpioservice_service:service_manager find;</span><br><span class="line">allow system_server gpioservice_service:service_manager find;</span><br></pre></td></tr></table></figure>

<p>至此，服务配置完成，启动成功。</p>
<h2 id="API封装"><a href="#API封装" class="headerlink" title="API封装"></a>API封装</h2><h4 id="JNI"><a href="#JNI" class="headerlink" title="JNI"></a>JNI</h4><p>jni代码frameworks/base/core/jni/android_hardware_GpiosManager.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright 2008, The Android Open Source Project</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">"GpiosManager"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"JNIHelp.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"core_jni_helpers.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"jni.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ScopedUtfChars.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ScopedLocalRef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android_runtime/AndroidRuntime.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Looper.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Vector.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;binder/IServiceManager.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/gpios/BnGpioService.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;binder/BinderService.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/gpios.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    jclass clazz;</span><br><span class="line">&#125; gStringClassInfo;</span><br><span class="line"></span><br><span class="line">sp&lt;gpios::IGpioService&gt; gService = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeInit</span> <span class="params">(JNIEnv *env, jclass clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    gService = interface_cast&lt;gpios::IGpioService&gt;(</span><br><span class="line">            sm-&gt;getService(String16(<span class="string">"native.gpios"</span>)));</span><br><span class="line">    <span class="keyword">if</span> (gService == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not obtain IGpioService from service manager"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jobjectArray <span class="title">nativeGetGpioList</span><span class="params">(JNIEnv *env, jobject clazz)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    jobjectArray result = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> ret, i = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;::android::String16&gt; gpios;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (gService == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"gService =  null"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gService-&gt;getGpioList(&amp;gpios, &amp;ret);</span><br><span class="line">    <span class="keyword">if</span>(gpios.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        result = env-&gt;NewObjectArray(jsize(gpios.size()), gStringClassInfo.clazz, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;::android::String16&gt;::iterator it = gpios.begin(); it != gpios.end(); it++) &#123;</span><br><span class="line">            jstring str = env-&gt;NewStringUTF(String8(it-&gt;<span class="built_in">string</span>()).<span class="built_in">string</span>());</span><br><span class="line">            env-&gt;SetObjectArrayElement(result, jsize(i), str);</span><br><span class="line">            env-&gt;DeleteLocalRef(str);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">nativeGetGpioDir</span><span class="params">(JNIEnv *env, jobject clazz,jstring name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dir;</span><br><span class="line"></span><br><span class="line">    <span class="function">ScopedUtfChars <span class="title">match</span><span class="params">(env, name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (gService == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"gService =  null"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gService-&gt;getGpioDir(String16(match.c_str()), &amp;dir);</span><br><span class="line">    <span class="keyword">return</span> (jint)dir;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">nativeSetGpioDir</span><span class="params">(JNIEnv *env, jobject clazz,jstring name,jint dir)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="function">ScopedUtfChars <span class="title">match</span><span class="params">(env, name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (gService == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"gService =  null"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gService-&gt;setGpioDir(String16(match.c_str()), dir, &amp;ret);</span><br><span class="line">    <span class="keyword">return</span> (jint)ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">nativeGetGpioVal</span><span class="params">(JNIEnv *env, jobject clazz,jstring name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="function">ScopedUtfChars <span class="title">match</span><span class="params">(env, name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (gService == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"gService =  null"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gService-&gt;readGpioVal(String16(match.c_str()), &amp;val);</span><br><span class="line">    <span class="keyword">return</span> (jint)val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">nativeSetGpioVal</span><span class="params">(JNIEnv *env, jobject clazz,jstring name,jint val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="function">ScopedUtfChars <span class="title">match</span><span class="params">(env, name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (gService == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"gService =  null"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gService-&gt;writeGpioVal(String16(match.c_str()), val, &amp;ret);</span><br><span class="line">    <span class="keyword">return</span> (jint)ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gSystemGpiosManagerMethods[] = &#123;</span><br><span class="line">    &#123; <span class="string">"nativeInit"</span>,<span class="string">"()V"</span>,(<span class="keyword">void</span>*)nativeInit &#125;,</span><br><span class="line">    &#123; <span class="string">"nativeGetGpioList"</span>,<span class="string">"()[Ljava/lang/String;"</span>,(<span class="keyword">void</span>*)nativeGetGpioList &#125;,</span><br><span class="line">    &#123; <span class="string">"nativeGetGpioDir"</span>,<span class="string">"(Ljava/lang/String;)I"</span>,(<span class="keyword">void</span>*)nativeGetGpioDir &#125;,</span><br><span class="line">    &#123; <span class="string">"nativeSetGpioDir"</span>,<span class="string">"(Ljava/lang/String;I)I"</span>,(<span class="keyword">void</span>*)nativeSetGpioDir &#125;,</span><br><span class="line">    &#123; <span class="string">"nativeGetGpioVal"</span>,<span class="string">"(Ljava/lang/String;)I"</span>,(<span class="keyword">void</span>*)nativeGetGpioVal &#125;,</span><br><span class="line">    &#123; <span class="string">"nativeSetGpioVal"</span>,<span class="string">"(Ljava/lang/String;I)I"</span>,(<span class="keyword">void</span>*)nativeSetGpioVal &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">//unnamed namespace</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_hardware_GpiosManager</span><span class="params">(JNIEnv *env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    jclass clazz = FindClassOrDie(env, <span class="string">"java/lang/String"</span>);</span><br><span class="line">    gStringClassInfo.clazz = MakeGlobalRefOrDie(env, clazz);</span><br><span class="line"></span><br><span class="line">    RegisterMethodsOrDie(env, <span class="string">"android/hardware/GpiosManager"</span>,</span><br><span class="line">            gSystemGpiosManagerMethods, NELEM(gSystemGpiosManagerMethods));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在frameworks/base/core/jni/AndroidRuntime.cpp中进行注册：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">register_android_hardware_GpiosManager</span><span class="params">(JNIEnv *env)</span></span>;</span><br><span class="line">......</span><br><span class="line">    REG_JNI(register_android_hardware_GpiosManager),</span><br></pre></td></tr></table></figure>

<h4 id="JAVA-API"><a href="#JAVA-API" class="headerlink" title="JAVA API"></a>JAVA API</h4><p>修改在frameworks/base/core/java/android/content/Context.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="meta">@StringDef</span>(&#123;</span><br><span class="line">        POWER_SERVICE,</span><br><span class="line">        WINDOW_SERVICE,</span><br><span class="line">        LAYOUT_INFLATER_SERVICE,</span><br><span class="line">        ACCOUNT_SERVICE,</span><br><span class="line">        ACTIVITY_SERVICE,</span><br><span class="line">        ALARM_SERVICE,</span><br><span class="line">        NOTIFICATION_SERVICE,</span><br><span class="line">        ACCESSIBILITY_SERVICE,</span><br><span class="line">        CAPTIONING_SERVICE,</span><br><span class="line">        KEYGUARD_SERVICE,</span><br><span class="line">        LOCATION_SERVICE,</span><br><span class="line">        <span class="comment">//@hide: COUNTRY_DETECTOR,</span></span><br><span class="line">        SEARCH_SERVICE,</span><br><span class="line">        SENSOR_SERVICE,</span><br><span class="line">        GPIOS_SERVICE,<span class="comment">//我们添加</span></span><br><span class="line">    .........</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Use with &#123;<span class="doctag">@link</span> #getSystemService&#125; to retrieve a &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * android.hardware.GpiosManager&#125; for accessing sensors.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getSystemService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> android.hardware.GPIOSManager</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String GPIOS_SERVICE = <span class="string">"gpios"</span>;</span><br></pre></td></tr></table></figure>

<p>添加frameworks/base/core/java/android/hardware/GpiosManager.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2011 The Android Open Source Project</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> android.hardware;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.android.internal.annotations.GuardedBy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GpiosManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"GpiosManager"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DIR_IN = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DIR_OUT = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VALUE_LOW = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VALUE_HIGH = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeInit</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> String[] nativeGetGpioList();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">nativeGetGpioDir</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">nativeSetGpioDir</span><span class="params">(String name, <span class="keyword">int</span> dir)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">nativeGetGpioVal</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">nativeSetGpioVal</span><span class="params">(String name, <span class="keyword">int</span> val)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object sLock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="meta">@GuardedBy</span>(<span class="string">"sLock"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> mNativeInited = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GpiosManager</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(sLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mNativeInited) &#123;</span><br><span class="line">                nativeInit();</span><br><span class="line">                mNativeInited = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] getFullGpioList() &#123;</span><br><span class="line">        <span class="keyword">return</span> nativeGetGpioList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getGpioDir</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> dir = nativeGetGpioDir(name);</span><br><span class="line">        <span class="keyword">if</span> (dir != DIR_IN &amp;&amp; dir != DIR_OUT) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> dir;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">setGpioDir</span><span class="params">(String name, <span class="keyword">int</span> dir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nativeSetGpioDir(name, dir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getGpioVal</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> val = nativeGetGpioVal(name);</span><br><span class="line">        <span class="keyword">if</span> (val != VALUE_LOW &amp;&amp; val != VALUE_HIGH) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">setGpioVal</span><span class="params">(String name, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nativeSetGpioVal(name, val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改frameworks/base/core/java/android/app/SystemServiceRegistry.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.hardware.GpiosManager;</span><br><span class="line"></span><br><span class="line">...............</span><br><span class="line"></span><br><span class="line">        registerService(Context.GPIOS_SERVICE, GpiosManager.class,</span><br><span class="line">                <span class="keyword">new</span> CachedServiceFetcher&lt;GpiosManager&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> GpiosManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> GpiosManager(ctx.getOuterContext());</span><br><span class="line">            &#125;&#125;);</span><br></pre></td></tr></table></figure>

<p>至此framworks层的修改完成，我们需要通过写一个简单的app进行测试。</p>
<h2 id="APP"><a href="#APP" class="headerlink" title="APP"></a>APP</h2><p>layout：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">"com.hzy.viewcust.MainActivity"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:showIn</span>=<span class="string">"@layout/app_bar_main"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Spinner</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/spinner"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_alignParentTop</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"26dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/button"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:onClick</span>=<span class="string">"click_read"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/button_read"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"21dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/editText2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_alignStart</span>=<span class="string">"@+id/button2"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/button2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:onClick</span>=<span class="string">"click_write"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/button_write"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/spinner"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"33dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/editText"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"27dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:ems</span>=<span class="string">"10"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:inputType</span>=<span class="string">"textPersonName"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/text_dir"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/button2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/editText2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:ems</span>=<span class="string">"10"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:inputType</span>=<span class="string">"textPersonName"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/text_val"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_centerVertical</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_alignStart</span>=<span class="string">"@+id/editText"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/textView6"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/button"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"53dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/text_read"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>main activity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hzy.viewcust;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.MenuItem;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.widget.Spinner;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">import</span> android.widget.AdapterView;</span><br><span class="line"><span class="keyword">import</span> android.widget.ArrayAdapter;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"><span class="keyword">import</span> android.hardware.GpiosManager;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"gpioTestApp"</span>;</span><br><span class="line">    <span class="keyword">private</span> Spinner spinner;</span><br><span class="line">    <span class="keyword">private</span> Button bt_read, bt_write;</span><br><span class="line">    <span class="keyword">private</span> EditText ed_dir,ed_val;</span><br><span class="line">    <span class="keyword">private</span> TextView text_read;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ArrayAdapter&lt;String&gt; adapter;</span><br><span class="line">    <span class="keyword">private</span> String cur_gpio = <span class="string">"gpio1"</span>;</span><br><span class="line">    </span><br><span class="line">    GpiosManager gpiomgr = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.content_main);</span><br><span class="line"></span><br><span class="line">        gpiomgr = (GpiosManager)getSystemService(Context.GPIOS_SERVICE);</span><br><span class="line">        <span class="keyword">if</span> (gpiomgr == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"get gpio manager failed"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String gpios[] = gpiomgr.getFullGpioList();</span><br><span class="line">            spinner = (Spinner)findViewById(R.id.spinner);</span><br><span class="line">            adapter = <span class="keyword">new</span> ArrayAdapter&lt;String&gt;(<span class="keyword">this</span>,android.R.layout.simple_spinner_item,gpios);</span><br><span class="line">            spinner.setAdapter(adapter);</span><br><span class="line">            spinner.setOnItemSelectedListener(<span class="keyword">new</span> AdapterView.OnItemSelectedListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemSelected</span><span class="params">(AdapterView&lt;?&gt; parent, View view, <span class="keyword">int</span> pos, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">                    cur_gpio = gpios[pos];</span><br><span class="line">                    Toast.makeText(MainActivity.<span class="keyword">this</span>,<span class="string">"you choose:"</span> + cur_gpio, <span class="number">2000</span>).show();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNothingSelected</span><span class="params">(AdapterView&lt;?&gt; parent)</span> </span>&#123;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">             &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        ed_dir = (EditText)findViewById(R.id.editText);</span><br><span class="line">        ed_val = (EditText)findViewById(R.id.editText2);</span><br><span class="line">        text_read = (TextView)findViewById(R.id.textView6);</span><br><span class="line">        bt_read = (Button)findViewById(R.id.button);</span><br><span class="line">        bt_write = (Button)findViewById(R.id.button2);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">click_read</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> dir = gpiomgr.getGpioDir(cur_gpio);</span><br><span class="line">        <span class="keyword">int</span> val = gpiomgr.getGpioVal(cur_gpio);</span><br><span class="line">        text_read.setText(dir + <span class="string">":"</span> + val );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">click_write</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> dir = Integer.parseInt(ed_dir.getText().toString());</span><br><span class="line">        <span class="keyword">int</span> val = Integer.parseInt(ed_val.getText().toString());</span><br><span class="line">        <span class="keyword">int</span> ret1 = gpiomgr.setGpioDir(cur_gpio, dir);</span><br><span class="line">        <span class="keyword">int</span> ret2 = gpiomgr.setGpioVal(cur_gpio, val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，一个简单的android子系统就添加完成了。我在android N的环境下实现测试的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>由于是之前在Android N上实现的例子，现在就没有办法把实际的效果贴出来了。感兴趣的童鞋有适合的开发环境的话可以一步一步地跟着来体验一下。以上的纪录包含了实现一个子系统所有必要的知识点。这里没有对每一个都详细的介绍，我也是在学习中！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/05/26/Android-sub-system-impletment/" data-id="cjzva4h3o002h6gii6dn7mfta" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AIDL/">AIDL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/学习/">学习</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/06/01/Android-hidl-sample-impletment/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Android9.0 HIDL 学习
        
      </div>
    </a>
  
  
    <a href="/2019/05/25/Linux-global-data-overflow/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">全局数据踩踏问题</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AIDL/">AIDL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HIDL/">HIDL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/driver/">driver</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习/">学习</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/实战/">实战</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/稳定性/">稳定性</a><span class="tag-list-count">8</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AIDL/" style="font-size: 10px;">AIDL</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/HIDL/" style="font-size: 10px;">HIDL</a> <a href="/tags/Linux/" style="font-size: 17.5px;">Linux</a> <a href="/tags/driver/" style="font-size: 10px;">driver</a> <a href="/tags/学习/" style="font-size: 20px;">学习</a> <a href="/tags/实战/" style="font-size: 12.5px;">实战</a> <a href="/tags/稳定性/" style="font-size: 12.5px;">稳定性</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/08/26/ARMv8-linux-spinlock-understanding/">Linux spinlock的底层实现</a>
          </li>
        
          <li>
            <a href="/2019/08/01/Arm-linux-exception-flows/">Linux-ARMv8异常相关知识</a>
          </li>
        
          <li>
            <a href="/2019/07/20/Android-gdb-extract-logs/">Android9.0 logd进程空间提取日志信息</a>
          </li>
        
          <li>
            <a href="/2019/07/15/Android-booting-time-spent/">Android开机时间分析</a>
          </li>
        
          <li>
            <a href="/2019/07/10/a-intentresolver-cts-issue/">关于IntentResolver的一个cts问题</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 JoyYoung<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>