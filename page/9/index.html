<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>JoyYoung&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="JoyYoung&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/9/index.html">
<meta property="og:site_name" content="JoyYoung&#39;s blog">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JoyYoung&#39;s blog">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JoyYoung&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Android-hidl-sample-impletment" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/01/Android-hidl-sample-impletment/" class="article-date">
  <time datetime="2019-06-01T15:00:00.000Z" itemprop="datePublished">2019-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/01/Android-hidl-sample-impletment/">Android9.0 HIDL 学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a><strong>背景</strong></h2><p>从android O开始,google对android系统框架重新进行了设计。最大的变化就是引进了Project Treble将hal从system分区移到vendor分区。大量的变化基本上都是围绕着treble展开的。相关的信息都可以在google官网<a href="https://source.android.com/devices/architecture" target="_blank" rel="noopener">https://source.android.com/devices/architecture</a> 上查到，这里就不做搬运了。值得一提的是，HIDL其实底层的支撑跟AIDL是一样的，都是binder驱动。</p>
<p>对于开发人员来讲，我比较关心这个变化对于我们的工作上有什么影响，比如system和vendor的分离导致的selinux出现domian和coredomian的区分；system和vendor服务之间如果使用HIDL开发建立通讯等。所以决定通过实现一个HIDL的例子来学习一下!
我们的例子是基于HIDL实现一个vendor服务（严格的说应该叫hal 服务），然后写一个java客户（app）端和其进行通讯。</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>高通平台、android9.0源码。</p>
<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a><strong>服务端</strong></h2><p>这个例子不是像之前的android子系统那样，不会涉及驱动和hal库相关的东西，因为这部分变化不大。我们直接一步一步实现一个vendor服务。为了方便我们直接在高通原有的编译布局下来实现，命名规则也按高通的来。</p>
<h4 id="HIDL"><a href="#HIDL" class="headerlink" title="HIDL"></a>HIDL</h4><p>创建源码目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p vendor/qcom/interfaces/mtcomp/1.0/default</span><br></pre></td></tr></table></figure>

<p>在vendor/qcom/interfaces/mtcomp/1.0/目录下添加hal service 接口描述文件，IMtcomp.hal内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * add for study</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">package vendor.qti.hardware.mtcomp@<span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> IMtcompCallback;</span><br><span class="line"></span><br><span class="line">interface IMtcomp &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get supported command list</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @return cmds mtcomp supported .</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  listSupportCmd() generates (<span class="built_in">string</span> cmds);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Execute the applied cmd and return result</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param cmd the command we need to execute.</span></span><br><span class="line"><span class="comment">   * @return result of the cmd.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  executeCmd(<span class="built_in">string</span> cmd) generates (<span class="built_in">string</span> result);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * register a call back function to get the result</span></span><br><span class="line"><span class="comment">     * This function must be called as a couple with releaseCallBack.</span></span><br><span class="line"><span class="comment">     * @param callback is the IMtcompCallback object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  registerCallBack(IMtcompCallback callback);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * register a call back function to get the result</span></span><br><span class="line"><span class="comment">     * This function must be called as a couple with registerCallBack.</span></span><br><span class="line"><span class="comment">     * @param callback is the IMtcompCallback object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  releaseCallBack(IMtcompCallback callback);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在vendor/qcom/proprietary/interfaces/mtcomp/1.0/添加文件IMtcompCallback.hal，用于回调的对象接口描述，内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * add to study</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">package vendor.qti.hardware.mtcomp@<span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line">interface IMtcompCallback &#123;</span><br><span class="line">  <span class="function">oneway <span class="title">onReport</span><span class="params">(<span class="built_in">string</span> report_buf)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接口描述都有了后，需要添加编译脚本vendor/qcom/proprietary/interfaces/mtcomp/1.0/Android.bp，不过这个编译脚本不需要我们自己写，google提供了强大的hidl-gen工具给我们使用，命令详细说明google官网都有说明，我们这个例子的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PACKAGE=vendor.qti.hardware.mtcomp@1.0</span><br><span class="line">hidl-gen -Landroidbp -rvendor.qti.hardware:vendor/qcom/proprietary/interfaces -randroid.hidl:system/libhidl/transport $PACKAGE</span><br></pre></td></tr></table></figure>

<p>生成的内容如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// This file is autogenerated by hidl-gen -Landroidbp.</span><br><span class="line"></span><br><span class="line">hidl_interface &#123;</span><br><span class="line">    name: <span class="string">"vendor.qti.hardware.mtcomp@1.0"</span>,</span><br><span class="line">    root: <span class="string">"vendor.qti.hardware"</span>,</span><br><span class="line">    srcs: [</span><br><span class="line">        <span class="string">"IMtcomp.hal"</span>,</span><br><span class="line">        <span class="string">"IMtcompCallback.hal"</span>,</span><br><span class="line">    ],</span><br><span class="line">    interfaces: [</span><br><span class="line">        <span class="string">"android.hidl.base@1.0"</span>,</span><br><span class="line">    ],</span><br><span class="line">    gen_java: true,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们的目录内容是这样的：<img src="/2019/06/01/Android-hidl-sample-impletment/interface.PNG" alt="接口定义"></p>
<p>同样的，google的hidl-gen工具也可以帮我们生成service依赖的接口类的通用代码，减少重复性的代码编写工作。我们的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PACKAGE=vendor.qti.hardware.mtcomp@1.0</span><br><span class="line">LOC=vendor/qcom/proprietary/interfaces/mtcomp/1.0/default</span><br><span class="line">make hidl-gen -j64 (if needed)</span><br><span class="line">hidl-gen -o $LOC -Lc++-impl -rvendor.qti.hardware:vendor/qcom/proprietary/interfaces -randroid.hidl:system/libhidl/transport $PACKAGE</span><br><span class="line">hidl-gen -o $LOC -Landroidbp-impl -rvendor.qti.hardware:vendor/qcom/proprietary/interfaces -randroid.hidl:system/libhidl/transport $PACKAGE</span><br></pre></td></tr></table></figure>

<p>生成后的目录如下，蓝色标注的是hidl-gen生成的，我们需要根据具体要求进行调整和实现自己的需求。<img src="/2019/06/01/Android-hidl-sample-impletment/impletment.PNG" alt="具体实现"></p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>现在我们要根据自己的需求来调整和实现相关代码。首先我们需要在新建<a href="mailto:vendor.qti.hardware.mtcomp@1.0-service.rc" target="_blank" rel="noopener">vendor.qti.hardware.mtcomp@1.0-service.rc</a>文件，放到vendor/qcom/proprietary/interfaces/mtcomp/1.0/default/目录中，内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service vendor.mtcomp-hal-1-0 /vendor/bin/hw/vendor.qti.hardware.mtcomp@1.0-service</span><br><span class="line">    class late_start</span><br><span class="line">    user system</span><br><span class="line">    group system</span><br></pre></td></tr></table></figure>

<p>然后创建vendor/qcom/proprietary/interfaces/mtcomp/1.0/default/service.cpp文件，作为服务的入口。使用binderlize的方式，内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2017 The Android Open Source Project</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LOG_TAG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> LOG_TAG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">"vendor.qti.hardware.mtcomp@1.0-service"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hidl/HidlSupport.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hidl/HidlTransportSupport.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vendor/qti/hardware/mtcomp/1.0/IMtcomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Mtcomp.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"MtcompCallback.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> vendor::qti::hardware::mtcomp::V1_0::IMtcomp;</span><br><span class="line"><span class="keyword">using</span> vendor::qti::hardware::mtcomp::V1_0::implementation::Mtcomp;</span><br><span class="line"><span class="keyword">using</span> android::hardware::configureRpcThreadpool;</span><br><span class="line"><span class="keyword">using</span> android::hardware::joinRpcThreadpool;</span><br><span class="line"><span class="keyword">using</span> android::sp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    android::sp&lt;IMtcomp&gt; bio = Mtcomp::getInstance();</span><br><span class="line"></span><br><span class="line">    configureRpcThreadpool(<span class="number">1</span>, <span class="literal">true</span> <span class="comment">/*callerWillJoin*/</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bio != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (::android::OK != bio-&gt;registerAsService()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGE(<span class="string">"Can't create instance of Mtcomp, nullptr"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    joinRpcThreadpool();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// should never get here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于使用binderlize的方式，所以编译脚本也要相应的做一些调整，否则会遇到以下错误：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">819</span> F linker  : CANNOT LINK EXECUTABLE <span class="string">"/vendor/bin/hw/vendor.qti.hardware.mtcomp@1.0-service"</span>: library <span class="string">"vendor.qti.hardware.mtcomp@1.0-impl.so"</span> <span class="keyword">not</span> found</span><br></pre></td></tr></table></figure>

<p>调整后内容如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">// This file is autogenerated by hidl-gen -Landroidbp-impl. you can modify it as you need.</span><br><span class="line">cc_library_shared &#123;</span><br><span class="line">    // FIXME: this should only be -impl for a passthrough hal.</span><br><span class="line">    // In most cases, to convert this to a binderized implementation, you should:</span><br><span class="line">    // - change '-impl' to '-service' here and make it a cc_binary instead of a</span><br><span class="line">    //   cc_library_shared.</span><br><span class="line">    // - add a *.rc file for this module.</span><br><span class="line">    // - delete HIDL_FETCH_I* functions.</span><br><span class="line">    // - call configureRpcThreadpool and registerAsService on the instance.</span><br><span class="line">    // You may also want to append '-impl/-service' with a specific identifier like</span><br><span class="line">    // '-vendor' or '-&lt;hardware identifier&gt;' etc to distinguish it.</span><br><span class="line">    name: <span class="string">"vendor.qti.hardware.mtcomp@1.0-impl"</span>,</span><br><span class="line">    relative_install_path: <span class="string">"hw"</span>,</span><br><span class="line">    vendor: true,</span><br><span class="line">    // on AOSP.</span><br><span class="line">    //proprietary: true,</span><br><span class="line">    srcs: [</span><br><span class="line">        <span class="string">"Mtcomp.cpp"</span>,</span><br><span class="line">        <span class="string">"MtcompCallback.cpp"</span>,</span><br><span class="line">    ],</span><br><span class="line">    shared_libs: [</span><br><span class="line">        <span class="string">"libhidlbase"</span>,</span><br><span class="line">        <span class="string">"libhidltransport"</span>,</span><br><span class="line">        <span class="string">"liblog"</span>,</span><br><span class="line">        <span class="string">"libutils"</span>,</span><br><span class="line">        <span class="string">"vendor.qti.hardware.mtcomp@1.0"</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cc_binary &#123;</span><br><span class="line">    name: <span class="string">"vendor.qti.hardware.mtcomp@1.0-service"</span>,</span><br><span class="line">    defaults: [<span class="string">"hidl_defaults"</span>],</span><br><span class="line">    relative_install_path: <span class="string">"hw"</span>,</span><br><span class="line">    vendor: true,</span><br><span class="line">    init_rc: [<span class="string">"vendor.qti.hardware.mtcomp@1.0-service.rc"</span>],</span><br><span class="line">    //srcs: [<span class="string">"service.cpp"</span>],</span><br><span class="line">    srcs: [</span><br><span class="line">        //<span class="string">"WorkerThread.cpp"</span>,</span><br><span class="line">        <span class="string">"Mtcomp.cpp"</span>,</span><br><span class="line">        <span class="string">"MtcompCallback.cpp"</span>,</span><br><span class="line">        <span class="string">"service.cpp"</span></span><br><span class="line">    ],</span><br><span class="line">    shared_libs: [</span><br><span class="line">        <span class="string">"liblog"</span>,</span><br><span class="line">        <span class="string">"libcutils"</span>,</span><br><span class="line">        <span class="string">"libdl"</span>,</span><br><span class="line">        <span class="string">"libbase"</span>,</span><br><span class="line">        <span class="string">"libutils"</span>,</span><br><span class="line">        <span class="string">"libhardware"</span>,</span><br><span class="line">        <span class="string">"libhidlbase"</span>,</span><br><span class="line">        <span class="string">"libhidltransport"</span>,</span><br><span class="line">        <span class="string">"vendor.qti.hardware.mtcomp@1.0"</span>,</span><br><span class="line">        //<span class="string">"vendor.qti.hardware.mtcomp@1.0-impl"</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就是最重要的IMtcomp类了，我们看看头文件，这里有些说明很重要，注视说明一下。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> VENDOR_QTI_HARDWARE_MTCOMP_V1_0_MTCOMP_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VENDOR_QTI_HARDWARE_MTCOMP_V1_0_MTCOMP_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vendor/qti/hardware/mtcomp/1.0/IMtcomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hidl/MQDescriptor.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hidl/Status.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> vendor &#123;</span><br><span class="line"><span class="keyword">namespace</span> qti &#123;</span><br><span class="line"><span class="keyword">namespace</span> hardware &#123;</span><br><span class="line"><span class="keyword">namespace</span> mtcomp &#123;</span><br><span class="line"><span class="keyword">namespace</span> V1_0 &#123;</span><br><span class="line"><span class="keyword">namespace</span> implementation &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//using ::vendor::qti::hardware::mtcomp::V1_0::IMtcompCallback;</span></span><br><span class="line"><span class="keyword">using</span> ::android::hardware::hidl_array;</span><br><span class="line"><span class="keyword">using</span> ::android::hardware::hidl_memory;</span><br><span class="line"><span class="keyword">using</span> ::android::hardware::hidl_string;</span><br><span class="line"><span class="keyword">using</span> ::android::hardware::hidl_vec;</span><br><span class="line"><span class="keyword">using</span> ::android::hardware::Return;</span><br><span class="line"><span class="keyword">using</span> ::android::hardware::Void;</span><br><span class="line"><span class="keyword">using</span> ::android::sp;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Mtcomp</span> :</span> <span class="keyword">public</span> IMtcomp &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Mtcomp();</span><br><span class="line">    ~Mtcomp();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Methods from ::vendor::qti::hardware::mtcomp::V1_0::IMtcomp follow.</span></span><br><span class="line">    <span class="comment">// 这里是我们服务向外提供的接口</span></span><br><span class="line">    Return&lt;<span class="keyword">void</span>&gt; listSupportCmd(listSupportCmd_cb _hidl_cb) override;</span><br><span class="line">    Return&lt;<span class="keyword">void</span>&gt; executeCmd(<span class="keyword">const</span> hidl_string&amp; cmd, executeCmd_cb _hidl_cb) override;</span><br><span class="line">    Return&lt;<span class="keyword">void</span>&gt; registerCallBack(<span class="keyword">const</span> sp&lt;::vendor::qti::hardware::mtcomp::V1_0::IMtcompCallback&gt;&amp; callback) override;</span><br><span class="line">    Return&lt;<span class="keyword">void</span>&gt; releaseCallBack(<span class="keyword">const</span> sp&lt;::vendor::qti::hardware::mtcomp::V1_0::IMtcompCallback&gt;&amp; callback) override;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Methods from ::android::hidl::base::V1_0::IBase follow.</span></span><br><span class="line">    <span class="comment">// google默认设计就是这样，具体实现这个类为单例模式</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> IMtcomp* <span class="title">getInstance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//friend class WorkerThread;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">static</span> Mtcomp* sInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cycleLoop</span><span class="params">()</span></span>;</span><br><span class="line">    sp&lt;IMtcompCallback&gt; mStoredCallback;</span><br><span class="line">    <span class="built_in">std</span>::thread mThread;</span><br><span class="line">    <span class="built_in">std</span>::atomic&lt;<span class="keyword">bool</span>&gt; mIsTerminating;</span><br><span class="line">    <span class="built_in">std</span>::condition_variable mCv;</span><br><span class="line">    <span class="built_in">std</span>::mutex mCvMutex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">FIXME:</span> most likely delete, this is only for passthrough implementations</span></span><br><span class="line"><span class="comment">// 如果使用直通式的方式才需要打开这行代码，否则注视掉。我们使用binderlize的方式</span></span><br><span class="line"><span class="comment">// extern "C" IMtcomp* HIDL_FETCH_IMtcomp(const char* name);</span></span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace implementation</span></span><br><span class="line">&#125;  <span class="comment">// namespace V1_0</span></span><br><span class="line">&#125;  <span class="comment">// namespace mtcomp</span></span><br><span class="line">&#125;  <span class="comment">// namespace hardware</span></span><br><span class="line">&#125;  <span class="comment">// namespace qti</span></span><br><span class="line">&#125;  <span class="comment">// namespace vendor</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// VENDOR_QTI_HARDWARE_MTCOMP_V1_0_MTCOMP_H</span></span></span><br></pre></td></tr></table></figure>

<p>Mtcomp.cpp的最终代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;log/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Mtcomp.h"</span></span></span><br><span class="line"><span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LOG_TAG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> LOG_TAG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">"vendor.qti.hardware.mtcomp@1.0-service"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_VERBOSE <span class="meta-string">"vendor.qti.hardware.mtcomp@1.0-service"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> vendor &#123;</span><br><span class="line"><span class="keyword">namespace</span> qti &#123;</span><br><span class="line"><span class="keyword">namespace</span> hardware &#123;</span><br><span class="line"><span class="keyword">namespace</span> mtcomp &#123;</span><br><span class="line"><span class="keyword">namespace</span> V1_0 &#123;</span><br><span class="line"><span class="keyword">namespace</span> implementation &#123;</span><br><span class="line"></span><br><span class="line">Mtcomp *Mtcomp::sInstance = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">Mtcomp::Mtcomp() &#123;</span><br><span class="line">    sInstance = <span class="keyword">this</span>; <span class="comment">// keep track of the most recent instance</span></span><br><span class="line">    mStoredCallback = <span class="literal">nullptr</span>;</span><br><span class="line">    mIsTerminating = <span class="literal">false</span>;</span><br><span class="line">    mThread = <span class="built_in">std</span>::thread(&amp;Mtcomp::cycleLoop, <span class="keyword">this</span>);</span><br><span class="line">    ALOGD(<span class="string">"Mtcomp()"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Mtcomp::~Mtcomp() &#123;</span><br><span class="line">    mIsTerminating = <span class="literal">true</span>;</span><br><span class="line">    ALOGD(<span class="string">"~Mtcomp()"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Methods from ::vendor::qti::hardware::mtcomp::V1_0::IMtcomp follow.</span></span><br><span class="line">Return&lt;<span class="keyword">void</span>&gt; Mtcomp::listSupportCmd(listSupportCmd_cb _hidl_cb) &#123;</span><br><span class="line">    <span class="comment">// TODO implement</span></span><br><span class="line">    ALOGD(<span class="string">"listSupportCmd()"</span>);</span><br><span class="line">    _hidl_cb(<span class="string">"listSupportCmd test"</span>);</span><br><span class="line">    <span class="keyword">return</span> Void();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Return&lt;<span class="keyword">void</span>&gt; Mtcomp::executeCmd(<span class="keyword">const</span> hidl_string&amp; cmd, executeCmd_cb _hidl_cb) &#123;</span><br><span class="line">    <span class="comment">// TODO implement</span></span><br><span class="line">    ALOGD(<span class="string">"executeCmd(): %s"</span>, cmd.c_str());</span><br><span class="line">    _hidl_cb(cmd);</span><br><span class="line">    <span class="keyword">return</span> Void();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Return&lt;<span class="keyword">void</span>&gt; Mtcomp::registerCallBack(<span class="keyword">const</span> sp&lt;::vendor::qti::hardware::mtcomp::V1_0::IMtcompCallback&gt;&amp; callback) &#123;</span><br><span class="line">    <span class="comment">// TODO implement</span></span><br><span class="line">    ALOGD(<span class="string">"%s"</span>, __func__);</span><br><span class="line">    <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lk(mCvMutex);</span><br><span class="line">    <span class="keyword">if</span>(callback == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"the incoming callback is null"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(mStoredCallback != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"call back has registered,we only have one store callback"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mStoredCallback = callback;</span><br><span class="line">        ALOGD(<span class="string">"registerCallBack:done"</span>);</span><br><span class="line">        mCv.notify_all();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Void();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Return&lt;<span class="keyword">void</span>&gt; Mtcomp::releaseCallBack(<span class="keyword">const</span> sp&lt;::vendor::qti::hardware::mtcomp::V1_0::IMtcompCallback&gt;&amp; callback) &#123;</span><br><span class="line">    <span class="comment">// TODO implement</span></span><br><span class="line">    ALOGD(<span class="string">"%s"</span>, __func__);</span><br><span class="line">    <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lk(mCvMutex);</span><br><span class="line">    mStoredCallback = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span>(callback == mStoredCallback) &#123;</span><br><span class="line">        ALOGD(<span class="string">"releaseCallBack:done"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Void();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Mtcomp::cycleLoop() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int32_t</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">"%s"</span>, __func__);</span><br><span class="line">    <span class="keyword">while</span> (!mIsTerminating) &#123;</span><br><span class="line">        <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lk(mCvMutex);</span><br><span class="line">        <span class="keyword">if</span> (mStoredCallback == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            mCv.wait(lk);</span><br><span class="line">        &#125;</span><br><span class="line">        ::<span class="built_in">memset</span>(buf, <span class="number">0x00</span>, <span class="number">100</span>);</span><br><span class="line">        ::<span class="built_in">snprintf</span>(buf, <span class="number">100</span>, <span class="string">"Call Back Timers: %d"</span>,count);</span><br><span class="line">        <span class="function">hidl_string <span class="title">result</span><span class="params">(buf)</span></span>;</span><br><span class="line">        mStoredCallback-&gt;onReport(result);</span><br><span class="line">        count ++;</span><br><span class="line">        lk.unlock();</span><br><span class="line">        ::sleep(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">IMtcomp* Mtcomp::getInstance() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sInstance) &#123;</span><br><span class="line">      sInstance = <span class="keyword">new</span> Mtcomp();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sInstance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Methods from ::android::hidl::base::V1_0::IBase follow.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//IMtcomp* HIDL_FETCH_IMtcomp(const char* /* name */) &#123;</span></span><br><span class="line">    <span class="comment">//return new Mtcomp();</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">&#125;  <span class="comment">// namespace implementation</span></span><br><span class="line">&#125;  <span class="comment">// namespace V1_0</span></span><br><span class="line">&#125;  <span class="comment">// namespace mtcomp</span></span><br><span class="line">&#125;  <span class="comment">// namespace hardware</span></span><br><span class="line">&#125;  <span class="comment">// namespace qti</span></span><br><span class="line">&#125;  <span class="comment">// namespace vendor</span></span><br></pre></td></tr></table></figure>

<h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><p>到这里，这个简单例子的代码基本完成，我们使用mmm vendor/qcom/proprietary/interfaces/mtcomp/1.0/编译，会生成这些目标文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">out/soong/.intermediates/vendor/qcom/proprietary/interfaces/mtcomp</span><br><span class="line">out/target/product/msm8937_64/vendor/lib64/vendor.qti.hardware.mtcomp@1.0-adapter-helper.so</span><br><span class="line">out/target/product/msm8937_64/vendor/lib64/hw/vendor.qti.hardware.mtcomp@1.0-impl.so</span><br><span class="line">out/target/product/msm8937_64/vendor/lib64/vendor.qti.hardware.mtcomp@1.0.so</span><br><span class="line">out/target/product/msm8937_64/vendor/lib/vendor.qti.hardware.mtcomp@1.0-adapter-helper.so</span><br><span class="line">out/target/product/msm8937_64/vendor/lib/hw/vendor.qti.hardware.mtcomp@1.0-impl.so</span><br><span class="line">out/target/product/msm8937_64/vendor/lib/vendor.qti.hardware.mtcomp@1.0.so</span><br><span class="line">out/target/product/msm8937_64/vendor/bin/hw/vendor.qti.hardware.mtcomp@1.0-service</span><br><span class="line">out/target/product/msm8937_64/vendor/etc/init/vendor.qti.hardware.mtcomp@1.0-service.rc</span><br></pre></td></tr></table></figure>

<p>添加相关目标到全局编译请求中：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add the related componts targets to the package request</span><br><span class="line">-&gt;vendor/qcom/proprietary/common/config/device-vendor.mk, add the follow info:</span><br><span class="line"><span class="comment">#huangzaiyang for study 20190202 start</span></span><br><span class="line">MT_COMP := vendor.qti.hardware.mtcomp@1.0</span><br><span class="line">MT_COMP += vendor.qti.hardware.mtcomp@1.0-service.rc</span><br><span class="line">MT_COMP += vendor.qti.hardware.mtcomp@1.0-impl</span><br><span class="line">MT_COMP += vendor.qti.hardware.mtcomp@1.0-service</span><br><span class="line">PRODUCT_PACKAGES += <span class="variable">$(MT_COMP)</span></span><br><span class="line"><span class="comment">#huangzaiyang for study 20190202 ended</span></span><br></pre></td></tr></table></figure>

<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>manifest添加接口信息配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">"device/qcom/msm8937_64/manifest.xml"</span><br><span class="line">   &lt;!-- huangzaiyang add IMtcomp 20190202 for study start --&gt; </span><br><span class="line">     &lt;hal format="hidl"&gt;</span><br><span class="line">         &lt;name&gt;vendor.qti.hardware.mtcomp&lt;/name&gt;</span><br><span class="line">         &lt;transport&gt;hwbinder&lt;/transport&gt;</span><br><span class="line">         &lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line">         &lt;interface&gt;</span><br><span class="line">             &lt;name&gt;IMtcomp&lt;/name&gt;</span><br><span class="line">             &lt;instance&gt;default&lt;/instance&gt;</span><br><span class="line">         &lt;/interface&gt;</span><br><span class="line">     &lt;/hal&gt;</span><br><span class="line">   &lt;!-- huangzaiyang add IMtcomp 20190202 for study end --&gt; </span><br><span class="line"></span><br><span class="line">"device/qcom/common/vendor_framework_compatibility_matrix.xml"</span><br><span class="line">   &lt;!-- huangzaiyang add IMtcomp 20190202 for study start --&gt; </span><br><span class="line">    &lt;hal format="hidl" optional="true"&gt;</span><br><span class="line">        &lt;name&gt;vendor.qti.hardware.mtcomp&lt;/name&gt;</span><br><span class="line">        &lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line">        &lt;interface&gt;</span><br><span class="line">            &lt;name&gt;IMtcomp&lt;/name&gt;</span><br><span class="line">            &lt;instance&gt;default&lt;/instance&gt;</span><br><span class="line">        &lt;/interface&gt;</span><br><span class="line">    &lt;/hal&gt;</span><br><span class="line">   &lt;!-- huangzaiyang add IMtcomp 20190202 for study end --&gt;</span><br></pre></td></tr></table></figure>

<p>selinux配置方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">"device/qcom/sepolicy/vendor/common/attributes"</span><br><span class="line"><span class="meta">#</span>huangzaiyang add IMtcomp 20190202 for study start</span><br><span class="line">attribute hal_mtcomp;</span><br><span class="line">attribute hal_mtcomp_client;</span><br><span class="line">attribute hal_mtcomp_server;</span><br><span class="line"><span class="meta">#</span>huangzaiyang add IMtcomp 20190202 for study end</span><br><span class="line"></span><br><span class="line">"device/qcom/sepolicy/vendor/common/file_contexts"</span><br><span class="line"><span class="meta">#</span>huangzaiyag add for study by 20190202 start</span><br><span class="line">/(vendor|system/vendor)/bin/hw/vendor\.qti\.hardware\.mtcomp@1\.0-service       u:object_r:hal_mtcomp_default_exec:s0</span><br><span class="line"><span class="meta">#</span>huangzaiyag add for study by 20190202 ended</span><br><span class="line"></span><br><span class="line">"device/qcom/sepolicy/vendor/common/hwservice.te"</span><br><span class="line"><span class="meta">#</span>huangzaiyang for study 20190202 start</span><br><span class="line">type hal_mtcomp_hwservice, hwservice_manager_type;</span><br><span class="line"><span class="meta">#</span>huangzaiyang for study 20190202 ended</span><br><span class="line"></span><br><span class="line">"device/qcom/sepolicy/vendor/common/hwservice_contexts"</span><br><span class="line"><span class="meta">#</span>huangzaiyang for study 20190202 start</span><br><span class="line">vendor.qti.hardware.mtcomp::IMtcomp                              u:object_r:hal_mtcomp_hwservice:s0</span><br><span class="line"><span class="meta">#</span>huangzaiyang for study 20190202 ended</span><br><span class="line"></span><br><span class="line">"add a new file : device/qcom/sepolicy/vendor/common/hal_mtcomp_default.te"</span><br><span class="line"><span class="meta">#</span> Copyright (c) 2017, The Linux Foundation. All rights reserved.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Redistribution and use in source and binary forms, with or without</span><br><span class="line"><span class="meta">#</span> modification, are permitted provided that the following conditions are</span><br><span class="line"><span class="meta">#</span> met:</span><br><span class="line"><span class="meta">#</span>    * Redistributions of source code must retain the above copyright</span><br><span class="line"><span class="meta">#</span>      notice, this list of conditions and the following disclaimer.</span><br><span class="line"><span class="meta">#</span>    * Redistributions in binary form must reproduce the above</span><br><span class="line"><span class="meta">#</span>      copyright notice, this list of conditions and the following</span><br><span class="line"><span class="meta">#</span>      disclaimer in the documentation and/or other materials provided</span><br><span class="line"><span class="meta">#</span>      with the distribution.</span><br><span class="line"><span class="meta">#</span>    * Neither the name of The Linux Foundation nor the names of its</span><br><span class="line"><span class="meta">#</span>      contributors may be used to endorse or promote products derived</span><br><span class="line"><span class="meta">#</span>      from this software without specific prior written permission.</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span> THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED</span><br><span class="line"><span class="meta">#</span> WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span><br><span class="line"><span class="meta">#</span> MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT</span><br><span class="line"><span class="meta">#</span> ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS</span><br><span class="line"><span class="meta">#</span> BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span><br><span class="line"><span class="meta">#</span> CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span><br><span class="line"><span class="meta">#</span> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span><br><span class="line"><span class="meta">#</span> BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,</span><br><span class="line"><span class="meta">#</span> WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE</span><br><span class="line"><span class="meta">#</span> OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN</span><br><span class="line"><span class="meta">#</span> IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span><br><span class="line"></span><br><span class="line">type hal_mtcomp_default, domain;</span><br><span class="line">hal_server_domain(hal_mtcomp_default, hal_mtcomp)</span><br><span class="line"></span><br><span class="line">type hal_mtcomp_default_exec, exec_type, vendor_file_type, file_type;</span><br><span class="line">init_daemon_domain(hal_mtcomp_default)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Allow hwbinder call from hal client to server</span><br><span class="line">binder_call(hal_mtcomp_client, hal_mtcomp_server)</span><br><span class="line">binder_call(hal_mtcomp_server, hal_mtcomp_client)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Add hwservice related rules</span><br><span class="line">add_hwservice(hal_mtcomp_server, hal_mtcomp_hwservice)</span><br><span class="line">allow hal_mtcomp_client hal_mtcomp_hwservice:hwservice_manager find;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Add permission for hal_mtcomp_default here</span><br><span class="line"><span class="meta">#</span>allow hal_mtcomp_default rtc_device:chr_file r_file_perms;</span><br></pre></td></tr></table></figure>

<h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4><p>重新编译整个工程，重新刷机。开机后做一些基本的检查,看看我们的服务是否正常的运行注册。不出意外的话，以下几点检查可以断定服务正常启动并且publish。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>check log:</span><br><span class="line">TB-XXXXX:/ # logcat -b all | grep mtcomp</span><br><span class="line">02-02 23:13:49.833     0     0 I init    : Parsing file /vendor/etc/init/vendor.qti.hardware.mtcomp@1.0-service.rc...</span><br><span class="line">02-02 23:14:00.824     0     0 I init    : starting service 'vendor.mtcomp-hal-1-0'...</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>check hal module：</span><br><span class="line">TB-XXXXX:/ # lshal | grep mtcomp</span><br><span class="line">  vendor.qti.hardware.mtcomp@1.0::IMtcomp/default                                           0/1        891    402</span><br><span class="line">  vendor.qti.hardware.mtcomp@1.0::I*/* (/vendor/lib/hw/)            N/A        N/A</span><br><span class="line">  vendor.qti.hardware.mtcomp@1.0::I*/* (/vendor/lib64/hw/)          N/A        N/A</span><br><span class="line"><span class="meta">#</span>check process</span><br><span class="line">TB-XXXXX:/ # ps -eZ | grep mtcomp</span><br><span class="line">u:r:hal_mtcomp_default:s0      system         891     1   14124   3788 binder_thread_read  0 S vendor.qti.hardware.mtcomp@1.0-service</span><br></pre></td></tr></table></figure>

<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><p>服务端实现完成了，我们需要写个简单的客户端程序测试一下才算完整。</p>
<h4 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h4><p>c++测试程序实现放在vendor/qcom/proprietary/interfaces/mtcomp/test/中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mtcomptest.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">"vendor.qti.hardware.mtcomp@1.0-service"</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vendor/qti/hardware/mtcomp/1.0/IMtcomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hidl/Status.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hidl/LegacySupport.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/misc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hidl/HidlSupport.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> vendor::qti::hardware::mtcomp::V1_0::IMtcomp;</span><br><span class="line"><span class="keyword">using</span> android::sp;</span><br><span class="line"><span class="keyword">using</span> android::hardware::hidl_string;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    android::sp&lt;IMtcomp&gt; service = IMtcomp::getService();</span><br><span class="line">    <span class="keyword">if</span>(service == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Failed to get service \n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    service-&gt;listSupportCmd([&amp;](hidl_string result) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s \n"</span>, result.c_str());</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    service-&gt;executeCmd(<span class="string">"test"</span>, [&amp;](hidl_string result) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s \n"</span>, result.c_str());</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Android.bp</span></span><br><span class="line"></span><br><span class="line">cc_binary &#123;</span><br><span class="line">    name: <span class="string">"mtcomptest"</span>,</span><br><span class="line">    defaults: [<span class="string">"hidl_defaults"</span>],</span><br><span class="line">    proprietary: true,</span><br><span class="line">    srcs: [<span class="string">"mtcomptest.cpp"</span>],</span><br><span class="line"> </span><br><span class="line">    shared_libs: [</span><br><span class="line">        <span class="string">"vendor.qti.hardware.mtcomp@1.0"</span>,</span><br><span class="line">        <span class="string">"libhidlbase"</span>,</span><br><span class="line">        <span class="string">"libhidltransport"</span>,</span><br><span class="line">        <span class="string">"liblog"</span>,</span><br><span class="line">        <span class="string">"libutils"</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行以下操作运行测试程序：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mmm vendor/qcom/proprietary/interfaces/mtcomp/test/</span><br><span class="line">adb push mtcomptest /system/bin/mtcomptest</span><br><span class="line">adb reboot </span><br><span class="line">adb shell</span><br><span class="line">mtcomptest</span><br></pre></td></tr></table></figure>

<h4 id="java"><a href="#java" class="headerlink" title="java"></a>java</h4><p>java客户端也要简单得实现并测试一下：</p>
<p>content_main.xml layout文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">"com.lct.update.MainActivity"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:showIn</span>=<span class="string">"@layout/app_bar_main"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/button_update"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"center_horizontal"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:visibility</span>=<span class="string">"visible"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:onClick</span>=<span class="string">"click_button"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fadeScrollbars</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:scrollbars</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/button_start"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"21dp"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/text_info"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"center_horizontal"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:visibility</span>=<span class="string">"visible"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/update_progess_tips"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"21dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>主界面activity MainActivity.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lct.mtcomptest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Handler;</span><br><span class="line"><span class="keyword">import</span> android.os.Looper;</span><br><span class="line"><span class="keyword">import</span> android.os.Message;</span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.app.AlertDialog;</span><br><span class="line"><span class="keyword">import</span> android.content.DialogInterface;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> vendor.qti.hardware.mtcomp.V1_0.IMtcomp;</span><br><span class="line"><span class="keyword">import</span> vendor.qti.hardware.mtcomp.V1_0.IMtcompCallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"LctHidlTest-mtcomp"</span>;</span><br><span class="line">    <span class="keyword">private</span> IMtcomp iMtService;</span><br><span class="line">    <span class="keyword">private</span> Button btn_ctrl;</span><br><span class="line">    <span class="keyword">private</span> TextView text_tips;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> times = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TimerCall timer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">click_button</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String ret = iMtService.executeCmd(<span class="string">"button click"</span> + times);</span><br><span class="line">            text_tips.setText(ret);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        times ++;</span><br><span class="line">        <span class="keyword">if</span> (times &gt; <span class="number">100</span>) times = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.content_main);</span><br><span class="line"></span><br><span class="line">        btn_ctrl = (Button)findViewById(R.id.button_update);</span><br><span class="line">        text_tips =  (TextView)findViewById(R.id.text_info);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            iMtService = IMtcomp.getService();</span><br><span class="line">            String ret = iMtService.executeCmd(<span class="string">"init status"</span>);</span><br><span class="line">            text_tips.setText(ret);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        timer = <span class="keyword">new</span> TimerCall();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">	Log.d(TAG,<span class="string">"onResume"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            iMtService.registerCallBack(timer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">	Log.d(TAG,<span class="string">"onPause"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            iMtService.releaseCallBack(timer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">super</span>.onDestroy();</span><br><span class="line">	Log.d(TAG,<span class="string">"onDestroy"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TimerCall</span> <span class="keyword">extends</span> <span class="title">IMtcompCallback</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReport</span><span class="params">(String report_buf)</span> </span>&#123;</span><br><span class="line">            Log.d(TAG,<span class="string">"TimerCall onReport :"</span> + report_buf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Android.mk：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright (C) 2016 The Android Open Source Project</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"></span><br><span class="line">LOCAL_PACKAGE_NAME := mtcomptest</span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line">LOCAL_PRIVATE_PLATFORM_APIS := true</span><br><span class="line"></span><br><span class="line"><span class="comment">#　这里引用由ｈｉｄｌ生成的ｊａｖａ静态库。我们前面的ｈｉｄｌ编译脚本有指定生成ｊａｖａ库的。</span></span><br><span class="line">LOCAL_STATIC_JAVA_LIBRARIES := vendor.qti.hardware.mtcomp-V1.0-java</span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES := \</span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> all-java-files-under, src)</span></span><br><span class="line"></span><br><span class="line">LOCAL_CERTIFICATE := platform</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_PACKAGE)</span></span><br></pre></td></tr></table></figure>

<p>编译完成后运行ａｐｐ会遇到以下问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">找不到服务对象：</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.693</span>  <span class="number">9196</span>  <span class="number">9196</span> E AndroidRuntime: Caused by: java.util.NoSuchElementException</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.693</span>  <span class="number">9196</span>  <span class="number">9196</span> E AndroidRuntime:        at android.os.HwBinder.getService(Native Method)</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.693</span>  <span class="number">9196</span>  <span class="number">9196</span> E AndroidRuntime:        at android.os.HwBinder.getService(HwBinder.java:<span class="number">91</span>)</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.693</span>  <span class="number">9196</span>  <span class="number">9196</span> E AndroidRuntime:        at vendor.qti.hardware.mtcomp.V1_0.IMtcomp.getService(IMtcomp.java:<span class="number">48</span>)</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.693</span>  <span class="number">9196</span>  <span class="number">9196</span> E AndroidRuntime:        at vendor.qti.hardware.mtcomp.V1_0.IMtcomp.getService(IMtcomp.java:<span class="number">52</span>)</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.693</span>  <span class="number">9196</span>  <span class="number">9196</span> E AndroidRuntime:        at com.lct.mtcomptest.MainActivity.onCreate(MainActivity.java:<span class="number">49</span>)</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.693</span>  <span class="number">9196</span>  <span class="number">9196</span> E AndroidRuntime:        at android.app.Activity.performCreate(Activity.java:<span class="number">7136</span>)</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.693</span>  <span class="number">9196</span>  <span class="number">9196</span> E AndroidRuntime:        at android.app.Activity.performCreate(Activity.java:<span class="number">7127</span>)</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.693</span>  <span class="number">9196</span>  <span class="number">9196</span> E AndroidRuntime:        at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:<span class="number">1272</span>)</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.693</span>  <span class="number">9196</span>  <span class="number">9196</span> E AndroidRuntime:        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:<span class="number">2894</span>)</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.693</span>  <span class="number">9196</span>  <span class="number">9196</span> E AndroidRuntime:        ... <span class="number">11</span> more</span><br><span class="line">ｓｅｌｉｎｕｘ问题：</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">15</span>:<span class="number">16.687</span>   <span class="number">402</span>   <span class="number">402</span> E SELinux : avc:  denied  &#123; find &#125; <span class="keyword">for</span> <span class="class"><span class="keyword">interface</span></span>=vendor.qti.hardware.mtcomp::IMtcomp pid=<span class="number">9196</span> scontext=u:r:system_app:s0 tcontext=u:object_r:hal_mtcomp_hwservice:s0 tclass=hwservice_manager permissive=<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>关闭ｓｅｌｉｎｕｘ重新测试，问题消失。可以看到ｓｅｌｉｎｕｘ放行的ｌｏｇ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">18</span>:<span class="number">34.333</span>   <span class="number">402</span>   <span class="number">402</span> E SELinux : avc:  denied  &#123; find &#125; <span class="keyword">for</span> <span class="class"><span class="keyword">interface</span></span>=vendor.qti.hardware.mtcomp::IMtcomp pid=<span class="number">9341</span> scontext=u:r:system_app:s0 tcontext=u:object_r:hal_mtcomp_hwservice:s0 tclass=hwservice_manager permissive=<span class="number">1</span></span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">18</span>:<span class="number">34.327</span>  <span class="number">9341</span>  <span class="number">9341</span> I .lct.mtcomptest: type=<span class="number">1400</span> audit(<span class="number">0.0</span>:<span class="number">121</span>): avc: denied &#123; call &#125; <span class="keyword">for</span> scontext=u:r:system_app:s0 tcontext=u:r:hal_mtcomp_default:s0 tclass=binder permissive=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>添加ｓｅｌｉｎｕｘ权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add below info at system_app.te:</span><br><span class="line"># allow system_app to interact with mtcomp hal</span><br><span class="line">hal_client_domain(system_app, hal_mtcomp);</span><br></pre></td></tr></table></figure>

<p>重新测试成功。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">TB-XXXXX:/ # lshal | grep mtcomp</span><br><span class="line">  vendor.qti.hardware.mtcomp@<span class="number">1.0</span>::IMtcomp/<span class="keyword">default</span>                                           <span class="number">0</span>/<span class="number">1</span>        <span class="number">832</span>    <span class="number">10348</span> <span class="number">402</span></span><br><span class="line">  vendor.qti.hardware.mtcomp@<span class="number">1.0</span>::I*<span class="comment">/* (/vendor/lib/hw/)            N/A        N/A</span></span><br><span class="line"><span class="comment">  vendor.qti.hardware.mtcomp@1.0::I*/</span>* (/vendor/lib64/hw/)          N/A        N/A</span><br><span class="line">TB-XXXXX:/ # ps -e | grep 10348</span><br><span class="line">system       <span class="number">10348</span>   <span class="number">435</span> <span class="number">3714128</span>  <span class="number">99364</span> SyS_epoll_wait      <span class="number">0</span> S com.lct.mtcomptest</span><br><span class="line"></span><br><span class="line">check hal mtcomp log :</span><br><span class="line">按钮调用服务ａｐｉ：</span><br><span class="line">TB-XXXXX:/ # logcat | grep " 832 "</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">43</span>:<span class="number">42.927</span>   <span class="number">832</span>   <span class="number">832</span> D vendor.qti.hardware.mtcomp@<span class="number">1.0</span>-service: executeCmd(): button click6</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">43</span>:<span class="number">45.210</span>   <span class="number">832</span>   <span class="number">832</span> D vendor.qti.hardware.mtcomp@<span class="number">1.0</span>-service: executeCmd(): button click7</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">43</span>:<span class="number">45.899</span>   <span class="number">832</span>   <span class="number">832</span> D vendor.qti.hardware.mtcomp@<span class="number">1.0</span>-service: executeCmd(): button click8</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">43</span>:<span class="number">46.516</span>   <span class="number">832</span>   <span class="number">832</span> D vendor.qti.hardware.mtcomp@<span class="number">1.0</span>-service: executeCmd(): button click9</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">43</span>:<span class="number">46.995</span>   <span class="number">832</span>   <span class="number">832</span> D vendor.qti.hardware.mtcomp@<span class="number">1.0</span>-service: executeCmd(): button click10</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">01</span>:<span class="number">43</span>:<span class="number">47.449</span>   <span class="number">832</span>   <span class="number">832</span> D vendor.qti.hardware.mtcomp@<span class="number">1.0</span>-service: executeCmd(): button click11</span><br><span class="line">服务回调ａｐｐ：</span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">29</span>:<span class="number">12.359</span>  <span class="number">8999</span>  <span class="number">9014</span> D LctHidlTest-mtcomp: TimerCall onReport :Call Back Timers: <span class="number">231</span></span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">29</span>:<span class="number">17.361</span>  <span class="number">8999</span>  <span class="number">9014</span> D LctHidlTest-mtcomp: TimerCall onReport :Call Back Timers: <span class="number">232</span></span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">29</span>:<span class="number">22.362</span>  <span class="number">8999</span>  <span class="number">9014</span> D LctHidlTest-mtcomp: TimerCall onReport :Call Back Timers: <span class="number">233</span></span><br><span class="line"><span class="number">02</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">29</span>:<span class="number">27.363</span>  <span class="number">8999</span>  <span class="number">9014</span> D LctHidlTest-mtcomp: TimerCall onReport :Call Back Timers: <span class="number">234</span></span><br></pre></td></tr></table></figure>

<h2 id="HIDL版本管理"><a href="#HIDL版本管理" class="headerlink" title="HIDL版本管理"></a>HIDL版本管理</h2><p>待续．．．．．</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://source.android.com/devices/architecture" target="_blank" rel="noopener">https://source.android.com/devices/architecture</a><br><a href="http://devarea.com/android-hidl-and-project-treble/#.XGIehi5ua02" target="_blank" rel="noopener">http://devarea.com/android-hidl-and-project-treble/#.XGIehi5ua02</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/06/01/Android-hidl-sample-impletment/" data-id="cjy7ayu6r001qeoiibf46g0q4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HIDL/">HIDL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/学习/">学习</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/8/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/10/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AIDL/">AIDL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HIDL/">HIDL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/driver/">driver</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习/">学习</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/实战/">实战</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/稳定性/">稳定性</a><span class="tag-list-count">8</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AIDL/" style="font-size: 10px;">AIDL</a> <a href="/tags/Android/" style="font-size: 16.67px;">Android</a> <a href="/tags/HIDL/" style="font-size: 10px;">HIDL</a> <a href="/tags/Linux/" style="font-size: 16.67px;">Linux</a> <a href="/tags/driver/" style="font-size: 10px;">driver</a> <a href="/tags/学习/" style="font-size: 20px;">学习</a> <a href="/tags/实战/" style="font-size: 13.33px;">实战</a> <a href="/tags/稳定性/" style="font-size: 13.33px;">稳定性</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/08/01/Arm-linux-exception-flows/">Linux-ARMv8异常相关知识</a>
          </li>
        
          <li>
            <a href="/2019/07/20/Android-gdb-extract-logs/">Android9.0 logd进程空间提取日志信息</a>
          </li>
        
          <li>
            <a href="/2019/07/15/Android-booting-time-spent/">Android开机时间分析</a>
          </li>
        
          <li>
            <a href="/2019/07/10/a-intentresolver-cts-issue/">关于IntentResolver的一个cts问题</a>
          </li>
        
          <li>
            <a href="/2019/07/05/native-acess-javaservice-with-binder/">Android平台上native代码访问PackageManagerService</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 JoyYoung<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>